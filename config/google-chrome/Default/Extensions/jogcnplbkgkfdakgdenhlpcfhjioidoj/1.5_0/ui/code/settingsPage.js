/*! For license information please see settingsPage.js.LICENSE.txt */
(()=>{var e={"./src/core/ProfileOperations.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProfileOperations:()=>c});var i=r("./src/lib/Debug.ts"),s=r("./src/lib/environment.ts"),n=r("./src/lib/Utils.ts"),o=r("./src/core/definitions.ts"),a=r("./src/core/ProxyRules.ts"),l=r("./src/core/Settings.ts"),u=r("./src/core/SettingsOperation.ts");class c{static addUpdateProfile(e,t){if(t??=l.Settings.current,e.profileId){let r=c.findSmartProfileById(e.profileId,t.proxyProfiles);if(r)return void Object.assign(r,e)}c.ensureProfileId(e),t.proxyProfiles.push(e)}static ensureProfileId(e){e.profileId||(e.profileId="profile-"+n.Utils.getNewUniqueIdString())}static deleteProfile(e){let t=new o.ResultHolder,r=l.Settings.current,n=c.findSmartProfileIndexById(e,r.proxyProfiles);return-1==n?(i.Debug.warn(`deleteProfile failed for profile id = ${e}`),t.success=!1,t.message=s.api.i18n.getMessage("settingsProfilesDeleteFailed"),t):r.proxyProfiles[n].profileTypeConfig.builtin?(t.success=!1,t.message=s.api.i18n.getMessage("settingsProfilesDeleteBuiltinFail"),t):(r.proxyProfiles.splice(n,1),t.success=!0,t)}static profileTypeSupportsRules(e){switch(e){case o.SmartProfileType.SmartRules:case o.SmartProfileType.AlwaysEnabledBypassRules:case o.SmartProfileType.IgnoreFailureRules:return!0;case o.SmartProfileType.Direct:case o.SmartProfileType.SystemProxy:default:return!1}}static profileTypeSupportsSubscriptions(e){switch(e){case o.SmartProfileType.SmartRules:case o.SmartProfileType.AlwaysEnabledBypassRules:return!0;case o.SmartProfileType.IgnoreFailureRules:case o.SmartProfileType.Direct:case o.SmartProfileType.SystemProxy:default:return!1}}static getActiveSmartProfile(){let e=l.Settings.current,t=c.findSmartProfileById(e.activeProfileId,e.proxyProfiles);return null==t?(i.Debug.warn("No active profile found"),null):t}static getIgnoreFailureRulesProfile(){let e=l.Settings.current,t=c.findFirstSmartProfileType(o.SmartProfileType.IgnoreFailureRules,e.proxyProfiles);return null==t&&(t=new o.SmartProfile,t.profileType=o.SmartProfileType.IgnoreFailureRules,t.profileTypeConfig=(0,o.getSmartProfileTypeConfig)(o.SmartProfileType.IgnoreFailureRules),t.profileName="Ignore Failure Rules",c.addUpdateProfile(t)),t}static findFirstSmartProfileType(e,t){return t.find((t=>t.profileType===e))}static findSmartProfileById(e,t){return t.find((t=>t.profileId===e))}static findSmartProfileIndexById(e,t){return t.findIndex((t=>t.profileId===e))}static compileSmartProfile(e){let t=new o.SmartProfileCompiled;return c.copySmartProfileBase(e,t),c.compileSmartProfileRuleInternal(e,t),t.profileProxyServerId&&(t.profileProxyServer=u.SettingsOperation.findProxyServerById(t.profileProxyServerId)),t}static compileSmartProfileRuleInternal(e,t){if(t.compiledRules=new o.CompiledProxyRulesInfo,e.proxyRules&&e.proxyRules.length){let r=a.ProxyRules.compileRules(e,e.proxyRules);t.compiledRules.Rules=r?.compiledList??[],t.compiledRules.WhitelistRules=r?.compiledWhiteList??[]}else t.compiledRules.Rules=[],t.compiledRules.WhitelistRules=[];if(e.rulesSubscriptions&&e.rulesSubscriptions.length>0){let r=[],i=[];for(const t of e.rulesSubscriptions)if(t.enabled){if(t.proxyRules&&t.proxyRules.length>0){let e=a.ProxyRules.compileRulesSubscription(t.proxyRules);e&&(r=r.concat(e))}if(t.whitelistRules&&t.whitelistRules.length>0){let e=a.ProxyRules.compileRulesSubscription(t.whitelistRules,!0);e&&(i=i.concat(e))}}t.compiledRules.SubscriptionRules=r,t.compiledRules.WhitelistSubscriptionRules=i}}static getSmartProfileBaseList(e){let t=[];for(const r of e){let e=new o.SmartProfileBase;c.copySmartProfileBase(r,e),t.push(e)}return t}static getSmartProfileBase(e){let t=new o.SmartProfileBase;return c.copySmartProfileBase(e,t),t}static copySmartProfileBase(e,t,r=!0){t.profileType=e.profileType,t.profileId=e.profileId,t.profileName=e.profileName,t.enabled=e.enabled,t.profileProxyServerId=e.profileProxyServerId,r&&(t.profileTypeConfig={builtin:e.profileTypeConfig.builtin,editable:e.profileTypeConfig.editable,selectable:e.profileTypeConfig.selectable,supportsSubscriptions:e.profileTypeConfig.supportsSubscriptions,supportsProfileProxy:e.profileTypeConfig.supportsProfileProxy,customProxyPerRule:e.profileTypeConfig.customProxyPerRule,canBeDisabled:e.profileTypeConfig.canBeDisabled,supportsRuleActionWhitelist:e.profileTypeConfig.supportsRuleActionWhitelist,defaultRuleActionIsWhitelist:e.profileTypeConfig.defaultRuleActionIsWhitelist})}static copySmartProfile(e,t,r=!0){c.copySmartProfileBase(e,t,r);let i=[];if(e.proxyRules)for(const t of e.proxyRules){let e=new o.ProxyRule;e.CopyFrom(t),e.isValid()&&i.push(e)}t.proxyRules=i;let s=[];if(e.rulesSubscriptions)for(const t of e.rulesSubscriptions){let e=new o.ProxyRulesSubscription;e.CopyFrom(t),e.isValid()&&s.push(e)}t.rulesSubscriptions=s}static resetProfileTypeConfig(e){let t=(0,o.getSmartProfileTypeConfig)(e.profileType);t&&(e.profileTypeConfig=t)}}},"./src/core/ProxyEngine.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProxyEngine:()=>l});var i=r("./src/core/ProxyEngineFirefox.ts"),s=r("./src/lib/environment.ts"),n=r("./src/core/ProxyEngineChrome.ts"),o=r("./src/core/Settings.ts"),a=r("./src/lib/Debug.ts");class l{static configureEnginePrematurely(){s.environment.chrome||(a.DiagDebug?.trace("ProxyEngine.configureEnginePrematurely."),i.ProxyEngineFirefox.register())}static registerEngine(){a.DiagDebug?.trace("ProxyEngine.registerEngine"),s.environment.chrome||i.ProxyEngineFirefox.register(),o.Settings.updateActiveSettings(),this.updateBrowsersProxyConfig()}static updateBrowsersProxyConfig(){this.updateFirefoxProxyConfig(),this.updateChromeProxyConfig()}static notifyProxyRulesChanged(){o.Settings.updateActiveSettings(),this.updateBrowsersProxyConfig()}static updateChromeProxyConfig(){s.environment.chrome&&n.ProxyEngineChrome.updateChromeProxyConfig()}static updateFirefoxProxyConfig(){s.environment.chrome||i.ProxyEngineFirefox.updateFirefoxProxyConfig()}}},"./src/core/ProxyEngineChrome.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProxyEngineChrome:()=>a});var i=r("./src/core/definitions.ts"),s=r("./src/lib/environment.ts"),n=r("./src/lib/Debug.ts"),o=r("./src/core/Settings.ts");class a{static updateChromeProxyConfig(){let e=o.Settings.active;if(e.activeProfile.profileType==i.SmartProfileType.SystemProxy){let e={mode:"system"};return void s.api.proxy.settings.set({value:e,scope:"regular"},(function(){s.api.runtime.lastError&&n.Debug.error("updateChromeProxyConfig failed with ",s.api.runtime.lastError)}))}if(e.activeProfile.profileType==i.SmartProfileType.Direct){let e={mode:"direct"};return void s.api.proxy.settings.set({value:e,scope:"regular"},(function(){s.api.runtime.lastError&&n.Debug.error("updateChromeProxyConfig failed with ",s.api.runtime.lastError)}))}let t={mode:"pac_script",pacScript:{data:this.generateChromePacScript()}};s.api.proxy.settings.set({value:t,scope:"regular"},(function(){s.api.runtime.lastError&&n.Debug.error("updateChromeProxyConfig failed with ",s.api.runtime.lastError)}))}static generateChromePacScript(){let e=o.Settings.active,t=e.activeProfile.profileType,r=this.convertActiveProxyServer(e.currentProxyServer),s=e.activeProfile.compiledRules;return`\nconst compiledRules = {\n\t/** User defined whitelist rules. P2 */\n\tWhitelistRules: [${this.regexHostArrayToString(s.WhitelistRules).join(",")}],\n\t/** User defined rules. P1 */\n\tRules: [${this.regexHostArrayToString(s.Rules).join(",")}],\n\t/** Subscription whitelist rules. P3  */\n\tWhitelistSubscriptionRules: [${this.regexHostArrayToString(s.WhitelistSubscriptionRules).join(",")}],\n\t/** Subscription rules. P4 */\n\tSubscriptionRules: [${this.regexHostArrayToString(s.SubscriptionRules).join(",")}]\n};\nconst SmartProfileType = {\n\tDirect: ${i.SmartProfileType.Direct},\n\tSystemProxy: ${i.SmartProfileType.SystemProxy},\n\tSmartRules: ${i.SmartProfileType.SmartRules},\n\tAlwaysEnabledBypassRules: ${i.SmartProfileType.AlwaysEnabledBypassRules},\n\tIgnoreFailureRules: ${i.SmartProfileType.IgnoreFailureRules},\n}\nconst CompiledProxyRuleType = {\n\tRegexHost: ${i.CompiledProxyRuleType.RegexHost},\n\tRegexUrl: ${i.CompiledProxyRuleType.RegexUrl},\n\tExact: ${i.CompiledProxyRuleType.Exact},\n\tSearchUrl: ${i.CompiledProxyRuleType.SearchUrl},\n\tSearchDomain: ${i.CompiledProxyRuleType.SearchDomain},\n\tSearchDomainSubdomain: ${i.CompiledProxyRuleType.SearchDomainSubdomain},\n\tSearchDomainAndPath: ${i.CompiledProxyRuleType.SearchDomainAndPath},\n\tSearchDomainSubdomainAndPath: ${i.CompiledProxyRuleType.SearchDomainSubdomainAndPath}\n}\nconst activeProfileType = +'${t}';\nconst currentProxyServer = "${r}";\nconst resultDirect = "DIRECT";\nconst resultSystem = "SYSTEM";\nconst verboseDiagnostics = ${1==n.DiagDebug?.enabled}; // set to true for verbose logs using chrome flag. https://support.google.com/chrome/a/answer/6271171?hl=en#zippy=%2Cview-network-data%2Cget-network-logs\n// -------------------------\n// required PAC function that will be called to determine\n// if a proxy should be used.\nfunction FindProxyForURL(url, host, noDiagnostics) {\n\tif (verboseDiagnostics && !noDiagnostics) {\n\t\tlet finalResult = FindProxyForURL(url, host, true);\n\t\talert('SmartProxy-FindProxyForURL-Result=' + finalResult + '; host=' + host + '; url=' + url + '; activeProfile=' + activeProfileType);\n\t\treturn finalResult;\n\t}\n\n\tif (activeProfileType == SmartProfileType.SystemProxy)\n\t\treturn resultSystem;\n\n\tif (activeProfileType == SmartProfileType.Direct)\n\t\treturn resultDirect;\n\n\thost = host?.toLowerCase();\n\n\t// applying ProxyPerOrigin\n\t// is not applicable for Chromium\n\n\t// correcting 'host' because it doesn't include port number\n\tconst hostAndPort = extractHostFromUrl(url)?.toLowerCase() || host;\n\n\tif (activeProfileType == SmartProfileType.AlwaysEnabledBypassRules) {\n\n\t\t// user skip the bypass rules/ don't apply proxy\n\t\tlet userMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.Rules);\n\t\tif (userMatchedRule) {\n\t\t\treturn makeResultForAlwaysEnabledForced(userMatchedRule)\n\t\t}\n\n\t\t// user bypass rules/ apply proxy by force\n\t\tlet userWhitelistMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.WhitelistRules)\n\t\tif (userWhitelistMatchedRule) {\n\t\t\treturn resultDirect;\n\t\t}\n\n\t\t// subscription skip bypass rules/ don't apply proxy\n\t\tlet subMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.SubscriptionRules);\n\t\tif (subMatchedRule) {\n\t\t\treturn makeResultForAlwaysEnabledForced(userMatchedRule)\n\t\t}\n\n\t\t// subscription bypass rules/ apply proxy by force\n\t\tlet subWhitelistMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.WhitelistSubscriptionRules)\n\t\tif (subWhitelistMatchedRule) {\n\t\t\treturn resultDirect;\n\t\t}\n\n\t\t//** Always Enabled is forced by a rule, so other rules can't skip it */\n\t\tfunction makeResultForAlwaysEnabledForced(matchedRule) {\n\n\t\t\tif (matchedRule.proxy)\n\t\t\t\t// this rule has its own proxy setup\n\t\t\t\treturn matchedRule.proxy;\n\t\t\treturn currentProxyServer;\n\t\t}\n\n\t\t// no rule is matched, going with proxy\n\t\treturn currentProxyServer;\n\t}\n\n\tif (activeProfileType == SmartProfileType.SmartRules) {\n\n\t\t// user whitelist rules/ don't apply proxy\n\t\tlet userWhitelistMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.WhitelistRules)\n\t\tif (userWhitelistMatchedRule) {\n\t\t\treturn makeResultForWhitelistRule(userWhitelistMatchedRule);\n\t\t}\n\n\t\t// user rules/ apply proxy\n\t\tlet userMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.Rules);\n\t\tif (userMatchedRule) {\n\t\t\treturn makeResultForMatchedRule(userMatchedRule);\n\t\t}\n\n\t\t// subscription whitelist rules/ don't apply proxy\n\t\tlet subWhitelistMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.WhitelistSubscriptionRules)\n\t\tif (subWhitelistMatchedRule) {\n\t\t\treturn makeResultForWhitelistRule(subWhitelistMatchedRule);\n\t\t}\n\n\t\t// subscription rules/ apply proxy\n\t\tlet subMatchedRule = findMatchedUrlInRules(url, host, hostAndPort, compiledRules.SubscriptionRules);\n\t\tif (subMatchedRule) {\n\t\t\treturn makeResultForMatchedRule(subMatchedRule);\n\t\t}\n\n\t\t/**\n\t\t * Generate result for matched whitelist rule\n\t\t */\n\t\tconst makeResultForWhitelistRule = () => {\n\t\t\treturn resultDirect;\n\t\t}\n\n\t\t/**\n\t\t * Generate result for matched proxy rule\n\t\t */\n\t\tfunction makeResultForMatchedRule(matchedRule) {\n\t\t\tif (matchedRule.proxy)\n\t\t\t\t// this rule has its own proxy setup\n\t\t\t\treturn matchedRule.proxy;\n\t\t\treturn currentProxyServer;\n\t\t}\n\t}\n\n\tif (activeProfileType == SmartProfileType.IgnoreFailureRules) {\n\t\t// NOTE: this is not a proxy profile, it is used elsewhere\n\t\t// No logic is needed here\n\t}\n\n\t// let the browser decide\n\treturn "";\n}\n\nfunction findMatchedUrlInRules(searchUrl, host, hostAndPort, rules) {\n\tif (searchUrl == null || rules == null || rules.length == 0)\n\t\treturn null;\n\n\tlet schemaLessUrlLowerCase = null;\n\tlet lowerCaseUrl = searchUrl.toLowerCase();\n\n\ttry {\n\t\tfor (let rule of rules) {\n\n\t\t\tswitch (rule.compiledRuleType) {\n\t\t\t\tcase CompiledProxyRuleType.SearchDomainSubdomain:\n\n\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\t// domain\n\t\t\t\t\tif (host == rule.search)\n\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\t// subdomains\n\t\t\t\t\tif (host.endsWith('.' + rule.search))\n\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.Exact:\n\n\t\t\t\t\tif (lowerCaseUrl == rule.search)\n\t\t\t\t\t\treturn rule;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.RegexHost:\n\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (rule.regex.test(host))\n\t\t\t\t\t\treturn rule;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.RegexUrl:\n\t\t\t\t\t// Using original url with case sensitivity\n\t\t\t\t\tif (rule.regex.test(searchUrl))\n\t\t\t\t\t\treturn rule;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.SearchUrl:\n\n\t\t\t\t\tif (lowerCaseUrl.startsWith(rule.search))\n\t\t\t\t\t\treturn rule;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.SearchDomain:\n\n\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tif (rule.search == host)\n\t\t\t\t\t\treturn rule;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.SearchDomainAndPath:\n\n\t\t\t\t\tif (schemaLessUrlLowerCase == null) {\n\t\t\t\t\t\tschemaLessUrlLowerCase = removeSchemaFromUrl(lowerCaseUrl);\n\t\t\t\t\t\tif (schemaLessUrlLowerCase == null) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (schemaLessUrlLowerCase.startsWith(rule.search))\n\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CompiledProxyRuleType.SearchDomainSubdomainAndPath:\n\t\t\t\t\t{\n\t\t\t\t\t\tif (schemaLessUrlLowerCase == null) {\n\t\t\t\t\t\t\tschemaLessUrlLowerCase = removeSchemaFromUrl(lowerCaseUrl);\n\t\t\t\t\t\t\tif (schemaLessUrlLowerCase == null) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (schemaLessUrlLowerCase.startsWith(rule.search))\n\t\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\t\tlet ruleSearchHost = extractHostFromInvalidUrl(rule.search);\n\t\t\t\t\t\tif (ruleSearchHost != null) {\n\n\t\t\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// should be the same\n\t\t\t\t\t\t\tif (ruleSearchHost != host && !host.endsWith('.' + ruleSearchHost))\n\t\t\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\t\t\t// after this state, we are sure that the url is for the same domain, now just checking the path\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// subdomains\n\t\t\t\t\t\tif (schemaLessUrlLowerCase.includes('.' + rule.search))\n\t\t\t\t\t\t\treturn rule;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// reaching this point nothing is matched\n\t\t// if host has custom port number we need to check again\n\t\tif (host != hostAndPort) {\n\t\t\thost = hostAndPort;\n\t\t\t\n\t\t\tfor (let rule of rules) {\n\n\t\t\t\t// NOTE: Only rules that work on hostName should be checked, others can be ignored\n\t\t\t\tswitch (rule.compiledRuleType) {\n\n\t\t\t\t\tcase CompiledProxyRuleType.RegexHost:\n\t\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (rule.regex.test(host))\n\t\t\t\t\t\t\treturn rule;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase CompiledProxyRuleType.SearchDomain:\n\n\t\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (rule.search == host)\n\t\t\t\t\t\t\treturn rule;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase CompiledProxyRuleType.SearchDomainSubdomain:\n\n\t\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// domain\n\t\t\t\t\t\tif (host == rule.search)\n\t\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\t\t// subdomains\n\t\t\t\t\t\tif (host.endsWith('.' + rule.search))\n\t\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase CompiledProxyRuleType.SearchDomainSubdomainAndPath:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (schemaLessUrlLowerCase == null) {\n\t\t\t\t\t\t\t\tschemaLessUrlLowerCase = removeSchemaFromUrl(lowerCaseUrl);\n\t\t\t\t\t\t\t\tif (schemaLessUrlLowerCase == null) {\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (schemaLessUrlLowerCase.startsWith(rule.search))\n\t\t\t\t\t\t\t\treturn rule;\n\n\t\t\t\t\t\t\tlet ruleSearchHost = extractHostFromInvalidUrl(rule.search);\n\t\t\t\t\t\t\tif (ruleSearchHost != null) {\n\n\t\t\t\t\t\t\t\tif (host == null) {\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// should be the same\n\t\t\t\t\t\t\t\tif (ruleSearchHost != host && !host.endsWith('.' + ruleSearchHost))\n\t\t\t\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\t\t\t\t// after this state, we are sure that the url is for the same domain, now just checking the path\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// subdomains\n\t\t\t\t\t\t\tif (schemaLessUrlLowerCase.includes('.' + rule.search))\n\t\t\t\t\t\t\t\treturn rule;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\tcase CompiledProxyRuleType.Exact:\n\t\t\t\t\tcase CompiledProxyRuleType.RegexUrl:\n\t\t\t\t\tcase CompiledProxyRuleType.SearchUrl:\n\t\t\t\t\tcase CompiledProxyRuleType.SearchDomainAndPath:\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t} catch (e) {\n\t\tconsole.warn('SmartProxy> findMatchForUrl failed for ' + lowerCaseUrl, e);\n\t}\n\treturn null;\n}\n\nfunction removeSchemaFromUrl(url) {\n\tif (url == null)\n\t\treturn url;\n\tconst schemaSep = '://';\n\tlet index = url.indexOf(schemaSep);\n\tif (index > -1)\n\t\treturn url.substring(index + schemaSep.length, url.length);\n\telse\n\t\treturn url;\n}\nfunction extractHostFromInvalidUrl(url) {\n\ttry {\n\t\tif (!url.includes(":/"))\n\t\t\turl = 'http://' + url;\n\n\t\treturn extractHostFromUrl(url);\n\t}\n\tcatch (e) { return null; }\n}\nfunction extractHostFromUrl(url) {\n\t// Unescaped RegEx (/^(?:w)*://([^/?#]+)(?:[/?#]|$)/i);\n\tconst extractPattern = (/^(?:\\w)*\\:\\/\\/([^\\/?#]+)(?:[\\/?#]|$)/i);\n\n\tconst match = extractPattern.exec(url);\n\tif (!match) {\n\t\treturn null;\n\t}\n\tconst [, host] = match;\n\treturn host;\n}`}static convertActiveProxyServer(e){const t="DIRECT";if(!(e&&e.host&&e.protocol&&e.port))return t;switch(e.protocol){case"HTTP":return`PROXY ${e.host}:${e.port}`;case"HTTPS":return`HTTPS ${e.host}:${e.port}`;case"SOCKS4":return`SOCKS4 ${e.host}:${e.port}`;case"SOCKS5":return`SOCKS5 ${e.host}:${e.port}`}return t}static regexHostArrayToString(e){let t=[];for(let r=0;r<e.length;r++){let i,s=e[r];i=s.search?`unescape('${escape(s.search)}')`:"null",s.proxy?t.push(`{search:${i},regex:${s.regex?.toString()||"null"},compiledRuleType:${s.compiledRuleType},proxy:"${this.convertActiveProxyServer(s.proxy)}"}`):t.push(`{search:${i},regex:${s.regex?.toString()||"null"},compiledRuleType:${s.compiledRuleType}}`)}return t}}},"./src/core/ProxyEngineFirefox.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProxyEngineFirefox:()=>m});var i=r("./src/lib/environment.ts"),s=r("./src/lib/Debug.ts"),n=r("./src/core/definitions.ts"),o=r("./src/core/ProxyRules.ts"),a=r("./src/core/TabManager.ts"),l=r("./src/lib/PolyFill.ts"),u=r("./src/core/Settings.ts"),c=r("./src/core/ProxyEngineSpecialRequests.ts"),d=r("./src/core/TabRequestLogger.ts");const p=i.api;class m{static register(){return!(!p.proxy||!p.proxy.onRequest||(p.proxy.onRequest.addListener(m.handleProxyRequest,{urls:["*://*/*","ws://*/*","wss://*/*","ftp://*/*"]}),p.proxy.onError.addListener(m.onProxyError),0))}static updateFirefoxProxyConfig(){if(i.environment.notAllowed.setProxySettings)return;let e=u.Settings.active,t={proxyType:n.BrowserProxySettingsType.system};switch(s.DiagDebug?.trace("Core.updateFirefoxProxyConfig","proxyType="+n.BrowserProxySettingsType[t.proxyType]),e.activeProfile.profileType){case n.SmartProfileType.Direct:case n.SmartProfileType.SmartRules:case n.SmartProfileType.AlwaysEnabledBypassRules:case n.SmartProfileType.IgnoreFailureRules:t.proxyType=n.BrowserProxySettingsType.none;break;case n.SmartProfileType.SystemProxy:t.proxyType=n.BrowserProxySettingsType.system}l.PolyFill.browserSetProxySettings({value:t},(function(){i.environment.notSupported.setProxySettings=!1,i.environment.notAllowed.setProxySettings=!1}),(function(e){s.Debug.error("updateFirefoxProxyConfig failed to set proxy settings",t,e?.message),e&&e.message&&(e.message.includes("not supported")&&(i.environment.notSupported.setProxySettings=!0),e.message.includes("permission")&&(i.environment.notAllowed.setProxySettings=!0))}))}static waitForSettingsToHandleProxyRequest(e,t){u.Settings.addInitializeCompletedEventListener((function r(){u.Settings.removeInitializeCompletedEventListener(r);let i=m.handleProxyRequest(e);return s.DiagDebug?.trace("Settings are loaded now, result=",i,"t="+e.tabId,e.url),void t(i)}))}static handleProxyRequest(e){if(!u.Settings.active)return s.DiagDebug?.warn("Settings are not loaded yet, waiting...","t="+e.tabId,e.url),new Promise((t=>m.waitForSettingsToHandleProxyRequest(e,t)));let t=new n.ProxyableLogDataType;t.tabId=e.tabId,t.url=e.url,t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.NoneMatched,t.proxifiedStatus=n.ProxyableProxifiedStatus.NoProxy;let r=u.Settings.current,i=u.Settings.active,l=i.currentProxyServer,p=null,f=i.activeProfile,h=f.profileType,g=(()=>{if(!e.url)return{type:"direct"};let u=c.ProxyEngineSpecialRequests.retrieveSpecialUrlMode(e.url,!0);if(null!==u){if(t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.Special,t.proxifiedStatus=n.ProxyableProxifiedStatus.NoProxy,u.applyMode==n.SpecialRequestApplyProxyMode.NoProxy)return{type:"direct"};if(u.applyMode==n.SpecialRequestApplyProxyMode.CurrentProxy)return l?(t.proxifiedStatus=n.ProxyableProxifiedStatus.Special,m.getResultProxyInfo(l)):{type:"direct"};if(u.applyMode==n.SpecialRequestApplyProxyMode.SelectedProxy&&u.selectedProxy)return t.proxifiedStatus=n.ProxyableProxifiedStatus.Special,m.getResultProxyInfo(u.selectedProxy)}if(e.tabId>-1&&(p=a.TabManager.getTab(e.tabId),null!=p&&p.incognito&&null!=i.activeIncognitoProfile)){const d=i.activeIncognitoProfile;f=d,h=d.profileType}if(h===n.SmartProfileType.Direct||!l)return{type:"direct"};if(h===n.SmartProfileType.SystemProxy)return t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.NoneMatched,t.proxifiedStatus=n.ProxyableProxifiedStatus.SystemProxyApplied,{type:"direct"};if(l||s.DiagDebug?.trace("FF.handleProxyRequest.currentProxyServer is null","t="+t.tabId,t.url,n.SmartProfileType[i.activeProfile?.profileType]),null!=p&&r.options.proxyPerOrigin&&null!=p&&p.proxified===n.TabProxyStatus.Proxified){if(e.documentUrl)return t.ruleHostName=p.proxyRuleHostName,p.proxyMatchedRule&&(t.ruleSource=n.CompiledProxyRuleSource.Rules,t.applyFromRule(p.proxyMatchedRule)),p.proxyServerFromRule&&(p.proxyServerFromRule.username&&c.ProxyEngineSpecialRequests.setSpecialUrl(`${p.proxyServerFromRule.host}:${p.proxyServerFromRule.port}`,null,p.proxyServerFromRule),l=p.proxyServerFromRule),t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.ProxyPerOrigin,t.proxifiedStatus=n.ProxyableProxifiedStatus.ProxyPerOrigin,s.DiagDebug?.trace("FF.handleProxyRequest <ProxyPerOrigin>","t="+t.tabId,`OriginTab: ${p.url}`,t.url,n.SmartProfileType[i.activeProfile?.profileType]),m.getResultProxyInfo(l);p.resetTabState()}if(h==n.SmartProfileType.AlwaysEnabledBypassRules){let g=i.activeProfile.compiledRules,S=o.ProxyRules.findMatchedUrlInRules(e.url,g.Rules);if(S)return t.ruleSource=n.CompiledProxyRuleSource.Rules,v(S);let y=o.ProxyRules.findMatchedUrlInRules(e.url,g.WhitelistRules);if(y)return t.ruleSource=n.CompiledProxyRuleSource.Rules,P(y);let b=o.ProxyRules.findMatchedUrlInRules(e.url,g.SubscriptionRules);if(b)return t.ruleSource=n.CompiledProxyRuleSource.Subscriptions,v(b);let x=o.ProxyRules.findMatchedUrlInRules(e.url,g.WhitelistSubscriptionRules);if(x)return t.ruleSource=n.CompiledProxyRuleSource.Subscriptions,P(x);function v(r){return t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.AlwaysEnabledForcedByRules,t.proxifiedStatus=n.ProxyableProxifiedStatus.MatchedRule,t.applyFromRule(r),e.tabId>-1&&(p=m.storeTabProxyDetail(e,r)??p),r.proxy?(r.proxy.username&&c.ProxyEngineSpecialRequests.setSpecialUrl(`${r.proxy.host}:${r.proxy.port}`,null,r.proxy),m.getResultProxyInfo(r.proxy)):m.getResultProxyInfo(l)}function P(e){return t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.AlwaysEnabledByPassed,t.proxifiedStatus=n.ProxyableProxifiedStatus.NoProxy,t.applyFromRule(e),{type:"direct"}}return t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.NoneMatched,t.proxifiedStatus=n.ProxyableProxifiedStatus.AlwaysEnabled,m.getResultProxyInfo(l)}if(h==n.SmartProfileType.SmartRules){let R=i.activeProfile.compiledRules,w=o.ProxyRules.findMatchedUrlInRules(e.url,R.WhitelistRules);if(w)return t.ruleSource=n.CompiledProxyRuleSource.Rules,C(w);let T=o.ProxyRules.findMatchedUrlInRules(e.url,R.Rules);if(T)return t.ruleSource=n.CompiledProxyRuleSource.Rules,I(T);let k=o.ProxyRules.findMatchedUrlInRules(e.url,R.WhitelistSubscriptionRules);if(k)return t.ruleSource=n.CompiledProxyRuleSource.Subscriptions,C(k);let _=o.ProxyRules.findMatchedUrlInRules(e.url,R.SubscriptionRules);if(_)return t.ruleSource=n.CompiledProxyRuleSource.Subscriptions,I(_);function C(e){return t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.Whitelisted,t.proxifiedStatus=n.ProxyableProxifiedStatus.NoProxy,t.applyFromRule(e),{type:"direct"}}function I(r){return t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.MatchedRule,t.proxifiedStatus=n.ProxyableProxifiedStatus.MatchedRule,t.applyFromRule(r),e.tabId>-1&&(p=m.storeTabProxyDetail(e,r)??p),r.proxy?(r.proxy.username&&c.ProxyEngineSpecialRequests.setSpecialUrl(`${r.proxy.host}:${r.proxy.port}`,null,r.proxy),m.getResultProxyInfo(r.proxy)):m.getResultProxyInfo(l)}}return n.SmartProfileType.IgnoreFailureRules,t.matchedRuleStatus=n.ProxyableMatchedRuleStatus.NoneMatched,t.proxifiedStatus=n.ProxyableProxifiedStatus.NoProxy,{type:"direct"}})();return s.DiagDebug?.trace("FF.handleProxyRequest","t="+t.tabId,g,t.url,n.SmartProfileType[i.activeProfile?.profileType]),m.storeTabStats(p,t,e,h),d.TabRequestLogger.notifyProxyableLog(t),g}static storeTabProxyDetail(e,t){if("main_frame"!==e.type)return null;let r=a.TabManager.getOrSetTab(e.tabId,!0,e.url);return null==r?null:(e.url!==r.url&&e.documentUrl||a.TabManager.setTabDataProxied(r,e.url,t),r)}static storeTabStats(e,t,r,i){null==e&&(e=a.TabManager.getTab(r.tabId)),null!=e&&(t.proxifiedStatus==n.ProxyableProxifiedStatus.AlwaysEnabled&&t.matchedRuleStatus==n.ProxyableMatchedRuleStatus.AlwaysEnabledByPassed&&(e.status.hasAlwaysEnabledByPassed=!0),t.matchedRuleStatus==n.ProxyableMatchedRuleStatus.Whitelisted&&(e.status.statsHasWhitelistedRules=!0),t.proxified?e.status.statsHasProxifiedRequest=!0:e.status.statsHasDirectRequest=!0)}static getResultProxyInfo(e){return"SOCKS5"===e.protocol?{type:"socks",host:e.host,port:e.port,proxyDNS:!!e.proxyDNS,username:e.username,password:e.password}:{type:e.protocol,host:e.host,port:e.port}}static onProxyError(e){s.Debug.error(`Proxy error: ${e.message}`,e)}}},"./src/core/ProxyEngineSpecialRequests.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProxyEngineSpecialRequests:()=>i});class i{static setSpecialUrl(e,t,r){i.SpecialUrls[e]={applyMode:t,selectedProxy:r}}static retrieveSpecialUrlMode(e,t=!0){var r=i.SpecialUrls[e];return r?(t&&delete i.SpecialUrls[e],r):null}}i.SpecialUrls={}},"./src/core/ProxyRules.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProxyRules:()=>l});var i=r("./src/lib/Debug.ts"),s=r("./src/core/definitions.ts"),n=r("./src/lib/Utils.ts"),o=r("./src/core/SettingsOperation.ts"),a=r("./src/lib/environment.ts");class l{static compileRules(e,t){if(!t)return;let r=[],i=[];for(let a=0;a<t.length;a++){const l=t[a];if(!l.enabled)continue;let u=new s.CompiledProxyRule;if(u.ruleId=l.ruleId,u.whiteList=l.whiteList,u.hostName=l.hostName,u.proxy=l.proxy,l.proxyServerId==s.ProxyRuleSpecialProxyServer.DefaultGeneral)u.proxy=null;else if(l.proxyServerId==s.ProxyRuleSpecialProxyServer.ProfileProxy&&e.profileProxyServerId){let t=o.SettingsOperation.findProxyServerById(e.profileProxyServerId);t&&(u.proxy=t)}switch(u.compiledRuleSource=s.CompiledProxyRuleSource.Rules,l.ruleType){case s.ProxyRuleType.Exact:u.search=l.ruleExact.toLowerCase(),u.compiledRuleType=s.CompiledProxyRuleType.Exact;break;case s.ProxyRuleType.DomainSubdomain:u.search=l.ruleSearch.toLowerCase(),u.compiledRuleType=s.CompiledProxyRuleType.SearchDomainSubdomain;break;case s.ProxyRuleType.MatchPatternHost:{let e=n.Utils.matchPatternToRegExp(l.rulePattern,!1,!0);if(null==e)continue;u.regex=e,u.compiledRuleType=s.CompiledProxyRuleType.RegexHost}break;case s.ProxyRuleType.MatchPatternUrl:{let e=n.Utils.matchPatternToRegExp(l.rulePattern,!0,!1);if(null==e)continue;u.regex=e,u.compiledRuleType=s.CompiledProxyRuleType.RegexUrl}break;case s.ProxyRuleType.RegexHost:u.regex=new RegExp(l.ruleRegex,"i"),u.compiledRuleType=s.CompiledProxyRuleType.RegexHost;break;case s.ProxyRuleType.RegexUrl:u.regex=new RegExp(l.ruleRegex),u.compiledRuleType=s.CompiledProxyRuleType.RegexUrl;break;case s.ProxyRuleType.DomainExact:u.search=l.ruleSearch.toLowerCase(),u.compiledRuleType=s.CompiledProxyRuleType.SearchDomain;break;case s.ProxyRuleType.DomainAndPath:u.search=l.ruleSearch.toLowerCase(),u.compiledRuleType=s.CompiledProxyRuleType.SearchDomainAndPath;break;case s.ProxyRuleType.DomainSubdomainAndPath:u.search=l.ruleSearch.toLowerCase(),u.compiledRuleType=s.CompiledProxyRuleType.SearchDomainSubdomainAndPath;break;case s.ProxyRuleType.SearchUrl:u.search=l.ruleSearch.toLowerCase(),u.compiledRuleType=s.CompiledProxyRuleType.SearchUrl;break;default:continue}l.whiteList?i.push(u):r.push(u)}return{compiledList:r,compiledWhiteList:i}}static compileRulesSubscription(e,t=null){if(!e)return[];let r=[];for(const n of e){let e=new s.CompiledProxyRule;switch(e.search=n.search,e.compiledRuleSource=s.CompiledProxyRuleSource.Subscriptions,!0===t&&(e.whiteList=!0),e.compiledRuleType=n.importedRuleType,n.importedRuleType){case s.CompiledProxyRuleType.RegexHost:e.regex=new RegExp(n.regex,"i");break;case s.CompiledProxyRuleType.RegexUrl:e.regex=new RegExp(n.regex);break;case s.CompiledProxyRuleType.Exact:case s.CompiledProxyRuleType.SearchUrl:case s.CompiledProxyRuleType.SearchDomain:case s.CompiledProxyRuleType.SearchDomainSubdomain:case s.CompiledProxyRuleType.SearchDomainAndPath:case s.CompiledProxyRuleType.SearchDomainSubdomainAndPath:break;default:i.Debug.error("compileRulesSubscription: Invalid importedRuleType of "+n.importedRuleType);continue}r.push(e)}return r}static findMatchedDomainListInRulesInfo(e,t){let r=[];for(const i of e){let e=l.findMatchedDomainInRulesInfo(i,t);r.push(e)}return r}static findMatchedDomainInRulesInfo(e,t){let r=e.toLowerCase();return r.includes(":/")||(r="http://"+r),l.findMatchedUrlInRulesInfo(r,t)}static findMatchedUrlInRulesInfo(e,t){let r=l.findMatchedUrlInRules(e,t.WhitelistRules);if(r)return{compiledRule:r,matchedRuleSource:s.CompiledProxyRulesMatchedSource.WhitelistRules};let i=l.findMatchedUrlInRules(e,t.Rules);if(i)return{compiledRule:i,matchedRuleSource:s.CompiledProxyRulesMatchedSource.Rules};let n=l.findMatchedUrlInRules(e,t.WhitelistSubscriptionRules);if(n)return{compiledRule:n,matchedRuleSource:s.CompiledProxyRulesMatchedSource.WhitelistSubscriptionRules};let o=l.findMatchedUrlInRules(e,t.SubscriptionRules);return o?{compiledRule:o,matchedRuleSource:s.CompiledProxyRulesMatchedSource.SubscriptionRules}:null}static findMatchedDomainRule(e,t){let r=e.toLowerCase();return r.includes(":/")||(r="http://"+r),l.findMatchedUrlInRules(r,t)}static findMatchedUrlInRules(e,t){if(null==t||0==t.length)return null;let r,o,a=e.toLowerCase();try{for(let i of t)switch(i.compiledRuleType){case s.CompiledProxyRuleType.SearchDomainSubdomain:if(null==r&&(r=n.Utils.extractHostNameFromUrl(a),null==r))continue;if(r==i.search)return i;if(r.endsWith("."+i.search))return i;break;case s.CompiledProxyRuleType.Exact:if(a==i.search)return i;break;case s.CompiledProxyRuleType.RegexHost:if(null==r&&(r=n.Utils.extractHostNameFromUrl(a),null==r))continue;if(i.regex.test(r))return i;break;case s.CompiledProxyRuleType.RegexUrl:if(i.regex.test(e))return i;break;case s.CompiledProxyRuleType.SearchUrl:if(a.startsWith(i.search))return i;break;case s.CompiledProxyRuleType.SearchDomain:if(null==r&&(r=n.Utils.extractHostNameFromUrl(a),null==r))continue;if(i.search==r)return i;break;case s.CompiledProxyRuleType.SearchDomainAndPath:if(null==o&&(o=n.Utils.removeSchemaFromUrl(a),null==o))continue;if(o.startsWith(i.search))return i;break;case s.CompiledProxyRuleType.SearchDomainSubdomainAndPath:if(null==o&&(o=n.Utils.removeSchemaFromUrl(a),null==o))continue;if(o.startsWith(i.search))return i;let t=n.Utils.extractHostNameFromInvalidUrl(i.search);if(null!=t){if(null==r&&(r=n.Utils.extractHostNameFromUrl(a),null==r))continue;if(t!=r&&!r.endsWith("."+t))continue}if(o.includes("."+i.search))return i}if(null!=r){let e=n.Utils.extractHostFromUrl(a);if(e!=r){r=e;for(let e of t)switch(e.compiledRuleType){case s.CompiledProxyRuleType.SearchDomainSubdomain:if(r==e.search)return e;if(r.endsWith("."+e.search))return e;break;case s.CompiledProxyRuleType.RegexHost:if(e.regex.test(r))return e;break;case s.CompiledProxyRuleType.SearchDomain:if(e.search==r)return e;break;case s.CompiledProxyRuleType.SearchDomainSubdomainAndPath:if(null==o&&(o=n.Utils.removeSchemaFromUrl(a),null==o))continue;if(o.startsWith(e.search))return e;let t=n.Utils.extractHostFromInvalidUrl(e.search);if(null!=t&&t!=r&&!r.endsWith("."+t))continue;if(o.includes("."+e.search))return e;case s.CompiledProxyRuleType.Exact:case s.CompiledProxyRuleType.RegexUrl:case s.CompiledProxyRuleType.SearchUrl:case s.CompiledProxyRuleType.SearchDomainAndPath:}}}}catch(t){i.Debug.warn(`findMatchForUrl failed for ${e}`,t)}return null}static validateRule(e){return e.hostName&&!n.Utils.isValidHost(e.hostName)?{success:!1,message:a.api.i18n.getMessage("settingsRuleSourceInvalidFormat").replace("{0}",e.hostName)}:e.rule?(null==e.enabled&&(e.enabled=!0),{success:!0}):{success:!1,message:a.api.i18n.getMessage("settingsRulePatternIsEmpty")}}}},"./src/core/Settings.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{Settings:()=>d});var i=r("./src/lib/PolyFill.ts"),s=r("./src/core/definitions.ts"),n=r("./src/lib/Debug.ts"),o=r("./src/core/SettingsOperation.ts"),a=r("./src/lib/environment.ts"),l=r("./src/lib/Utils.ts"),u=r("./src/core/ProfileOperations.ts");const c=o.SettingsOperation;class d{static initialize(){p.current=new s.SettingsConfig,i.PolyFill.storageLocalGet(null,p.onInitializeGetLocalData,p.onInitializeGetLocalError),a.api.storage.onChanged.addListener(o.SettingsOperation.syncOnChanged)}static addInitializeCompletedEventListener(e){p.onInitializedCompleted.addEventListener("onInitializedCompleted",e,{passive:!0,once:!0})}static removeInitializeCompletedEventListener(e){p.onInitializedCompleted.removeEventListener("onInitializedCompleted",e)}static raiseInitializeCompletedEvent(){p.onInitializedCompleted.dispatchEvent(new Event("onInitializedCompleted"))}static onInitializeGetLocalData(e){n.Debug.log("onInitializeGetLocalData, local data:",JSON.stringify(e)),e=p.getRestorableSettings(e),c.copyNonSyncableSettings(e,p.current),p.current=e,p.updateActiveSettings(),o.SettingsOperation.saveAllLocal(!0),p.cleanupLocalOldVersionResidueFromStorage(),i.PolyFill.storageSyncGet(null,p.onInitializeGetSyncData,p.onInitializeGetSyncError),p.onInitializedLocally&&p.onInitializedLocally()}static onInitializeGetLocalError(e){n.Debug.error(`settingsOperation.initialize error: ${e.message}`),p.onInitializedLocally&&p.onInitializedLocally(),p.raiseInitializeCompletedEvent()}static onInitializeGetSyncData(e){try{let t=l.Utils.decodeSyncData(e);n.Debug.log("onInitializeGetSyncData, sync data: ",JSON.stringify(t)),t&&t.options&&(t.options.syncSettings?(t=p.getRestorableSettings(t),p.revertSyncOptions(t),c.copyNonSyncableSettings(t,p.current),p.current=t):t.options.syncSettings=!1,p.currentOptionsSyncSettings=t.options.syncSettings,p.updateActiveSettings())}catch(t){n.Debug.error(`settingsOperation.readSyncedSettings> onGetSyncData error: ${t} \r\n`,JSON.stringify(e))}p.onInitializedRemoteSync&&p.onInitializedRemoteSync(),p.raiseInitializeCompletedEvent()}static onInitializeGetSyncError(e){n.Debug.error(`settingsOperation.readSyncedSettings error: ${e.message}`),p.raiseInitializeCompletedEvent()}static getRestorableSettings(e){return p.setDefaultSettings(e),p.migrateFromOldVersions(e),p.ensureIntegrityOfSettings(e),e}static setDefaultSettings(e){e.product="SmartProxy",e.version=null,null==e.activeProfileId&&(e.activeProfileId=s.SmartProfileTypeBuiltinIds.Direct),null==e.defaultProxyServerId&&(e.defaultProxyServerId=null),null==e.options&&(e.options=new s.GeneralOptions),null==e.options.themeType&&(e.options.themeType=s.ThemeType.Auto),e.options.themesDark||(e.options.themesDark=s.GeneralOptions.defaultDarkThemeName),null==e.firstEverInstallNotified&&(e.firstEverInstallNotified=!1),null!=e.proxyServers&&Array.isArray(e.proxyServers)||(e.proxyServers=[]),null!=e.proxyProfiles&&Array.isArray(e.proxyProfiles)?e.proxyProfiles=p.setDefaultSettingsSmartProfiles(e.proxyProfiles):e.proxyProfiles=(0,s.getBuiltinSmartProfiles)(),null!=e.proxyServerSubscriptions&&Array.isArray(e.proxyServerSubscriptions)||(e.proxyServerSubscriptions=[]),i.PolyFill.getExtensionVersion((t=>{e.version=t}))}static ensureIntegrityOfSettings(e){if(e.proxyServers&&e.proxyServers.length){let t=[];o.SettingsOperation.sortProxyServers(e.proxyServers);let r=0;for(const i of e.proxyServers){let e=new s.ProxyServer;e.CopyFrom(i),e.isValid()&&(e.order=r,t.push(e),r++)}e.proxyServers=t}!e.defaultProxyServerId&&e.proxyServers?.length&&(e.defaultProxyServerId=e.proxyServers[0].id)}static migrateFromOldVersions(e){if(e.version<="0.9.9999"){let t=new s.GeneralOptions;if(e.options&&t.CopyFrom(e.options),e.options=t,e.proxyServers&&e.proxyServers.length){let t=[];for(const r of e.proxyServers){let e=new s.ProxyServer;e.CopyFrom(r),e.isValid()&&t.push(e)}e.proxyServers=t}if(e.proxyServerSubscriptions&&e.proxyServerSubscriptions.length){let t=[];for(const r of e.proxyServerSubscriptions){let e=new s.ProxyServerSubscription;e.CopyFrom(r),e.isValid()&&t.push(e)}e.proxyServerSubscriptions=t}}if(e.proxyProfiles){let t=e.proxyProfiles;for(const e of t)e.profileId||(n.Debug.warn("Found and fixed a profile without id> ",e.profileName),u.ProfileOperations.ensureProfileId(e)),t.find((t=>t.profileName==e.profileName&&t.profileId!=e.profileId))&&(n.Debug.warn("Found and fixed a profile with same name> ",e.profileName),e.profileName+=" - "+e.profileId)}if(e.proxyRules&&e.proxyRules.length&&e.proxyProfiles){let t=e.proxyProfiles.find((e=>e.profileType==s.SmartProfileType.SmartRules));if(t){for(const r of e.proxyRules){let e=new s.ProxyRule;e.CopyFrom(r),e.isValid()&&t.proxyRules.push(e)}delete e.proxyRules;let r=e.proxyRulesSubscriptions;if(r&&r.length){t.rulesSubscriptions=t.rulesSubscriptions||[];for(const e of r){let r=new s.ProxyRulesSubscription;r.CopyFrom(e),r.isValid()&&t.rulesSubscriptions.push(r)}}delete e.proxyRulesSubscriptions}else n.Debug.warn("Migrate has failed for SmartRules because no SmartRules is found in the new configuration")}if(e.bypass&&e.bypass.bypassList&&e.bypass.bypassList.length&&e.proxyProfiles){let t=e.proxyProfiles.find((e=>e.profileType==s.SmartProfileType.AlwaysEnabledBypassRules));if(t){let r=null==e.bypass.enableForAlways||e.bypass.enableForAlways;for(const i of e.bypass.bypassList){if(!i)continue;let e=new s.ProxyRule;e.ruleType=s.ProxyRuleType.DomainSubdomain,e.ruleSearch=i,e.hostName=i,e.enabled=r,e.whiteList=!0,t.proxyRules.push(e)}}else n.Debug.warn("Migrate has failed for AlwaysEnabledRules because no AlwaysEnabledRules is found in the new configuration");delete e.bypass}if(null!=e.proxyMode&&e.proxyProfiles){let t=-1;switch(+e.proxyMode){case 0:t=s.SmartProfileType.Direct;break;case 1:t=s.SmartProfileType.SmartRules;break;case 2:t=s.SmartProfileType.AlwaysEnabledBypassRules;break;case 3:t=s.SmartProfileType.SystemProxy}if(t>=0){let r=e.proxyProfiles.find((e=>e.profileType==t));r&&(e.activeProfileId=r.profileId)}delete e.proxyMode}if(e.activeProxyServer&&e.activeProxyServer.name&&e.proxyServers.length&&e.proxyServers){let t=e.activeProxyServer.name,r=e.proxyServers.find((e=>e.name==t));r&&(e.defaultProxyServerId=r.id),delete e.activeProxyServer}}static cleanupLocalOldVersionResidueFromStorage(){i.PolyFill.storageLocalGet(null,(function(e){i.PolyFill.storageLocalRemove(["proxyRules","proxyRulesSubscriptions","bypass","proxyMode","activeProxyServer"])}))}static revertSyncOptions(e){let t=p.current;e.options.syncActiveProxy=t.options.syncActiveProxy,e.options.syncActiveProfile=t.options.syncActiveProfile,t.options.syncActiveProxy||(e.defaultProxyServerId=t.defaultProxyServerId),t.options.syncActiveProfile||(e.activeProfileId=t.activeProfileId)}static setDefaultSettingsSmartProfiles(e){let t,r=!1,i=!1,n=!1,o=!1,a=[];for(const t of e){if(null==t.profileType)continue;let u=(0,s.getSmartProfileTypeConfig)(t.profileType);if(null==u)continue;t.profileType==s.SmartProfileType.Direct?r=!0:t.profileType==s.SmartProfileType.SmartRules?i=!0:t.profileType==s.SmartProfileType.AlwaysEnabledBypassRules?n=!0:t.profileType==s.SmartProfileType.SystemProxy&&(o=!0);let c=t.profileTypeConfig?.builtin||!1,d=new s.SmartProfile;if(Object.assign(d,t),d.profileTypeConfig=u,!c&&u.builtin){let r=e.find((e=>e.profileType==t.profileType&&e.profileId!=t.profileId));r&&r.profileTypeConfig?.builtin?(d.profileTypeConfig.builtin=!1,t.profileTypeConfig.builtin=!1):(d.profileTypeConfig.builtin=!0,t.profileTypeConfig.builtin=!0)}d.profileName||(d.profileName=`${s.SmartProfileType[d.profileType]} - ${l.Utils.getNewUniqueIdNumber()}`),a.push(d)}return!(r&&i&&n&&o)&&(t=(0,s.getBuiltinSmartProfiles)(),r||a.push(t.find((e=>e.profileType==s.SmartProfileType.Direct))),i||a.push(t.find((e=>e.profileType==s.SmartProfileType.SmartRules))),n||a.push(t.find((e=>e.profileType==s.SmartProfileType.AlwaysEnabledBypassRules))),o||a.push(t.find((e=>e.profileType==s.SmartProfileType.SystemProxy))),a.sort(((e,t)=>e.profileType<t.profileType?-1:e.profileType>t.profileType?1:0))),a}static validateProxyServer(e,t=!0){if(e.port<=0||e.port>65535)return{success:!1,message:a.api.i18n.getMessage("settingsServerPortInvalid").replace("{0}",`${e.host}:${e.port}`)};if(!e.host||!l.Utils.isValidHost(e.host))return{success:!1,message:a.api.i18n.getMessage("settingsServerHostInvalid").replace("{0}",`${e.host}:${e.port}`)};if(!e.name)return{success:!1,message:a.api.i18n.getMessage("settingsServerNameRequired")};if(p.current&&t){const t=p.current.proxyServers;for(let r of t)if(r.name==e.name)return{success:!1,exist:!0,message:`Server name ${e.name} already exists`}}return e.protocol?(e.protocol=e.protocol.toUpperCase(),-1==s.proxyServerProtocols.indexOf(e.protocol)&&(e.protocol="HTTP")):e.protocol="HTTP",{success:!0}}static updateActiveSettings(e=!0){let t=p.current;if(!t)return;let r=p.active??(p.active=new s.SettingsActive),i=u.ProfileOperations.findSmartProfileById(t.activeProfileId,t.proxyProfiles);!i&&e&&(i=u.ProfileOperations.findSmartProfileById(s.SmartProfileTypeBuiltinIds.Direct,t.proxyProfiles));let n=null;if(i&&(r.activeProfile=u.ProfileOperations.compileSmartProfile(i),n=r.activeProfile),r.currentProxyServer=null,n?.profileProxyServer&&(r.currentProxyServer=r.activeProfile.profileProxyServer),!r.currentProxyServer){let e=o.SettingsOperation.findProxyServerById(t.defaultProxyServerId);e&&(r.currentProxyServer=e)}let a=null;if(t.options.activeIncognitoProfileId)if(i.profileId==t.options.activeIncognitoProfileId)a=n;else{const e=u.ProfileOperations.findSmartProfileById(t.options.activeIncognitoProfileId,t.proxyProfiles);e&&(a=u.ProfileOperations.compileSmartProfile(e))}r.activeIncognitoProfile=a;let l=u.ProfileOperations.getIgnoreFailureRulesProfile();l&&(r.currentIgnoreFailureProfile=u.ProfileOperations.compileSmartProfile(l))}}d.currentOptionsSyncSettings=!0,d.onInitializedLocally=null,d.onInitializedRemoteSync=null,d.onInitializedCompleted=new EventTarget;let p=d},"./src/core/SettingsOperation.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{SettingsOperation:()=>S});var i=r("./src/lib/environment.ts"),s=r("./src/lib/PolyFill.ts"),n=r("./src/lib/Debug.ts"),o=r("./src/core/Settings.ts"),a=r("./src/lib/Utils.ts"),l=r("./src/core/definitions.ts"),u=r("./src/core/ProxyEngine.ts"),c=r("./src/core/ProxyRules.ts"),d=r("./src/core/SubscriptionUpdater.ts"),p=r("./src/core/ProfileOperations.ts");const m=d.SubscriptionUpdater,f=u.ProxyEngine,h=s.PolyFill,g=a.Utils;class S{static getStrippedSyncableSettings(e){let t=JSON.parse(JSON.stringify(e));if(t.proxyProfiles&&t.proxyProfiles.length)for(const e of t.proxyProfiles)if(e.rulesSubscriptions&&e.rulesSubscriptions.length)for(const t of e.rulesSubscriptions)t.proxyRules=[],t.whitelistRules=[];if(t.proxyServerSubscriptions&&t.proxyServerSubscriptions.length)for(const e of t.proxyServerSubscriptions)e.proxies=[];return t}static copyNonSyncableSettings(e,t){if(e.proxyProfiles&&e.proxyProfiles.length)for(const r of e.proxyProfiles)if(r.rulesSubscriptions&&r.rulesSubscriptions.length)for(const e of r.rulesSubscriptions){if(!e.enabled)continue;let i=t.proxyProfiles.find((e=>e.profileId==r.profileId));if(!i)continue;let s=i.rulesSubscriptions.find((t=>t.id==e.id));s&&(s.proxyRules&&s.proxyRules.length?e.proxyRules=s.proxyRules:e.proxyRules=e.proxyRules||[],s.whitelistRules&&s.whitelistRules.length?e.whitelistRules=s.whitelistRules:e.whitelistRules=e.whitelistRules||[])}if(e.proxyServerSubscriptions&&e.proxyServerSubscriptions.length)for(const r of e.proxyServerSubscriptions){r.proxies=[];let e=t.proxyServerSubscriptions.find((e=>e.name==r.name&&e.url==r.url));e&&e.proxies&&e.proxies.length&&(r.proxies=e.proxies)}}static getBackupOfSettings(e){let t=S.getStrippedSyncableSettings(e);return t.configVersion=void 0,t.syncHash=void 0,t}static readSyncedSettings(e){h.storageSyncGet(null,(function(t){try{let r=g.decodeSyncData(t);if(r&&r.options){if(r.syncHash==o.Settings.current.syncHash)return void n.Debug.log("SyncHash is same, ignoring the sync data.",o.Settings.current.syncHash);r.options.syncSettings?(r=o.Settings.getRestorableSettings(r),o.Settings.revertSyncOptions(r),y.copyNonSyncableSettings(r,o.Settings.current),o.Settings.current=r):(r.options.syncSettings=!1,r=o.Settings.getRestorableSettings(r)),o.Settings.currentOptionsSyncSettings=r.options.syncSettings,o.Settings.updateActiveSettings(),e&&e()}}catch(e){n.Debug.error(`SettingsOperation.readSyncedSettings> onGetSyncData error: ${e} \r\n`,JSON.stringify(t))}}),(function(e){n.Debug.error(`SettingsOperation.readSyncedSettings error: ${e.message}`)}))}static initialize(e){function t(t){try{let e=g.decodeSyncData(t);e&&e.options&&(e.options.syncSettings?(e=o.Settings.getRestorableSettings(e),o.Settings.revertSyncOptions(e),y.copyNonSyncableSettings(e,o.Settings.current),o.Settings.current=e):(e.options.syncSettings=!1,e=o.Settings.getRestorableSettings(e)),o.Settings.currentOptionsSyncSettings=e.options.syncSettings,o.Settings.updateActiveSettings())}catch(e){n.Debug.error(`SettingsOperation.onGetSyncData error: ${e} \r\n ${t}`)}e&&e()}function r(t){n.Debug.error(`SettingsOperation.initialize error: ${t.message}`),e&&e()}h.storageLocalGet(null,(function(e){e=o.Settings.getRestorableSettings(e),y.copyNonSyncableSettings(e,o.Settings.current),o.Settings.current=e,h.storageSyncGet(null,t,r)}),(function(e){n.Debug.error(`SettingsOperation.initialize error: ${e.message}`)}))}static findProxyServerByIdFromList(e,t,r){if(t){let r=t.find((t=>t.id===e));if(void 0!==r)return r}if(r)for(let t of r){let r=t.proxies.find((t=>t.id===e));if(void 0!==r)return r}return null}static findProxyServerByName(e){let t=o.Settings.current.proxyServers.find((t=>t.name===e));if(void 0!==t)return t;for(let r of o.Settings.current.proxyServerSubscriptions)if(t=r.proxies.find((t=>t.name===e)),void 0!==t)return t;return null}static findProxyServerById(e){let t=o.Settings.current.proxyServers.find((t=>t.id===e));if(void 0!==t)return t;for(let r of o.Settings.current.proxyServerSubscriptions)if(t=r.proxies.find((t=>t.id===e)),void 0!==t)return t;return null}static sortProxyServers(e){e&&e.sort(((e,t)=>(e.order??0)>t.order?1:(e.order??0)<t.order?-1:0))}static getAllSubscribedProxyServers(){if(!o.Settings.current.proxyServerSubscriptions||!o.Settings.current.proxyServerSubscriptions.length)return[];let e=[];for(let t of o.Settings.current.proxyServerSubscriptions)t.enabled&&(e=e.concat(t.proxies));return e}static getFirstProxyServer(){let e=o.Settings.current;if(e.proxyServers&&e.proxyServers.length)return e.proxyServers[0];if(e.proxyServerSubscriptions)for(const t of e.proxyServerSubscriptions)if(t.proxies&&t.proxies.length)return t.proxies[0];return null}static getLastProxyServer(){let e=o.Settings.current;if(e.proxyServers&&e.proxyServers.length)return e.proxyServers[e.proxyServers.length-1];if(e.proxyServerSubscriptions)for(let t=e.proxyServerSubscriptions.length-1;t>=0;t--){const r=e.proxyServerSubscriptions[t];if(r.proxies&&r.proxies.length)return r.proxies[r.proxies.length-1]}return null}static findNextProxyServerByCurrentProxyId(e){let t=o.Settings.current,r=t.proxyServers.findIndex((t=>t.id===e));if(r>-1&&r+1<t.proxyServers.length)return t.proxyServers[r+1];for(let t of o.Settings.current.proxyServerSubscriptions)if(r=t.proxies.findIndex((t=>t.id===e)),r>-1&&r+1<t.proxies.length)return t.proxies[r+1];return null}static findPreviousProxyServerByCurrentProxyId(e){let t=o.Settings.current,r=t.proxyServers.findIndex((t=>t.id===e));if(r>0)return t.proxyServers[r-1];for(let t of o.Settings.current.proxyServerSubscriptions)if(r=t.proxies.findIndex((t=>t.id===e)),r>0)return t.proxies[r-1];return null}static syncOnChanged(e,t){"sync"===t&&(n.Debug.log("syncOnChanged ",t,e),S.readSyncedSettings((()=>{S.saveAllLocal(!0),f.notifyProxyRulesChanged(),m.reloadEmptyServerSubscriptions(),m.reloadEmptyRulesSubscriptions()})))}static saveAllSync(e=!0){if(o.Settings.current.syncHash=a.Utils.getNewUniqueIdString(),y.saveAllLocal(!0),(o.Settings.current.options.syncSettings||o.Settings.currentOptionsSyncSettings)&&e){var t=y.getStrippedSyncableSettings(o.Settings.current);let e=g.encodeSyncData(t);try{h.storageSyncSet(e,(()=>{o.Settings.currentOptionsSyncSettings=o.Settings.current.options.syncSettings}),(t=>{n.Debug.error(`SettingsOperation.saveAllSync error: ${t.message} `,e)}))}catch(e){n.Debug.error(`SettingsOperation.saveAllSync error: ${e}`)}}}static saveAllLocal(e=!1){!e&&o.Settings.current.options.syncSettings||h.storageLocalSet(o.Settings.current,null,(e=>{n.Debug.error("SettingsOperation.saveAllLocal error:",e)}))}static saveOptions(){o.Settings.current.options.syncSettings||h.storageLocalSet({options:o.Settings.current.options},null,(e=>{n.Debug.error(`SettingsOperation.saveOptions error: ${e.message}`)}))}static saveSmartProfiles(){o.Settings.current.options.syncSettings||h.storageLocalSet({proxyProfiles:o.Settings.current.proxyProfiles},null,(e=>{n.Debug.error(`SettingsOperation.saveProxyProfiles error: ${e.message}`)}))}static saveProxyServers(){o.Settings.current.options.syncSettings||h.storageLocalSet({proxyServers:o.Settings.current.proxyServers},null,(e=>{n.Debug.error(`SettingsOperation.saveRules error: ${e.message}`)}))}static saveProxyServerSubscriptions(){o.Settings.current.options.syncSettings||h.storageLocalSet({proxyServerSubscriptions:o.Settings.current.proxyServerSubscriptions},null,(e=>{n.Debug.error(`SettingsOperation.proxyServerSubscriptions error: ${e.message}`)}))}static saveDefaultProxyServer(){o.Settings.current.options.syncSettings||h.storageLocalSet({defaultProxyServerId:o.Settings.current.defaultProxyServerId},null,(e=>{n.Debug.error(`SettingsOperation.saveDefaultProxyServer error: ${e.message}`)}))}static saveActiveProfile(){o.Settings.current.options.syncSettings||h.storageLocalSet({activeProfileId:o.Settings.current.activeProfileId},null,(e=>{n.Debug.error(`SettingsOperation.saveActiveProfile error: ${e.message}`)}))}static saveUpdateInfo(e){o.Settings.current.updateInfo=e,y.saveAllSync()}static updateSmartProfilesRulesProxyServer(){const e=o.Settings.current.proxyServers,t=o.Settings.current.proxyServerSubscriptions,r=o.Settings.current.proxyProfiles;for(const i of r)if(i.proxyRules)for(const r of i.proxyRules){if(!r.proxyServerId){r.proxy=null;continue}let i=S.findProxyServerByIdFromList(r.proxyServerId,e,t);i?r.proxy=i:(r.proxy=null,r.proxyServerId=null)}}static restoreBackup(e){if(null==e)return{success:!1,message:"Invalid data"};let t=S.restoreBackupFromFile(e);if(!t.success)return t;let r=t.config;return o.Settings.current=r,S.saveAllSync(),f.updateBrowsersProxyConfig(),o.Settings.updateActiveSettings(),{success:!0,message:i.api.i18n.getMessage("settingsRestoreSettingsSuccess")}}static restoreBackupFromFile(e){let t,r=o.Settings.current;try{try{t=JSON.parse(e)}catch(t){return n.Debug.error("Backup data is invalid or corrupted",t,e),{success:!1,message:i.api.i18n.getMessage("settingsRestoreSettingsFailedInvalid")}}if(!t.version)return n.Debug.error("Backup data is missing `Version` field",e),{success:!1,message:i.api.i18n.getMessage("settingsRestoreSettingsFailedInvalid")};let a=new l.SettingsConfig;a.CopyFrom(r),Object.assign(a,t),o.Settings.setDefaultSettings(a),a.version=t.version,o.Settings.migrateFromOldVersions(a);let u=new l.SettingsConfig;if(u.CopyFrom(a),a=u,t.options&&a.options.CopyFrom(t.options),t.proxyServers&&Array.isArray(t.proxyServers)&&t.proxyServers.length){let e=[];for(const r of t.proxyServers){let t=new l.ProxyServer;t.CopyFrom(r),t.isValid()&&e.push(t)}a.proxyServers=e}if(t.proxyServerSubscriptions&&Array.isArray(t.proxyServerSubscriptions)&&t.proxyServerSubscriptions.length){let e=[];for(let r of t.proxyServerSubscriptions){let t=new l.ProxyServerSubscription;t.CopyFrom(r),e.push(t)}a.proxyServerSubscriptions=e}if(t.proxyProfiles&&Array.isArray(t.proxyProfiles)&&t.proxyProfiles.length){let e=[];for(let r of t.proxyProfiles){let t=new l.SmartProfile;p.ProfileOperations.copySmartProfile(r,t,!1),p.ProfileOperations.resetProfileTypeConfig(t),e.push(t)}a.proxyProfiles=e}if(t.activeProfileId&&a.proxyProfiles){let e=a.proxyProfiles.find((e=>e.profileId==t.activeProfileId));e&&(a.activeProfileId=e.profileId)}if(t.defaultProxyServerId){let e=S.findProxyServerByIdFromList(t.defaultProxyServerId,a.proxyServers,a.proxyServerSubscriptions);e&&(a.defaultProxyServerId=e.id)}return a.version=r.version,s.PolyFill.getExtensionVersion((e=>{a.version=e})),o.Settings.ensureIntegrityOfSettings(a),{success:!0,config:a}}catch(t){return n.Debug.error("Backup restore failed",t,e),{success:!1,message:i.api.i18n.getMessage("settingsRestoreSettingsFailed")}}}static factoryReset(){let e=new l.SettingsConfig;o.Settings.setDefaultSettings(e),o.Settings.current=e,S.saveAllSync(),f.updateBrowsersProxyConfig(),o.Settings.updateActiveSettings()}static restoreBackup_OLD(e){if(null==e)return{success:!1,message:"Invalid data"};try{let r,s,n,a,u,d,h=JSON.parse(e);if(null!=h.options&&"object"==typeof h.options){let e=function(e){let t=new l.GeneralOptions;return t.CopyFrom(e),{success:!0,result:t}}(h.options);if(!e.success)return e;r=e.result}if(null!=h.proxyServers&&Array.isArray(h.proxyServers)){let e=function(e){let t=[];for(let r of e){let e=new l.ProxyServer;e.CopyFrom(r);let i=o.Settings.validateProxyServer(e,!1);if(!i.success){if(i.exist)continue;return i}t.push(e)}return{success:!0,result:t}}(h.proxyServers);if(!e.success)return e;s=e.result}if(null!=h.proxyServerSubscriptions&&Array.isArray(h.proxyServerSubscriptions)){let e=function(e){let t=[];for(let r of e){let e=new l.ProxyServerSubscription;e.CopyFrom(r),t.push(e)}return{success:!0,result:t}}(h.proxyServerSubscriptions);if(!e.success)return e;n=e.result}if(null!=h.proxyProfiles&&Array.isArray(h.proxyProfiles)){let e=function(e){let t=[];for(let r of e){let e=new l.SmartProfile;p.ProfileOperations.copySmartProfile(r,e,!1);for(const t of e.proxyRules){let e=c.ProxyRules.validateRule(t);if(!e.success)return e}t.push(e)}return{success:!0,result:t}}(h.proxyProfiles);if(!e.success)return e;a=e.result}if(null!=h.defaultProxyServerId&&"string"==typeof h.defaultProxyServerId){let e=(t=h.defaultProxyServerId,null==S.findProxyServerById(t)?{success:!1,result:i.api.i18n.getMessage("settingsRestoreSettingsFailedInvalidDefaultProxyServer")}:{success:!0,result:t});if(!e.success)return e;u=e.result}if(null!=h.activeProfileId&&"string"==typeof h.activeProfileId){let e=function(e){return null==e||e<=0?{success:!1,message:i.api.i18n.getMessage("settingsRestoreSettingsFailedInvalidActiveProfile")}:{success:!0,result:e}}(h.activeProfileId);if(!e.success)return e;d=e.result}return null!=r&&(o.Settings.current.options=r,S.saveOptions()),null!=s&&(o.Settings.current.proxyServers=s,S.saveProxyServers()),null!=n&&(o.Settings.current.proxyServerSubscriptions=n,S.saveProxyServerSubscriptions(),m.setServerSubscriptionsRefreshTimers()),null!=a&&(o.Settings.current.proxyProfiles=a,S.saveSmartProfiles(),f.notifyProxyRulesChanged(),m.setRulesSubscriptionsRefreshTimers()),null!=u&&(o.Settings.current.defaultProxyServerId=u,S.saveDefaultProxyServer()),null!=d&&(o.Settings.current.activeProfileId=d,S.saveActiveProfile()),S.saveAllSync(),f.updateBrowsersProxyConfig(),o.Settings.updateActiveSettings(),{success:!0,message:i.api.i18n.getMessage("settingsRestoreSettingsSuccess")}}catch(t){return n.Debug.error("Backup restore failed",t,e),{success:!1,message:i.api.i18n.getMessage("settingsRestoreSettingsFailed")}}var t}}let y=S},"./src/core/SubscriptionUpdater.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{SubscriptionUpdater:()=>c});var i=r("./src/lib/Debug.ts"),s=r("./src/core/Settings.ts"),n=r("./src/lib/ProxyImporter.ts"),o=r("./src/core/SettingsOperation.ts"),a=r("./src/lib/RuleImporter.ts"),l=r("./src/core/ProxyEngine.ts"),u=r("./src/core/definitions.ts");class c{static async reloadEmptyServerSubscriptions(){for(let e of s.Settings.current.proxyServerSubscriptions)e.enabled&&(null!=e.proxies&&e.proxies.length||c.readServerSubscription(e.name))}static setServerSubscriptionsRefreshTimers(){let e=[];for(let t of s.Settings.current.proxyServerSubscriptions){if(i.DiagDebug?.trace("updateServerSubscriptions","enabled:"+t.enabled,"refreshRate:"+t.refreshRate),!(t.enabled&&t.refreshRate>0)){let e=c.getServerSubscriptionIdTimer(t.name);e?.timer&&(clearInterval(e.timer.timerId),c.serverSubscriptionTimers.splice(e.index,1));continue}e.push(t.name);let r=!1,s=c.getServerSubscriptionIdTimer(t.name);if(null==s?r=!0:s.timer.refreshRate!=t.refreshRate&&(r=!0,clearInterval(s.timer.timerId),c.serverSubscriptionTimers.splice(s.index,1)),r){let e=60*t.refreshRate*1e3,r=setInterval(c.readServerSubscription,e,t.name);c.serverSubscriptionTimers.push({timerId:r,subscriptionId:t.name,refreshRate:t.refreshRate})}}let t=c.serverSubscriptionTimers.filter((t=>-1!==e.indexOf(t.subscriptionId)||(clearInterval(t.timerId),!1)));c.serverSubscriptionTimers=t}static readServerSubscription(e){if(i.Debug.log("readServerSubscription",e),!e)return;let t=s.Settings.current.proxyServerSubscriptions.find((t=>t.name===e));if(!t){let t=c.getServerSubscriptionIdTimer(e);if(!t)return;return clearInterval(t.timer.timerId),void c.serverSubscriptionTimers.splice(t.index,1)}t.stats||(t.stats=new u.SubscriptionStats),n.ProxyImporter.readFromServer(t,(function(r){if(r)if(r.success){let e=r.result.length;t.proxies=r.result,t.totalCount=e,u.SubscriptionStats.updateStats(t.stats,!0),o.SettingsOperation.saveProxyServerSubscriptions(),o.SettingsOperation.saveAllSync(!1)}else u.SubscriptionStats.updateStats(t.stats,!1),i.Debug.warn("Failed to read proxy server subscription: "+e)}),(function(r){u.SubscriptionStats.updateStats(t.stats,!1,r),i.Debug.warn("Failed to read proxy server subscription: "+e,t,r)}))}static async reloadEmptyRulesSubscriptions(){for(const e of s.Settings.current.proxyProfiles)if(e.rulesSubscriptions)for(const t of e.rulesSubscriptions)t.enabled&&(null!=t.proxyRules&&t.proxyRules.length||null!=t.whitelistRules&&t.whitelistRules.length||c.readRulesSubscription(t))}static setRulesSubscriptionsRefreshTimers(){let e=[];for(const t of s.Settings.current.proxyProfiles)if(t.rulesSubscriptions)for(const r of t.rulesSubscriptions){if(!(r.enabled&&r.refreshRate>0)){let e=c.getRulesSubscriptionIdTimer(r.id);e?.timer&&(clearInterval(e.timer.timerId),c.rulesSubscriptionTimers.splice(e.index,1));continue}e.push(r.id);let t=!1,i=c.getRulesSubscriptionIdTimer(r.id);if(null==i?t=!0:i.timer.refreshRate!=r.refreshRate&&(t=!0,clearInterval(i.timer.timerId),c.rulesSubscriptionTimers.splice(i.index,1)),t){let e=60*r.refreshRate*1e3,t=setInterval(c.readRulesSubscription,e,r);c.rulesSubscriptionTimers.push({timerId:t,subscriptionId:r.id,refreshRate:r.refreshRate})}}let t=c.rulesSubscriptionTimers.filter((t=>-1!==e.indexOf(t.subscriptionId)||(clearInterval(t.timerId),!1)));c.rulesSubscriptionTimers=t}static readRulesSubscription(e){if(i.Debug.log("readRulesSubscription",e.name),e&&e.name){if(!e){let t=c.getRulesSubscriptionIdTimer(e.id);if(!t)return;return clearInterval(t.timer.timerId),void c.rulesSubscriptionTimers.splice(t.index,1)}e.stats||(e.stats=new u.SubscriptionStats),a.RuleImporter.readFromServerAndImport(e,(t=>{t&&(t.success?(e.proxyRules=t.rules.blackList,e.whitelistRules=t.rules.whiteList,e.totalCount=t.rules.blackList.length+t.rules.whiteList.length,u.SubscriptionStats.updateStats(e.stats,!0),o.SettingsOperation.saveProxyServerSubscriptions(),o.SettingsOperation.saveAllSync(!1),l.ProxyEngine.notifyProxyRulesChanged()):(u.SubscriptionStats.updateStats(e.stats,!1),i.Debug.warn("Failed to read proxy rules subscription: "+e.name)))}),(function(t){u.SubscriptionStats.updateStats(e.stats,!1,t),i.Debug.warn("Failed to read proxy rules subscription: "+e.name,e,t)}))}}static _getSubscriptionIdTimer(e,t){let r=e.findIndex((e=>e.subscriptionId===t));return r>=0?{timer:e[r],index:r}:null}static getServerSubscriptionIdTimer(e){return c._getSubscriptionIdTimer(c.serverSubscriptionTimers,e)}static getRulesSubscriptionIdTimer(e){return c._getSubscriptionIdTimer(c.rulesSubscriptionTimers,e)}}c.serverSubscriptionTimers=[{timerId:null,subscriptionId:null,refreshRate:null}],c.rulesSubscriptionTimers=[{timerId:null,subscriptionId:null,refreshRate:null}]},"./src/core/TabManager.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{TabDataStatuses:()=>d,TabDataType:()=>c,TabManager:()=>u});var i=r("./src/lib/PolyFill.ts"),s=r("./src/lib/LiteEvent.ts"),n=r("./src/core/definitions.ts"),o=r("./src/lib/environment.ts"),a=r("./src/core/Settings.ts"),l=r("./src/core/ProxyRules.ts");class u{static get TabRemoved(){return this.onTabRemoved.expose()}static get TabUpdated(){return this.onTabUpdated.expose()}static initializeTracking(){o.api.tabs.onActivated.addListener(u.updateActiveTab),o.api.tabs.onUpdated.addListener(u.handleTabUpdated),o.api.tabs.onUpdated.addListener(u.updateActiveTab),o.api.tabs.onRemoved.addListener(u.handleTabRemoved),o.api.windows&&o.api.windows.onFocusChanged.addListener(u.updateActiveTab),u.updateActiveTab()}static getOrSetTab(e,t=!0,r=null){let i=u.tabs[e];return null==i&&(i=new c(e),u.tabs[e]=i,r&&(i.url=r),t&&u.loadTabData(i)),i}static getTab(e){return u.tabs[e]}static getCurrentTab(){return u.currentTab}static updateTabData(e,t){if(!t)return null;let r=t.id;return e||(e=u.getOrSetTab(r,!1)),e.proxifiedParentDocumentUrl!=t.url&&(e.resetTabState(),u.setRuleForProxyPerOrigin(e,t.url)),e.updated=new Date,e.incognito=t.incognito,e.url=t.url,e.index=t.index,e.proxifiedParentDocumentUrl||(e.proxifiedParentDocumentUrl=t.url),u.tabs[r]=e,u.onTabUpdated.trigger(e),e}static setTabDataProxied(e,t,r){r?(e.proxified=r.whiteList?n.TabProxyStatus.Whitelisted:n.TabProxyStatus.Proxified,e.proxifiedParentDocumentUrl=t,e.proxyMatchedRule=r,e.proxyRuleHostName=r.hostName,r.proxy?e.proxyServerFromRule=r.proxy:e.proxyServerFromRule=null):e.resetTabState()}static setRuleForProxyPerOrigin(e,t){if(o.environment.chrome)return;if(1!=a.Settings.current.options?.proxyPerOrigin)return;let r=a.Settings.active;if(!r)return;let i=r.activeProfile,s=l.ProxyRules.findMatchedUrlInRulesInfo(t,i.compiledRules);if(null!=s){let r=s.compiledRule;u.setTabDataProxied(e,t,r)}}static updateActiveTab(){i.PolyFill.tabsQuery({active:!0,currentWindow:!0},(e=>{if(!e||!e.length)return;let t=e[0],r=u.updateTabData(null,t);u.currentTab=r}))}static loadTabData(e){i.PolyFill.tabsGet(e.tabId,(t=>{u.updateTabData(e,t)}))}static handleTabRemoved(e){let t=u.tabs[e];null!=t&&(delete u.tabs[e],u.onTabRemoved.trigger(t),t.clearFailedRequests())}static handleTabUpdated(e,t,r){let i=u.tabs[e],s=!1,n=!1;t.url&&null!=i&&t.url!=i.url&&(s=!0),s||"loading"!==t.status||(n=!0);let o=!1;n&&i&&(o=!0,i.resetFailedRequests()),s&&i&&(i.clearFailedRequests(),u.loadTabData(i),o=!0),o&&u.onTabUpdated.trigger(i)}}u.tabs={},u.onTabRemoved=new s.LiteEvent,u.onTabUpdated=new s.LiteEvent;class c{constructor(e){this.tabId=e,this.created=new Date,this.updated=new Date,this.url="",this.incognito=!1,this.failedRequests=new Map,this.proxified=n.TabProxyStatus.None,this.status=new d}clearFailedRequests(){this.failedRequests&&this.failedRequests.clear()}resetFailedRequests(){this.failedRequests&&this.failedRequests.forEach(((e,t,r)=>{e.hitCount=1}))}resetTabState(){this.proxified=n.TabProxyStatus.None,this.proxyServerFromRule=null,this.proxifiedParentDocumentUrl=null,this.status=new d}}class d{}},"./src/core/TabRequestLogger.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{TabRequestLogger:()=>d});var i=r("./src/core/TabManager.ts"),s=r("./src/lib/Utils.ts"),n=r("./src/lib/PolyFill.ts"),o=r("./src/lib/Debug.ts"),a=r("./src/core/ProxyRules.ts"),l=r("./src/core/definitions.ts"),u=r("./src/lib/environment.ts"),c=r("./src/core/Settings.ts");class d{static startTracking(){i.TabManager.TabRemoved.on(d.handleTabRemovedInternal),u.environment.chrome&&u.api.webRequest.onBeforeRequest.addListener(d.onBeforeRequestLogRequestInternal,{urls:l.monitorUrlsSchemaFilter})}static subscribeProxyableLogs(e){-1==d.subscribedTabList.indexOf(e)&&d.subscribedTabList.push(e)}static unsubscribeProxyableLogs(e){let t=d.subscribedTabList.indexOf(e);t>-1&&d.subscribedTabList.splice(t,1)}static handleTabRemovedInternal(e){d.notifyProxyableOriginTabRemoved(e.tabId),d.unsubscribeProxyableLogs(e.tabId)}static async notifyProxyableLog(e){0!=d.subscribedTabList.length&&-1!=d.subscribedTabList.indexOf(e.tabId)&&d.sendProxyableRequestLog(e)}static async sendProxyableRequestLog(e){n.PolyFill.runtimeSendMessage({command:l.CommandMessages.ProxyableRequestLog,tabId:e.tabId,logInfo:e},null,(t=>{d.unsubscribeProxyableLogs(e.tabId),o.Debug.error("sendProxyableRequestLog failed for ",e.tabId,t)}))}static onBeforeRequestLogRequestInternal(e){let t=e.tabId;t>-1&&0!=d.subscribedTabList.length&&-1!=d.subscribedTabList.indexOf(t)&&s.Utils.isValidUrl(e.url)&&d.notifyProxyableLogRequestInternal(e.url,t)}static async notifyProxyableLogRequestInternal(e,t){let r=d.getProxyableDataForUrl(e);r.tabId=t,d.sendProxyableRequestLog(r)}static notifyProxyableOriginTabRemoved(e){-1!=d.subscribedTabList.indexOf(e)&&n.PolyFill.runtimeSendMessage({command:l.CommandMessages.ProxyableOriginTabRemoved,tabId:e},null,(t=>{o.Debug.error("notifyProxyableOriginTabRemoved failed for ",e,t)}))}static getProxyableDataForUrl(e){let t=c.Settings.active.activeProfile;if(!t){let t=new l.ProxyableLogDataType;return t.url=e,t.ruleHostName="",t.rulePatternText="",t.proxifiedStatus=l.ProxyableProxifiedStatus.NoProxy,t.matchedRuleStatus=l.ProxyableMatchedRuleStatus.NoneMatched,t}let r=a.ProxyRules.findMatchedUrlInRulesInfo(e,t.compiledRules),i=r?.compiledRule,s=new l.ProxyableLogDataType;return s.url=e,s.ruleHostName="",s.rulePatternText="",s.proxifiedStatus=l.ProxyableProxifiedStatus.NoProxy,s.matchedRuleStatus=l.ProxyableMatchedRuleStatus.NoneMatched,null!=i&&(s.applyFromRule(i),s.ruleHostName=i.hostName,s.proxifiedStatus=l.ProxyableProxifiedStatus.MatchedRule,s.matchedRuleStatus=l.ProxyableMatchedRuleStatus.MatchedRule,s.ruleSource=l.CompiledProxyRuleSource.Rules,i.whiteList&&(s.matchedRuleStatus=l.ProxyableMatchedRuleStatus.Whitelisted,s.proxifiedStatus=l.ProxyableProxifiedStatus.NoProxy),t.profileType==l.SmartProfileType.AlwaysEnabledBypassRules&&(s.matchedRuleStatus=l.ProxyableMatchedRuleStatus.AlwaysEnabledByPassed),r.matchedRuleSource!=l.CompiledProxyRulesMatchedSource.SubscriptionRules&&r.matchedRuleSource!=l.CompiledProxyRulesMatchedSource.WhitelistSubscriptionRules||(s.ruleSource=l.CompiledProxyRuleSource.Subscriptions)),t.profileType==l.SmartProfileType.SystemProxy&&(s.proxifiedStatus=l.ProxyableProxifiedStatus.SystemProxyApplied),s}}d.subscribedTabList=[]},"./src/core/definitions.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{BrowserProxySettingsType:()=>P,CommandMessages:()=>M,CompiledProxyRule:()=>se,CompiledProxyRuleSource:()=>x,CompiledProxyRuleType:()=>b,CompiledProxyRulesInfo:()=>oe,CompiledProxyRulesMatchedSource:()=>_,ExternalRulesFormat:()=>A,FailedRequestType:()=>B,GeneralOptions:()=>ee,ImportedProxyRule:()=>ne,PartialThemeDataType:()=>N,PopupInternalDataType:()=>O,ProxyRule:()=>ie,ProxyRuleSpecialProxyServer:()=>k,ProxyRuleType:()=>y,ProxyRulesImportFromUI:()=>ce,ProxyRulesSubscription:()=>ue,ProxyServer:()=>re,ProxyServerForProtocol:()=>v,ProxyServerSubscription:()=>le,ProxyServerSubscriptionFormat:()=>I,ProxyableInternalDataType:()=>G,ProxyableLogDataType:()=>H,ProxyableMatchedRuleStatus:()=>R,ProxyableProxifiedStatus:()=>w,ResultHolder:()=>F,ResultHolderGeneric:()=>L,SettingsActive:()=>$,SettingsConfig:()=>W,SettingsPageSmartProfile:()=>z,ShortcutCommands:()=>E,SmartProfile:()=>V,SmartProfileBase:()=>q,SmartProfileCompiled:()=>Z,SmartProfileType:()=>g,SmartProfileTypeBuiltinIds:()=>S,SmartProfileTypeConfig:()=>j,SpecialRequestApplyProxyMode:()=>C,SubscriptionStats:()=>ae,TabProxyStatus:()=>D,ThemeType:()=>T,UpdateInfo:()=>de,getBuiltinSmartProfiles:()=>Y,getSmartProfileTypeConfig:()=>J,getSmartProfileTypeDefaultId:()=>X,getSmartProfileTypeIcon:()=>U,getSmartProfileTypeName:()=>Q,getUserSmartProfileTypeConfig:()=>K,monitorUrlsSchemaFilter:()=>p,proxyRulesActionTypes:()=>d,proxyServerProtocols:()=>a,proxyServerSubscriptionFormat:()=>u,proxyServerSubscriptionObfuscate:()=>l,specialRequestApplyProxyModeKeys:()=>c,themesCustomType:()=>m,themesDarkFix:()=>f,themesDataTablesDarkFix:()=>h});var i=r("./src/core/Settings.ts"),s=r("./src/lib/environment.ts"),n=r("./src/lib/Utils.ts"),o=r("./src/core/ProfileOperations.ts");const a=["HTTP","HTTPS","SOCKS4","SOCKS5"],l=["None","Base64"],u=["PlainText","JSON"],c=["NoProxy","CurrentProxy"],d=[s.api.i18n.getMessage("settingsRuleActionApplyProxy"),s.api.i18n.getMessage("settingsRuleActionWhitelist")],p=["*://*/*","ws://*/*","wss://*/*","ftp://*/*"],m="0",f="themes-darkfix.css",h="themes-datatables-darkfix.css";var g,S,y,b,x,v,P,R,w,T,k,_,C,I,A,D;function U(e){switch(e){case g.Direct:return"fas fa-ban text-danger";case g.SystemProxy:return"fab fa-windows text-primary";case g.SmartRules:return"fas fa-magic text-primary";case g.AlwaysEnabledBypassRules:return"fas fa-globe-americas text-success";case g.IgnoreFailureRules:return"fas fa-scroll";default:return""}}!function(e){e[e.Direct=0]="Direct",e[e.SystemProxy=1]="SystemProxy",e[e.SmartRules=2]="SmartRules",e[e.AlwaysEnabledBypassRules=3]="AlwaysEnabledBypassRules",e[e.IgnoreFailureRules=4]="IgnoreFailureRules"}(g||(g={})),function(e){e.Direct="InternalProfile_Direct",e.SmartRules="InternalProfile_SmartRules",e.AlwaysEnabled="InternalProfile_AlwaysEnabled",e.SystemProxy="InternalProfile_SystemProxy",e.IgnoreRequestFailures="InternalProfile_IgnoreRequestFailures"}(S||(S={})),function(e){e[e.MatchPatternHost=0]="MatchPatternHost",e[e.MatchPatternUrl=1]="MatchPatternUrl",e[e.RegexHost=2]="RegexHost",e[e.RegexUrl=3]="RegexUrl",e[e.Exact=4]="Exact",e[e.DomainSubdomain=5]="DomainSubdomain",e[e.DomainExact=6]="DomainExact",e[e.DomainAndPath=7]="DomainAndPath",e[e.DomainSubdomainAndPath=8]="DomainSubdomainAndPath",e[e.SearchUrl=9]="SearchUrl"}(y||(y={})),function(e){e[e.RegexHost=0]="RegexHost",e[e.RegexUrl=1]="RegexUrl",e[e.Exact=2]="Exact",e[e.SearchUrl=3]="SearchUrl",e[e.SearchDomain=4]="SearchDomain",e[e.SearchDomainSubdomain=5]="SearchDomainSubdomain",e[e.SearchDomainAndPath=6]="SearchDomainAndPath",e[e.SearchDomainSubdomainAndPath=7]="SearchDomainSubdomainAndPath"}(b||(b={})),function(e){e[e.Rules=0]="Rules",e[e.Subscriptions=1]="Subscriptions"}(x||(x={})),function(e){e[e.Http=0]="Http",e[e.SSL=1]="SSL",e[e.FTP=2]="FTP",e[e.SOCKS=3]="SOCKS"}(v||(v={}));class M{}M.PopupGetInitialData="Popup_GetInitialData",M.PopupChangeActiveProfile="Popup_ChangeActiveProfile",M.PopupChangeActiveProxyServer="Popup_ChangeActiveProxyServer",M.PopupToggleProxyForDomain="Popup_ToggleProxyForDomain",M.PopupAddDomainListToProxyRule="Popup_AddDomainListToProxyRule",M.PopupAddDomainListToIgnored="Popup_AddDomainListToIgnored",M.SettingsPageGetInitialData="SettingsPage_GetInitialData",M.SettingsPageGetInitialDataResponse="SettingsPage_GetInitialData_Response",M.SettingsPageSaveOptions="SettingsPage_SaveOptions",M.SettingsPageSaveProxyServers="SettingsPage_SaveProxyServers",M.SettingsPageSaveProxySubscriptions="SettingsPage_SaveProxySubscriptions",M.SettingsPageSaveSmartProfile="SettingsPage_SaveSmartProfile",M.SettingsPageDeleteSmartProfile="SettingsPage_DeleteSmartProfile",M.SettingsPageRestoreSettings="SettingsPage_RestoreSettings",M.SettingsPageMakeRequestSpecial="SettingsPage_MakeRequestSpecial",M.SettingsPageSkipWelcome="SettingsPage_SkipWelcome",M.SettingsPageFactoryReset="SettingsPage_FactoryReset",M.ProxyableRequestLog="Proxyable_RequestLog",M.ProxyableOriginTabRemoved="Proxyable_OriginTabRemoved",M.ProxyableGetInitialData="Proxyable_GetInitialData",M.ProxyableGetInitialDataResponse="Proxyable_GetInitialData_Response",M.ProxyableRemoveProxyableLog="Proxyable_RemoveProxyableLog",M.ProxyableToggleProxyableDomain="Proxyable_ToggleProxyableDomain",M.WebFailedRequestNotification="WebFailedRequest_Notification",M.DebugEnableDiagnostics="Debug_EnableDiagnostics",M.DebugGetDiagnosticsLogs="Debug_GetDiagnosticsLogs",function(e){e.none="none",e.autoDetect="autoDetect",e.system="system",e.manual="manual",e.autoConfig="autoConfig"}(P||(P={}));class E{}E.NextProxyServer="next-proxy-server",E.PreviousProxyServer="previous-proxy-server",E.BuiltinProfileNone="proxy-mode-none",E.BuiltinProfileSmart="proxy-mode-smart",E.BuiltinProfileAlways="proxy-mode-always",E.BuiltinProfileSystem="proxy-mode-system";class F{}class L{}class O{}class N{constructor(){this.themeType=T.Auto}}class B{}class z{}class G{}!function(e){e[e.NoneMatched=0]="NoneMatched",e[e.Special=1]="Special",e[e.ProxyPerOrigin=2]="ProxyPerOrigin",e[e.MatchedRule=3]="MatchedRule",e[e.Whitelisted=4]="Whitelisted",e[e.AlwaysEnabledByPassed=5]="AlwaysEnabledByPassed",e[e.AlwaysEnabledForcedByRules=6]="AlwaysEnabledForcedByRules"}(R||(R={})),function(e){e[e.NoProxy=0]="NoProxy",e[e.Special=1]="Special",e[e.ProxyPerOrigin=2]="ProxyPerOrigin",e[e.MatchedRule=3]="MatchedRule",e[e.AlwaysEnabled=4]="AlwaysEnabled",e[e.SystemProxyApplied=5]="SystemProxyApplied"}(w||(w={}));class H{get matchedRuleStatusName(){return R[this.matchedRuleStatus]}get proxifiedStatusName(){return w[this.proxifiedStatus]}get proxified(){return this.proxifiedStatus!=w.NoProxy}applyFromRule(e){e&&(this.rulePatternText=e.ruleText,this.ruleId=e.ruleId,this.ruleSource=e.compiledRuleSource,this.ruleHostName||(this.ruleHostName=e.hostName))}removeRuleInfo(){this.rulePatternText="",this.ruleId=null,this.ruleSource=null,this.ruleHostName=""}}class W{constructor(){this.product="SmartProxy",this.version="",this.configVersion="",this.syncHash="",this.proxyProfiles=Y(),this.activeProfileId=S.Direct,this.proxyServers=[],this.proxyServerSubscriptions=[],this.firstEverInstallNotified=!1,this.updateInfo=null}CopyFrom(e){this.options=new ee,this.options.CopyFrom(e.options);let t=[];for(const r of e.proxyProfiles){let e=new V;o.ProfileOperations.copySmartProfile(r,e),t.push(e)}this.proxyProfiles=t,this.activeProfileId=e.activeProfileId;let r=[];for(const t of e.proxyProfiles){let e=new re;e.CopyFrom(t),e.isValid()&&r.push(e)}this.proxyServers=r,this.defaultProxyServerId=e.defaultProxyServerId;let i=[];for(const t of e.proxyServerSubscriptions){let e=new le;e.CopyFrom(t),e.isValid()&&i.push(e)}this.proxyServerSubscriptions=i,this.firstEverInstallNotified=e.firstEverInstallNotified,this.version=e.version,this.syncHash=e.syncHash,this.configVersion=e.configVersion}}class ${}class j{}class q{constructor(){this.enabled=!0}}class V extends q{constructor(){super(...arguments),this.proxyRules=[],this.rulesSubscriptions=[]}}class Z extends q{}function K(e){let t=J(e);return t.builtin=!1,t}function J(e){switch(e){case g.Direct:return{builtin:!0,editable:!1,selectable:!0,supportsSubscriptions:!1,supportsProfileProxy:!1,customProxyPerRule:!1,canBeDisabled:!1,supportsRuleActionWhitelist:!1,defaultRuleActionIsWhitelist:null};case g.SmartRules:return{builtin:!0,editable:!0,selectable:!0,supportsSubscriptions:!0,supportsProfileProxy:!0,customProxyPerRule:!0,canBeDisabled:!0,supportsRuleActionWhitelist:!0,defaultRuleActionIsWhitelist:!1};case g.AlwaysEnabledBypassRules:return{builtin:!0,editable:!0,selectable:!0,supportsSubscriptions:!0,supportsProfileProxy:!0,customProxyPerRule:!0,canBeDisabled:!0,supportsRuleActionWhitelist:!0,defaultRuleActionIsWhitelist:!0};case g.SystemProxy:return{builtin:!0,editable:!1,selectable:!0,supportsSubscriptions:!1,supportsProfileProxy:!1,customProxyPerRule:!1,canBeDisabled:!1,supportsRuleActionWhitelist:!1,defaultRuleActionIsWhitelist:null};case g.IgnoreFailureRules:return{builtin:!0,editable:!1,selectable:!1,supportsSubscriptions:!1,supportsProfileProxy:!1,customProxyPerRule:!1,canBeDisabled:!1,supportsRuleActionWhitelist:!1,defaultRuleActionIsWhitelist:null};default:return null}}function Q(e){return s.api.i18n.getMessage(`settings_SmartProfileType_${g[e]}`)}function Y(){return[{profileId:S.Direct,profileType:g.Direct,profileTypeConfig:J(g.Direct),profileName:s.api.i18n.getMessage("popupNoProxy"),proxyRules:[],enabled:!0,rulesSubscriptions:[],profileProxyServerId:null},{profileId:S.SmartRules,profileType:g.SmartRules,profileTypeConfig:J(g.SmartRules),profileName:s.api.i18n.getMessage("popupSmartProxy"),proxyRules:[],enabled:!0,rulesSubscriptions:[],profileProxyServerId:null},{profileId:S.AlwaysEnabled,profileType:g.AlwaysEnabledBypassRules,profileTypeConfig:J(g.AlwaysEnabledBypassRules),profileName:s.api.i18n.getMessage("popupAlwaysEnable"),proxyRules:[],enabled:!0,rulesSubscriptions:[],profileProxyServerId:null},{profileId:S.SystemProxy,profileType:g.SystemProxy,profileTypeConfig:J(g.SystemProxy),profileName:s.api.i18n.getMessage("popupSystemProxy"),proxyRules:[],enabled:!0,rulesSubscriptions:[],profileProxyServerId:null}]}function X(e){switch(e){case g.Direct:return S.Direct;case g.SystemProxy:return S.SystemProxy;case g.SmartRules:return S.SmartRules;case g.AlwaysEnabledBypassRules:return S.AlwaysEnabled;case g.IgnoreFailureRules:return S.IgnoreRequestFailures;default:return""}}!function(e){e[e.Auto=0]="Auto",e[e.Light=1]="Light",e[e.Dark=2]="Dark"}(T||(T={}));class ee{constructor(){this.syncSettings=!1,this.syncActiveProfile=!0,this.syncActiveProxy=!0,this.detectRequestFailures=!0,this.displayFailedOnBadge=!0,this.displayAppliedProxyOnBadge=s.environment.initialConfig.displayTooltipOnBadge,this.displayMatchedRuleOnBadge=s.environment.initialConfig.displayTooltipOnBadge,this.refreshTabOnConfigChanges=!1,this.proxyPerOrigin=!0,this.enableShortcuts=!0,this.shortcutNotification=!0,this.themeType=T.Auto,this.themesDark=ee.defaultDarkThemeName}CopyFrom(e){null!=e.syncSettings&&(this.syncSettings=1==e.syncSettings),null!=e.syncProxyMode&&(this.syncActiveProfile=1==e.syncProxyMode),null!=e.syncActiveProfile&&(this.syncActiveProfile=1==e.syncActiveProfile),null!=e.syncActiveProxy&&(this.syncActiveProxy=1==e.syncActiveProxy),null!=e.detectRequestFailures&&(this.detectRequestFailures=1==e.detectRequestFailures),null!=e.displayFailedOnBadge&&(this.displayFailedOnBadge=1==e.displayFailedOnBadge),null!=e.displayAppliedProxyOnBadge&&(this.displayAppliedProxyOnBadge=1==e.displayAppliedProxyOnBadge),null!=e.displayMatchedRuleOnBadge&&(this.displayMatchedRuleOnBadge=1==e.displayMatchedRuleOnBadge),null!=e.refreshTabOnConfigChanges&&(this.refreshTabOnConfigChanges=1==e.refreshTabOnConfigChanges),null!=e.proxyPerOrigin&&(this.proxyPerOrigin=1==e.proxyPerOrigin),null!=e.enableShortcuts&&(this.enableShortcuts=1==e.enableShortcuts),null!=e.shortcutNotification&&(this.shortcutNotification=1==e.shortcutNotification),this.themeType=e.themeType||T.Auto,this.themesLight=e.themesLight,this.themesLightCustomUrl=e.themesLightCustomUrl,this.themesDark=e.themesDark,this.themesDarkCustomUrl=e.themesDarkCustomUrl}Equals(e){if(t(e.syncSettings,this.syncSettings))return!1;if(t(e.syncActiveProfile,this.syncActiveProfile))return!1;if(t(e.syncActiveProxy,this.syncActiveProxy))return!1;if(t(e.detectRequestFailures,this.detectRequestFailures))return!1;if(t(e.displayFailedOnBadge,this.displayFailedOnBadge))return!1;if(t(e.displayAppliedProxyOnBadge,this.displayAppliedProxyOnBadge))return!1;if(t(e.displayMatchedRuleOnBadge,this.displayMatchedRuleOnBadge))return!1;if(t(e.refreshTabOnConfigChanges,this.refreshTabOnConfigChanges))return!1;if(t(e.proxyPerOrigin,this.proxyPerOrigin))return!1;if(t(e.activeIncognitoProfileId,this.activeIncognitoProfileId))return!1;if(t(e.enableShortcuts,this.enableShortcuts))return!1;if(t(e.shortcutNotification,this.shortcutNotification))return!1;if(t(e.themeType,this.themeType))return!1;if(t(e.themesLight,this.themesLight))return!1;if(t(e.themesLightCustomUrl,this.themesLightCustomUrl))return!1;if(t(e.themesDark,this.themesDark))return!1;if(t(e.themesDarkCustomUrl,this.themesDarkCustomUrl))return!1;function t(e,t){return""===e&&(e=null),""===t&&(t=null),e!=t}return!0}}ee.defaultDarkThemeName="themes-cosmo-dark";class te{}class re extends te{constructor(){super(),this.name="",this.id=n.Utils.getNewUniqueIdString(),this.order=0}CopyFrom(e){this.id=e.id||n.Utils.getNewUniqueIdString(),this.order=e.order??0,this.name=e.name,this.host=e.host,this.port=+e.port,this.protocol=e.protocol,this.username=e.username,this.password=e.password,null!=e.proxyDNS&&(this.proxyDNS=1==e.proxyDNS),this.failoverTimeout=e.failoverTimeout>0?e.failoverTimeout:null,this.protocol||(this.protocol="HTTP")}isValid(){return!(!this.name||!this.protocol||!this.port||this.port<=0||this.port>65535||!this.host||!n.Utils.isValidHost(this.host))}}!function(e){e.DefaultGeneral="-1",e.ProfileProxy="-2"}(k||(k={}));class ie{constructor(){this.enabled=!0,this.whiteList=!1,this.ruleId=n.Utils.getNewUniqueIdNumber()}get ruleTypeName(){return y[this.ruleType]}get rule(){switch(+this.ruleType){case y.MatchPatternHost:case y.MatchPatternUrl:return this.rulePattern;case y.RegexHost:case y.RegexUrl:return this.ruleRegex;case y.DomainSubdomain:case y.DomainSubdomainAndPath:case y.DomainAndPath:case y.DomainExact:case y.SearchUrl:return this.ruleSearch;case y.Exact:return this.ruleExact}return""}get proxyName(){return this.whiteList?"-":this.proxy?this.proxy.name:this.proxyServerId==k.DefaultGeneral?s.api.i18n.getMessage("settingsRulesProxyDefault"):this.proxyServerId==k.ProfileProxy?s.api.i18n.getMessage("settingsRulesProxyFromProfile"):null}static assignArray(e){if(!e||!e.length)return[];let t=[];for(let r=0;r<e.length;r++){const i=e[r];let s=new ie;Object.assign(s,i),t.push(s)}return t}CopyFrom(e){this.ruleType=e.ruleType,null==e.ruleType&&(this.ruleType=y.DomainSubdomain),this.hostName=e.hostName||"",this.autoGeneratePattern=1==e.autoGeneratePattern,this.rulePattern=e.rulePattern,this.ruleRegex=e.ruleRegex,this.ruleExact=e.ruleExact,this.ruleSearch=e.ruleSearch,this.proxy=e.proxy,null!=e.enabled&&(this.enabled=1==e.enabled),null!=e.whiteList&&(this.whiteList=1==e.whiteList),this.proxy&&(i.Settings.validateProxyServer(this.proxy).success||(this.proxy=null)),e.pattern&&(this.rulePattern=e.rulePattern||e.pattern,this.hostName=e.hostName||e.source||e.sourceDomain,null==this.ruleType&&(this.ruleType=y.MatchPatternUrl),null==this.autoGeneratePattern&&(this.autoGeneratePattern=!1))}isValid(){return!(!this.rule||null==this.ruleType||!(this.ruleSearch&&this.hostName||this.ruleType!=y.DomainSubdomain&&this.ruleType!=y.DomainAndPath&&this.ruleType!=y.DomainSubdomainAndPath&&this.ruleType!=y.DomainExact&&this.ruleType!=y.SearchUrl)||!this.ruleExact&&this.ruleType==y.Exact||!(this.ruleRegex||this.ruleType!=y.RegexHost&&this.ruleType!=y.RegexUrl)||!(this.rulePattern||this.ruleType!=y.MatchPatternHost&&this.ruleType!=y.MatchPatternUrl))}}class se{constructor(){this.whiteList=!1}get ruleText(){switch(+this.compiledRuleType){case b.RegexHost:case b.RegexUrl:return this.regex.toString();case b.Exact:case b.SearchUrl:case b.SearchDomain:case b.SearchDomainAndPath:case b.SearchDomainSubdomain:case b.SearchDomainSubdomainAndPath:return this.search}return""}}class ne{getProxyRule(){let e=new ie;return e.enabled=!0,e.hostName=this.name||this.search,e.ruleRegex=this.regex,e.ruleSearch=this.search,e.ruleType=function(e){switch(e){case b.RegexHost:return y.RegexHost;case b.RegexUrl:return y.RegexUrl;case b.Exact:return y.Exact;case b.SearchUrl:return y.SearchUrl;case b.SearchDomain:return y.DomainExact;case b.SearchDomainSubdomain:return y.DomainSubdomain;case b.SearchDomainAndPath:return y.DomainAndPath;case b.SearchDomainSubdomainAndPath:return y.DomainSubdomainAndPath;default:return null}}(this.importedRuleType)??(this.regex?y.RegexUrl:y.DomainSubdomain),e}getSubscriptionProxyRule(){return this}}class oe{constructor(){this.WhitelistRules=[],this.Rules=[],this.WhitelistSubscriptionRules=[],this.SubscriptionRules=[]}}!function(e){e[e.WhitelistRules=0]="WhitelistRules",e[e.Rules=1]="Rules",e[e.WhitelistSubscriptionRules=2]="WhitelistSubscriptionRules",e[e.SubscriptionRules=3]="SubscriptionRules"}(_||(_={})),function(e){e[e.NoProxy=0]="NoProxy",e[e.CurrentProxy=1]="CurrentProxy",e[e.SelectedProxy=2]="SelectedProxy"}(C||(C={})),function(e){e[e.PlainText=0]="PlainText",e[e.Json=1]="Json"}(I||(I={}));class ae{static updateStats(e,t,r){let s=new Date;t?(e.lastStatus=!0,e.lastStatusMessage=null,e.lastTryDate=e.lastSuccessDate=s.toLocaleDateString()+" "+s.toLocaleTimeString()):(e.lastStatus=!1,e.lastStatusMessage=r?.message??r?.toString(),e.lastTryDate=s.toLocaleDateString()+" "+s.toLocaleTimeString()),e.lastStatusProxyServerName=i.Settings.active?.currentProxyServer?.name}static ToString(e){let t="Status: "+(e.lastStatus?"Success":"Fail");return t=e.lastStatus?s.api.i18n.getMessage("settingsSubscriptionStatsStatusSuccess"):s.api.i18n.getMessage("settingsSubscriptionStatsStatusFail"),e.lastStatus||(e.lastTryDate?t+=`\r\n${s.api.i18n.getMessage("settingsSubscriptionStatsLastTry")} ${e.lastTryDate}`:t+=`\r\n${s.api.i18n.getMessage("settingsSubscriptionStatsLastTry")} -`,e.lastStatusMessage&&(t+=`\r\n${s.api.i18n.getMessage("settingsSubscriptionStatsMessage")} ${e.lastStatusMessage}`)),e.lastStatusProxyServerName&&(t+=`\r\n${s.api.i18n.getMessage("settingsRulesGridColProxy")}: ${e.lastStatusProxyServerName}`),e.lastSuccessDate&&(t+=`\r\n${s.api.i18n.getMessage("settingsSubscriptionStatsLastSuccess")} ${e.lastSuccessDate}`),t}}class le{constructor(){this.enabled=!1,this.proxyProtocol=null,this.refreshRate=0,this.totalCount=0}CopyFrom(e){if(null!=e.name&&(this.name=e.name||""),null!=e.url&&(this.url=e.url||""),null!=e.enabled&&(this.enabled=1==e.enabled),null!=e.proxyProtocol&&(this.proxyProtocol=e.proxyProtocol||null),this.refreshRate=+e.refreshRate>0?+e.refreshRate:0,null!=e.obfuscation&&(this.obfuscation=e.obfuscation||null),this.format=I.PlainText,null!=e.format&&+e.format in I&&(this.format=+e.format),this.totalCount=+e.totalCount,null!=e.username&&(this.username=e.username||""),null!=e.password&&(this.password=e.password||""),this.applyProxy=C.CurrentProxy,null!=e.applyProxy&&+e.applyProxy in C&&(this.applyProxy=+e.applyProxy),this.proxies=[],null!=e.proxies&&Array.isArray(e.proxies))for(const r of e.proxies){var t=new re;t.CopyFrom(r),t.isValid()&&this.proxies.push(t)}this.stats=new ae,e.stats&&Object.assign(this.stats,e.stats)}isValid(){return!!(this.name&&this.url&&this.proxyProtocol&&this.format)}}!function(e){e[e.AutoProxy=0]="AutoProxy",e[e.SwitchyOmega=1]="SwitchyOmega"}(A||(A={}));class ue{constructor(){this.enabled=!1,this.refreshRate=0,this.totalCount=0,this.id=n.Utils.getNewUniqueIdString()}CopyFrom(e){null!=e.name&&(this.name=e.name||""),null!=e.url&&(this.url=e.url||""),null!=e.enabled&&(this.enabled=1==e.enabled),this.refreshRate=+e.refreshRate>0?+e.refreshRate:0,null!=e.obfuscation&&(this.obfuscation=e.obfuscation||null),this.format=A.AutoProxy,null!=e.format&&+e.format in I&&(this.format=+e.format),this.totalCount=+e.totalCount,null!=e.username&&(this.username=e.username||""),null!=e.password&&(this.password=e.password||""),this.applyProxy=C.CurrentProxy,null!=e.applyProxy&&+e.applyProxy in C&&(this.applyProxy=+e.applyProxy),this.proxyRules=[],this.whitelistRules=[],null!=e.proxyRules&&Array.isArray(e.proxyRules)&&(this.proxyRules=e.proxyRules),null!=e.whitelistRules&&Array.isArray(e.whitelistRules)&&(this.whitelistRules=e.whitelistRules),this.stats=new ae,e.stats&&Object.assign(this.stats,e.stats)}isValid(){return!(!this.name||!this.url)}}class ce{constructor(){this.url=null,this.obfuscation=null,this.format=A.AutoProxy,this.applyProxy=C.CurrentProxy,this.username=null,this.password=null}}class de{constructor(){this.updateIsAvailable=!1,this.isBrowserSpecific=!1}}!function(e){e[e.None=0]="None",e[e.Proxified=1]="Proxified",e[e.Whitelisted=2]="Whitelisted"}(D||(D={}))},"./src/lib/Debug.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{Debug:()=>s,DiagDebug:()=>i});var i=null;class s{static enable(){this.enabled=!0}static enableDiagnostics(e=!1){this.enabled=!0,null==i&&(i=new n),i.consoleOutput=e,i.register()}static disable(){this.enabled=!1}static disableDiagnostics(){i?.unregister(),i=null}static disableAll(){this.disable(),this.disableDiagnostics()}static isEnabled(){return this.enabled}static log(e,...t){this.enabled&&(console.log.apply(null,arguments),i&&!i.consoleOutput&&i.log.apply(i,arguments))}static info(e,...t){this.enabled&&(console.info.apply(null,arguments),i&&!i.consoleOutput&&i.info.apply(i,arguments))}static trace(e,...t){this.enabled&&(console.trace.apply(null,arguments),i&&!i.consoleOutput&&i.trace.apply(i,arguments))}static warn(e,...t){console.warn.apply(null,arguments),i&&!i.consoleOutput&&i.warn.apply(i,arguments)}static error(e,...t){console.error.apply(null,arguments),i&&!i.consoleOutput&&i.error.apply(i,arguments)}}s.enabled=!0;class n{constructor(){this.enabled=!0,this.consoleOutput=!1,this.logs=[]}clear(){this.logs=[]}getDiagLogs(){return JSON.stringify(this.logs,null," ")}register(){globalThis.SmartProxyGetDiagLogs=()=>this.getDiagLogs(),globalThis.DiagDebug=this}unregister(){globalThis.SmartProxyGetDiagLogs=void 0}log(e,...t){this.enabled&&this.addToLog("log",e,arguments)}error(e,...t){this.enabled&&this.addToLog("error",e,arguments)}info(e,...t){this.enabled&&this.addToLog("info",e,arguments)}warn(e,...t){this.enabled&&this.addToLog("warn",e,arguments)}trace(e,...t){this.enabled&&this.addToLog("trace",e,arguments)}addToLog(e,t,r){let i=`${a(new Date)} [${e}] `+t;for(let e=1;e<r.length;e++){const t=r[e];i+=null==t?" NULL":"object"==typeof t?" "+JSON.stringify(t):" "+t.toString()}this.logs.push(i),this.consoleOutput&&console.log("Diagnostics",i)}}const o=(e,t)=>String(e).padStart(t,"0"),a=e=>`${e.getHours()}:${o(e.getMinutes(),2)}:${o(e.getSeconds(),2)}.${o(e.getMilliseconds(),3)}`},"./src/lib/External.ts":(e,t,r)=>{"use strict";var i,s,n;r.r(t),r.d(t,{bootstrap:()=>i,jQuery:()=>s,messageBox:()=>n}),"undefined"!=typeof window?(i=window.bootstrap,s=window.jQuery,n=window.messageBox):(i={},s={},n={})},"./src/lib/LiteEvent.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{LiteEvent:()=>i});class i{constructor(){this.handlers=[]}on(e){this.handlers.push(e)}off(e){this.handlers=this.handlers.filter((t=>t!==e))}trigger(e){this.handlers.slice(0).forEach((t=>t(e)))}expose(){return this}}},"./src/lib/PolyFill.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{PolyFill:()=>s});var i=r("./src/lib/environment.ts");class s{static lastError(){return i.environment.chrome,i.api.runtime.lastError}static onProxyError(){return i.environment.chrome?i.api.proxy.onProxyError:i.api.proxy.onError?i.api.proxy.onError:i.api.proxy.onProxyError}static tabsGet(e,t,r){i.environment.chrome?i.api.tabs.get(e,(e=>{const i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.tabs.get(e).then(t,r)}static tabsGetCurrent(e,t){i.environment.chrome?i.api.tabs.getCurrent((r=>{const i=s.lastError();i?t&&t(i):e&&e(r)})):i.api.tabs.getCurrent().then(e,t)}static tabsRemove(e,t,r){i.environment.chrome?i.api.tabs.remove(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.tabs.remove(e).then(t,r)}static tabsReload(e,t,r,n){i.environment.chrome?i.api.tabs.reload(e,n,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.tabs.reload(e,n).then(t,r)}static tabsQuery(e,t,r){i.environment.chrome?i.api.tabs.query(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.tabs.query(e).then(t,r)}static tabsCreate(e,t,r){i.environment.chrome?i.api.tabs.create(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.tabs.create(e).then(t,r)}static runtimeSendMessage(e,t,r,n,o){if(i.environment.chrome)null!=n&&delete n.toProxyScript,i.api.runtime.sendMessage(o,e,n,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)}));else{let s=i.api.runtime.sendMessage(o,e,n);(t||r)&&s.then(t,r)}}static managementGetSelf(e,t){i.environment.chrome?i.api.management.getSelf((r=>{let i=s.lastError();i?t&&t(i):e&&e(r)})):i.api.management.getSelf().then(e,t)}static storageLocalGet(e,t,r){i.environment.chrome?i.api.storage.local.get(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.storage.local.get(e).then(t,r)}static storageLocalSet(e,t,r){i.environment.chrome?i.api.storage.local.set(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.storage.local.set(e).then(t,r)}static storageLocalRemove(e,t,r){i.environment.chrome?i.api.storage.local.remove(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.storage.local.remove(e).then(t,r)}static storageSyncGet(e,t,r){i.environment.chrome?i.api.storage.sync.get(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.storage.sync.get(e).then(t,r)}static storageSyncSet(e,t,r){i.environment.chrome?i.api.storage.sync.set(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.storage.sync.set(e).then(t,r)}static runtimeGetBrowserInfo(e,t){i.environment.chrome?t&&t({message:"getBrowserInfo is not implemented"}):i.api.runtime.getBrowserInfo().then(e,t)}static runtimeOpenOptionsPage(e,t){i.environment.chrome?i.api.runtime.openOptionsPage((r=>{let i=s.lastError();i?t&&t(i):e&&e(r)})):i.api.runtime.openOptionsPage().then(e,t)}static browserActionSetIcon(e,t,r){i.environment.chrome?i.api.browserAction.setIcon(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.browserAction.setIcon&&i.api.browserAction.setIcon(e).then(t,r)}static browserActionSetBadgeText(e,t,r){i.environment.chrome?i.api.browserAction.setBadgeText(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.browserAction.setBadgeText&&i.api.browserAction.setBadgeText(e).then(t,r)}static browserActionSetBadgeBackgroundColor(e,t,r){i.environment.chrome?i.api.browserAction.setBadgeBackgroundColor(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.browserAction.setBadgeBackgroundColor&&i.api.browserAction.setBadgeBackgroundColor(e).then(t,r)}static browserGetProxySettings(e,t){i.environment.chrome?i.api.proxy.settings.get((r=>{let i=s.lastError();i?t&&t(i):e&&e(r)})):i.api.proxy.settings.get({}).then(e,t)}static browserSetProxySettings(e,t,r){i.environment.chrome?i.api.proxy.settings.set(e,(e=>{let i=s.lastError();i?r&&r(i):t&&t(e)})):i.api.proxy.settings.set(e).then(t,r)}static browserCommandsGetAll(e,t){i.environment.chrome?i.api.commands.getAll((r=>{let i=s.lastError();i?t&&t(i):e&&e(r)})):i.api.commands&&i.api.commands.getAll().then(e,t)}static browserNotificationsCreate(e,t,r,n){i.environment.chrome?i.api.notifications.create(e,t,(e=>{let t=s.lastError();t?n&&n(t):r&&r(e)})):i.api.notifications.create(e,t).then(r,n)}static extensionGetURL(e){return i.environment.chrome?i.api.extension.getURL?i.api.extension.getURL(e):i.api.runtime.getURL(e):i.api.extension.getURL(e)}static getExtensionVersion(e){i.environment.extensionVersion?e?.(i.environment.extensionVersion):s.managementGetSelf((t=>{i.environment.extensionVersion=t.version,e?.(i.environment.extensionVersion)}),null)}}s.runtimeGetBrowserInfo((e=>{i.environment.version=parseInt(e.version)||1,i.environment.name=e.name}))},"./src/lib/ProxyImporter.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{ProxyImporter:()=>u});var i=r("./src/lib/Utils.ts"),s=r("./src/lib/environment.ts"),n=r("./src/core/definitions.ts"),o=r("./src/lib/Debug.ts"),a=r("./src/core/Settings.ts"),l=r("./src/core/ProxyEngineSpecialRequests.ts");const u={readFromServer(e,t,r){if(!e||!e.url)return void(r&&r());if(!t)throw"onSuccess callback is mandatory";null!==e.applyProxy&&l.ProxyEngineSpecialRequests.setSpecialUrl(e.url,e.applyProxy);let i=new XMLHttpRequest;if(i.open("GET",e.url),e.username){let t=atob(e.password);i.setRequestHeader("Authorization","Basic "+btoa(e.username+":"+t))}i.onload=()=>{var s;200===i.status?((s=i.responseText)||r&&r(),u.importText(s,null,!1,null,(e=>{e.success?t&&t(e):r&&r(e)}),(e=>{r&&r(e)}),e)):r&&r(i.status)},i.send()},importText(e,t,r,o,a,l,c){if(t||e)if(e)d(e,c);else{let e=new FileReader;e.onerror=e=>{l&&l(e)},e.onload=t=>{d(e.result,c)},e.readAsText(t)}else l&&l();function d(e,t){let c;if(c=t&&t.format==n.ProxyServerSubscriptionFormat.Json?u.parseJson(e,t):u.parseText(e,t),null==c)return void(l&&l());let d=i.Utils.removeDuplicatesFunc(c,((e,t)=>e.host==t.host&&e.port==t.port&&e.username==t.username&&e.password==t.password));if(r){o||(o=[]);let e=o.slice(),t=0;for(let r of d)o.some((e=>e.host==r.host&&e.port==r.port&&e.username==r.username&&e.password==r.password))||(e.push(r),t++);let r=s.api.i18n.getMessage("importerImportProxySuccess").replace("{0}",t.toString()).replace("{1}",d.length.toString());a&&a({success:!0,message:r,result:e})}else{let e=s.api.i18n.getMessage("importerImportProxySuccess").replace("{0}",d.length.toString()).replace("{1}",c.length.toString());a&&a({success:!0,message:e,result:d})}}},parseText:(e,t)=>{if(!e||"string"!=typeof e)return null;const r=/((?:[A-Za-z0-9-]+\.)+[A-Za-z0-9]{1,6})(?:(?::+|[\t\s,]+)(\d{2,5}))?(?:[\t\s]+\[(\w+)\][\t\s]+\[([\w\s\:\.-]+)\](?:[\t\s]+\[(.+)\][\t\s]+\[(.+)\])?)?/i;if(t&&t.obfuscation)try{"base64"==t.obfuscation.toLowerCase()&&(e=atob(e))}catch(e){return null}let i=e.split(/(\r|\n)/),s=[],o="HTTP";t&&t.proxyProtocol&&(o=t.proxyProtocol);for(let e of i){if(e.length<4)continue;let t=r.exec(e);if(!t)continue;let[,i,a,l,u,c,d]=t;if(!i||!a)continue;l=l?l.toUpperCase():o;let p=new n.ProxyServer;p.name=u||`${i}:${a}`,p.id=p.name,p.host=i,p.port=parseInt(a),p.protocol=l,p.username=c,p.password=d,s.push(p)}return s},parseJson:(e,t)=>{if(t&&t.obfuscation)try{"base64"==t.obfuscation.toLowerCase()&&(e=atob(e))}catch(e){return null}let r=[];try{let t=JSON.parse(e);if(!t)return null;Array.isArray(t)||(t=[t]);for(const e of t){let t=new n.ProxyServer;t.name=e.name||(e.country?`${e.country} - `:"")+`${e.ip}:${e.port}`,t.id=t.name,t.host=e.ip,t.port=parseInt(e.port),t.protocol=e.protocol,t.username=e.username,t.password=e.password,a.Settings.validateProxyServer(t).success&&r.push(t)}return r}catch(t){return o.Debug.log("ProxyImporter.parseJson failed",t,e),null}}}},"./src/lib/RuleImporter.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{RuleImporter:()=>l});var i=r("./src/lib/Utils.ts"),s=r("./src/lib/environment.ts"),n=r("./src/core/definitions.ts"),o=r("./src/core/ProxyEngineSpecialRequests.ts"),a=r("./src/lib/RuleImporterSwitchy.js");const l={readFromServerAndImport(e,t,r){if(!e||!e.url)return void(r&&r());if(!t)throw"onSuccess callback is mandatory";null!==e.applyProxy&&o.ProxyEngineSpecialRequests.setSpecialUrl(e.url,e.applyProxy);let i={method:"GET",headers:void 0};if(e.username){let t=atob(e.password);i.headers={Authorization:"Basic "+btoa(e.username+":"+t)}}fetch(e.url,i).then((e=>e.text())).then((i=>{var s;(s=i)?l.importRulesBatch(e,s,null,!1,null,(e=>{e.success?t&&t(e):r&&r(e)}),(e=>{r&&r(e)})):r&&r()})).catch((e=>{r&&r(e)}))},importRulesBatch(e,t,r,o,a,l,c){if(r||t)if(t)try{d(t,e)}catch(e){c&&c(e)}else{let t=new FileReader;t.onerror=e=>{c&&c(e)},t.onload=r=>{let i=t.result;try{d(i,e)}catch(e){c&&c(e)}},t.readAsText(r)}else c&&c();function d(e,t){let r;if("base64"==t.obfuscation?.toLowerCase()&&(e=i.Utils.b64DecodeUnicode(e)),t&&t.format==n.ExternalRulesFormat.AutoProxy){if(!u.GFWList.detect(e,!1))return void(c&&c());r=u.GFWList.parse(e)}else{if(!t||t.format!=n.ExternalRulesFormat.SwitchyOmega)return void(c&&c());{let d=u.Switchy.parseAndCompile(e);if(!d||!d.compiled)return void(c&&c());r={blackList:u.Switchy.convertToProxyRule(d.compiled),whiteList:[]}}}if(o){function p(e,t=!1){let r=[];for(let i of e){let e=i.getProxyRule();a.some((r=>r.ruleType==e.ruleType&&r.ruleSearch==e.ruleSearch&&r.ruleRegex==e.ruleRegex&&(!t||t&&r.whiteList)))||r.push(i)}return r}a||(a=[]),r.blackList=r.blackList||[],r.whiteList=r.whiteList||[];let m=r.blackList.length+r.whiteList.length;r.blackList=p(r.blackList),r.whiteList=p(r.whiteList,!0);let f=r.blackList.length+r.whiteList.length,h=s.api.i18n.getMessage("importerImportSuccess").replace("{0}",f.toString()).replace("{1}",m.toString());l&&l({success:!0,message:h,rules:r})}else{let g=s.api.i18n.getMessage("importerImportRulesSuccess").replace("{0}",r.blackList.length).replace("{1}",r.whiteList.length);l&&l({success:!0,message:g,rules:r})}}},importAutoProxy(e,t,r,n,o){if(!e)return void(o&&o());let a=new FileReader;a.onerror=e=>{o&&o(e)},a.onload=e=>{let l=a.result;try{let e=u.AutoProxy.parse(l),o=[];for(let t of e){let e=u.AutoProxy.convertAutoProxyRule(t.condition.pattern,t.condition.conditionType);e.success&&o.push({pattern:e.pattern,source:e.source,enabled:!0})}if(o=i.Utils.removeDuplicates(o,"pattern"),t){r||(r=[]);let t=r.slice(),i=0;for(let e of o)r.some((t=>{t.pattern,e.pattern}))||(t.push(e),i++);let a=s.api.i18n.getMessage("importerImportSuccess").replace("{0}",i.toString()).replace("{1}",e.length.toString());n&&n({success:!0,message:a,result:t})}else{let t=s.api.i18n.getMessage("importerImportSuccess").replace("{0}",o.length.toString()).replace("{1}",e.length.toString());n&&n({success:!0,message:t,result:o})}}catch(e){o&&o(e)}},a.readAsText(e)}},u={AutoProxy:{magicPrefix:"W0F1dG9Qcm94",detect:(e,t=!0)=>!(!t||!i.Utils.strStartsWith(e,u.AutoProxy.magicPrefix))||!!i.Utils.strStartsWith(e,"[AutoProxy"),preprocess:e=>(i.Utils.strStartsWith(e,u.AutoProxy.magicPrefix)&&(e=i.Utils.b64DecodeUnicode(e)),e),parse(e,t,r){let i,s,n,o,a,l,u,c,d,p;for(a=[],s=[],p=e.split(/\n|\r/),c=0,d=p.length;c<d;c++)n=p[c],n=n.trim(),0!==n.length&&"!"!==n[0]&&"["!==n[0]&&(u=n,l=t,o=a,"@"===n[0]&&"@"===n[1]&&(l=r,o=s,n=n.substring(2)),i="/"===n[0]?{conditionType:"UrlRegexCondition",pattern:n.substring(1,n.length-1)}:"|"===n[0]?"|"===n[1]?{conditionType:"HostWildcardCondition",pattern:"*."+n.substring(2),cleanCondition:n.substring(2)}:{conditionType:"UrlWildcardCondition",pattern:n.substring(1)+"*",cleanCondition:n.substring(1)}:n.indexOf("*")<0?{conditionType:"KeywordCondition",pattern:n,cleanCondition:n}:{conditionType:"UrlWildcardCondition",pattern:"http://*"+n+"*",cleanCondition:n},o.push({condition:i,profileName:l,source:u}));return s.concat(a)},convertAutoProxyRule(e,t){let r="",i="";switch(t){case"KeywordCondition":"."===e[0]&&(e=e.substring(1)),r=e,e.endsWith("/")&&(r=e.substring(0,e.length-2)),i=`*://*.${r}/*`;break;case"HostWildcardCondition":"."===e[0]&&(e=e.substring(1)),"."===(e=(e=e.replace(/\*/g,"")).replace(/([.])\1+/g,"."))[0]&&(e=e.substring(1)),r=e,e.endsWith("/")&&(r=e.substring(0,e.length-2)),i=`*://*.${r}/*`;break;case"UrlWildcardCondition":if("*"===e[0]&&(e=e.substring(1)),"."===e[0]&&(e=e.substring(1)),-1!==e.indexOf("*")){let t=e;if(-1!==t.indexOf("://*.")&&(t=t.replace("//*.","://")),t.endsWith("*")&&(e=e.substring(0,e.length-2),t=t.substring(0,e.length-2)),-1!==t.indexOf("*")&&(t=e.replace(/\/\*\//g,"/"),-1!==t.indexOf("*")))return{success:!1}}r=e,e.endsWith("/")&&(r=e.substring(0,e.length-2)),i=-1!==r.indexOf("://")?`${r}/*`:`*://*.${r}/*`;break;case"UrlRegexCondition":return{success:!1}}return{success:!0,source:r,pattern:i,toString:()=>`[${r} , ${i}]`}}},GFWList:{detect:(e,t=!0)=>!(!t||!i.Utils.strStartsWith(e,u.AutoProxy.magicPrefix))||!!i.Utils.strStartsWith(e,"[AutoProxy"),parse(e){e=e.trim();let t=[],r=[],i=[];for(var s of e.split(/\n|\r/))if((s=s.trim())[0]&&"!"!=s[0]&&"["!=s[0]){var n=u.GFWList.convertLineRegex(s);n&&(i.push(s+"\n"+n.regex+" \t\t Name:"+n.name+"\n\n"),s.startsWith("@@")?t.push(n):r.push(n))}return{_debug:i,whiteList:t,blackList:r}},convertLineRegex_OLD:e=>(e.startsWith("@@")&&(e=e.substring(2)),e.startsWith("/")&&e.endsWith("/")?{regex:e=e.substring(1,e.length-1),name:"Regex",makeNameRandom:!0}:(e=(e=e.replace("*",".+").replace("?","\\?")).replace("(","\\(").replace(")","\\)")).startsWith("||")?{regex:`^(?:https?|ftps?|wss?):\\/\\/(?:.+\\.)?${e=(e=e.substring(2)).replace(".","\\.")}(?:[?#\\/].*)?$`,name:e,makeNameRandom:!1}:e.startsWith("|")?{regex:`^${e=(e=e.substring(1)).replace(".","\\.")}.*`,name:e,makeNameRandom:!1}:e.startsWith(".")?{regex:`://(?:.+\\.)?${e=(e=e.substring(1)).replace(".","\\.")}(?:[?#\\/].*)?$`,name:e,makeNameRandom:!1}:e.endsWith("|")?{regex:`.*${e=(e=e.substring(0,e.length-1)).replace(".","\\.")}$`,name:e,makeNameRandom:!1}:{regex:`.*${e=e.replace(".","\\.")}(?:[.?#\\/].*)?$`,name:e,makeNameRandom:!1}),convertLineRegex(e){if(e.startsWith("@@")&&(e=e.substring(2)),e.startsWith("/")&&e.endsWith("/")){e=e.substring(1,e.length-1);let t=new n.ImportedProxyRule;return t.regex=e,t.name="Regex-"+e.replace(/[\d\\d]*\W*/g,""),t.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t}let t=e.includes("*")||e.includes("(");function r(){e=(e=(e=e.replace("*",".+").replace("?","\\?")).replace("(","\\(").replace(")","\\)")).replace(".","\\.")}if(e.startsWith("||")){if(e=e.substring(2),t){r();let t=new n.ImportedProxyRule;return t.regex=`^(?:https?|ftps?|wss?):\\/\\/(?:.+\\.)?${e}(?:[?#\\/].*)?$`,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t}{let t=new n.ImportedProxyRule;return t.search=e,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.SearchDomainSubdomain,t}}if(e.startsWith("|")){if(e=e.substring(1),t){r();let t=new n.ImportedProxyRule;return t.regex=`^${e}.*`,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t}{let t=new n.ImportedProxyRule;return t.search=e,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.SearchUrl,t}}if(e.endsWith("|")){e=e.substring(0,e.length-1),r();let t=new n.ImportedProxyRule;return t.regex=`.*${e}$`,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t}if(e.startsWith(".")){if(e=e.substring(1),t){r();let t=new n.ImportedProxyRule;return t.regex=`://(?:.+\\.)?${e}(?:[?#\\/].*)?$`,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t}{let t=new n.ImportedProxyRule;return t.search=e,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.SearchDomainSubdomainAndPath,t}}if(t){r();let t=new n.ImportedProxyRule;return t.regex=`.*${e}(?:[.?#\\/].*)?$`,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t}{let t=new n.ImportedProxyRule;return t.search=e,t.name=e,t.importedRuleType=n.CompiledProxyRuleType.SearchDomainAndPath,t}}},Switchy:{parseAndCompile(e){let t=a.RuleImporterSwitchy.switchy,r=a.RuleImporterSwitchy.compiler;var i=t.getParser(e),s=t[i];if(!s)return null;var n=s(e,"profile-name","default-profile-name");return r.compile({defaultProfileName:"default-profile-name",profileName:"profile-name",profileType:"SwitchProfile",rules:n})},convertToSubscriptionProxyRule(e){if(!e||!e.length)return[];let t=[];for(const r of e){if(!r.args||1!=r.args.length)continue;let e,i=r.args[0];if(e=r.expression instanceof RegExp?r.expression.source:r.expression,"host"==i){let i=new n.ImportedProxyRule;i.name=r.source,i.regex=e,i.importedRuleType=n.CompiledProxyRuleType.RegexHost,t.push(i)}else if("url"==i){let i=new n.ImportedProxyRule;i.name=r.source,i.regex=e,i.importedRuleType=n.CompiledProxyRuleType.RegexUrl,t.push(i)}}return t},convertToProxyRule(e){if(!e||!e.length)return[];let t=[];for(const r of e){if(!r.args||1!=r.args.length)continue;let e,i=r.args[0];e=r.expression instanceof RegExp?r.expression.source:r.expression;let s=new n.ImportedProxyRule;s.name=r.source,s.regex=e,s.search=null,"host"==i?s.importedRuleType=n.CompiledProxyRuleType.RegexHost:"url"==i&&(s.importedRuleType=n.CompiledProxyRuleType.RegexUrl),t.push(s)}return t}}}},"./src/lib/Utils.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{Utils:()=>n});var i=r("./src/lib/environment.ts"),s=r("./node_modules/pako/dist/pako.esm.mjs");class n{static getNewUniqueIdNumber(){return+Math.random().toString(10).substr(2+10*Math.random())}static getNewUniqueIdString(){return(Math.random().toString(36).substr(2,5)+Date.now().toString(36)).toLowerCase()}static encodeSyncData(e){let t=JSON.stringify(e),r=(new TextEncoder).encode(t),o=s.deflateRaw(r,{});o=n.b64EncodeUnicode(o);let a={};return function(e,t){let r=i.environment.storageQuota.syncQuotaBytesPerItem();if(r>0){let i=n.chunkString(e,r);t.chunkLength=i.length;for(let e=0;e<i.length;e++)t["c"+e]=i[e]}else t.c0=e,t.chunkLength=1}(o,a),a}static decodeSyncData(e){if(!e||!e.chunkLength)return null;let t=[];for(let r=0;r<e.chunkLength;r++)t.push(e["c"+r]);let r=t.join(""),i=n.b64DecodeUnicodeArray(r),o=s.inflateRaw(i),a=(new TextDecoder).decode(o);return JSON.parse(a)}static removeDuplicates(e,t){return e.filter(((e,r,i)=>i.findIndex((r=>r[t]===e[t]))===r))}static removeDuplicatesFunc(e,t){return e.filter(((e,r,i)=>i.findIndex((r=>t(r,e)))===r))}static reverseString(e){return e.split("").reverse().join("")}static strStartsWith(e,t){return e.substr(0,t.length)===t}static chunkString(e,t){let r=0,i=t;i>e.length&&(i=e.length);let s=new Array;for(;s.push(e.slice(r,i)),!(i>=e.length);)r+=t,i+=t,i>e.length&&(i=e.length);return s}static b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,((e,t)=>String.fromCharCode(+("0x"+t)))))}static b64DecodeUnicode(e){return decodeURIComponent(atob(e).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))}static b64DecodeUnicodeArray(e){let t=n.b64DecodeUnicode(e);return"string"==typeof t?new Uint16Array(t.split(",")):t}static isValidHost(e){return!(!e||n.invalidHostSchemas.indexOf(e)>=0)}static isValidUrl(e){try{const t=new URL(e);return!(n.invalidHostSchemas.indexOf(t.protocol)>=0)}catch(e){return!1}}static isUrlHttps(e){try{return!!new URL(e).protocol.toLowerCase().startsWith("https")}catch(e){return!1}}static isUrlLocal(e){try{const t=new URL(e);return n.invalidHostSchemas.indexOf(t.protocol)>=0}catch(e){return!1}}static urlHasSchema(e){return!!e&&!!e.includes(":/")}static extractHostFromInvalidUrl(e){try{if(e.includes(":/"))try{return new URL(e),n.extractHostFromUrl(e)}catch{}let t="http://"+e;return n.extractHostFromUrl(t)}catch(e){return null}}static extractHostNameFromInvalidUrl(e){try{if(e.includes(":/"))try{return new URL(e),n.extractHostNameFromUrl(e)}catch{}let t="http://"+e;return n.extractHostNameFromUrl(t)}catch(e){return null}}static extractHostFromUrl(e){try{const t=new URL(e);return n.invalidHostSchemas.indexOf(t.protocol)>=0?null:t.host}catch(e){return null}}static extractHostNameFromUrl(e){try{const t=new URL(e);return n.invalidHostSchemas.indexOf(t.protocol)>=0?null:t.hostname}catch(e){return null}}static extractSubdomainListFromUrl(e){let t=n.extractHostFromUrl(e);return null===t?[]:n.extractSubdomainListFromHost(t)}static extractSubdomainListFromHost(e){if(!e)return null;let t=e.split(".");if(t.length<=2)return[e];if(4==t.length&&+t[3].split(":")[0]>=0)return[e];let r=new Array;for(let e=0;e<t.length&&e!=t.length-1;e++){let i=t.slice(e,t.length);r.push(i.join("."))}r.reverse();let i=r[0];return i&&-1!=n.IgnoreDomainExtensions.indexOf(i)&&r.splice(0,1),r}static hostToMatchPattern(e,t=!0){return e.indexOf(":")>-1?e:t?`*://*.${e}/*`:`*.${e}/*`}static removeSchemaFromUrl(e){if(null==e)return e;let t=(new URL(e).protocol+"//").length;return e.substring(t,e.length)}static matchPatternToRegExp(e,t=!0,r=!1){let i;if(i=/^(?:(\*|https?|file|ftp|app|wss?):\/\/([^/:]+)(?:\:(\d+))?\/?(.*))$/i,"<all_urls>"===e)return null;t||e.includes("://")||(e="http://"+e);const s=i.exec(e);if(!s)return null;const[,n,o,a,l]=s;return t?new RegExp("^(?:"+("*"===n?"(?:https?|ftp|wss?)":escape(n))+":\\/\\/"+("*"===o?"[^\\/]*":escape(o).replace(/^\*\./g,"(?:(?:[^\\/]+)\\.|(?:[^\\/]+){0})"))+(a?"\\:"+escape(a):"")+(l?"*"==l?"(?:\\/.*)?":"\\/"+escape(l).replace(/\*/g,".*"):"\\/?")+")$",r?"i":void 0):new RegExp("^(?:"+("*"===o?"[^\\/]*":escape(o).replace(/^\*\./g,"(?:(?:[^\\/]+)\\.|(?:[^\\/]+){0})"))+(a?"\\:"+escape(a):"")+(l?"*"==l?"(?:\\/.*)?":"\\/"+escape(l).replace(/\*/g,".*"):"\\/?")+")$",r?"i":void 0)}static deepClone(e){return JSON.parse(JSON.stringify(e))}static deepCloneObject(e){return JSON.parse(JSON.stringify(e))}static shallowCopyProperties(e,t){Object.getOwnPropertyNames(t).forEach((r=>{const i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i)}))}}n.invalidHostSchemas=["moz-extension:","chrome-extension:","about:","data:","chrome:","opera:","edge:"],n.IgnoreDomainExtensions=["000.nl","999.nl","aa.no","ab.ca","ab.se","abo.pa","ac.ae","ac.at","ac.be","ac.be","ac.cn","ac.com","ac.cr","ac.cy","ac.fj","ac.fk","ac.gn","ac.id","ac.il","ac.im.in","ac.in","ac.ir","ac.jp","ac.mw","ac.nz","ac.pa","ac.ru","ac.rw","ac.se","ac.th","ac.tj","ac.tz","ac.ug","ac.uk","ac.vn","ac.yu","ac.zm","ac.zw","act.au","ad.jp","adm.br","adult.ht","adv.br","aero.mv","agr.br","ah.cn","ah.no","ak.us","al.us","alt.za","am.br","ar.us","army.mil","arq.br","art.br","art.do","art.dz","art.ht","art.pl","asn.au","asn.au","asn.lv","asso.dz","asso.fr","asso.ht","asso.mc","ato.br","av.tr","az.us","bbs.tr","bc.ca","bd.se","bel.tr","bio.br","biz.az","biz.cy","biz.et","biz.fj","biz.mv","biz.nr","biz.om","biz.pk","biz.pl","biz.pr","biz.tj","biz.tr","biz.tt","biz.vn","bj.cn","bl.uk","bmd.br","bu.no","c.se","ca.us","cim.br","city.za","ck.ua","club.tw","cn.ua","cng.br","cnt.br","co.ag","co.ao","co.at","co.bw","co.cc.cd","co.ck","co.cr","co.fk","co.gg","co.hu","co.id","co.il","co.im","co.in","co.ir","co.je","co.jp","co.kr","co.ls","co.ma","co.mu","co.mw","co.nz","co.om","co.rw","co.th","co.tj","co.tt","co.ug","co.uk","co.us","co.ve","co.yu","co.za","co.zm","co.zw","com.ac","com.af","com.ag","com.ai","com.al","com.an","com.ar","com.au","com.aw","com.ax","com.az","com.bb","com.bd","com.bm","com.bn","com.bo","com.br","com.bs","com.bt","com.cd","com.ch","com.cn","com.co","com.cu","com.cy","com.dm","com.do","com.dz","com.ec","com.ee","com.eg","com.es","com.et","com.fj","com.fr","com.ge","com.gh","com.gi","com.gn","com.gp","com.gr","com.hk","com.hn","com.hr","com.ht","com.jm","com.jo","com.kh","com.kw","com.ky","com.kz","com.lb","com.lc","com.li","com.lk","com.lr","com.lv","com.ly","com.mg","com.mk","com.mo","com.mt","com.mu","com.mv","com.mw","com.mx","com.my","com.ng","com.ni","com.np","com.nr","com.om","com.pa","com.pe","com.pf","com.pg","com.ph","com.pk","com.pl","com.pr","com.ps","com.pt","com.py","com.ro","com.ru","com.rw","com.sa","com.sb","com.sc","com.sd","com.sg","com.sv","com.sy","com.tj","com.tn","com.tr","com.tt","com.tw","com.ua","com.uy","com.ve","com.vi","com.vn","com.ye","conf.au","conf.lv","coop.br","coop.ht","coop.mv","coop.mw","cpa.pro","cq.cn","cri.nz","csiro.au","ct.us","cv.ua","d.se","dc.us","de.us","dn.ua","dni.us","dp.ua","dpn.br","dr.tr","e.se","ebiz.tw","ecn.br","ed.ao","ed.cr","ed.jp","edu.ac","edu.af","edu.al","edu.an","edu.au","edu.az","edu.bb","edu.bd","edu.bm","edu.bn","edu.bo","edu.br","edu.bt","edu.cn","edu.co","edu.cu","edu.dm","edu.do","edu.dz","edu.ec","edu.eg","edu.es","edu.et","edu.ge","edu.gh","edu.gi","edu.gp","edu.gr","edu.hk","edu.hn","edu.ht","edu.in","edu.jm","edu.jo","edu.kh","edu.kw","edu.ky","edu.kz","edu.lb","edu.lc","edu.lk","edu.lr","edu.lv","edu.ly","edu.mg","edu.mo","edu.mt","edu.mv","edu.mw","edu.mx","edu.my","edu.ng","edu.ni","edu.np","edu.nr","edu.om","edu.pa","edu.pe","edu.pf","edu.pk","edu.pl","edu.pr","edu.ps","edu.pt","edu.py","edu.rw","edu.sa","edu.sb","edu.sc","edu.sd","edu.sg","edu.sv","edu.tj","edu.tr","edu.tt","edu.tw","edu.ua","edu.vi","edu.vn","edu.za","eng.br","ens.tn","esp.br","etc.br","eti.br","eun.eg","f.se","fam.pk","far.br","fed.us","fh.se","fhs.no","fhsk.se","fhv.se","fi.cr","fie.ee","fin.ec","fin.tn","firm.ht","firm.in","fj.cn","fl.us","fm.br","fm.no","fnd.br","fot.br","from.hr","fst.br","g.se","g12.br","ga.us","game.tw","gd.cn","geek.nz","gen.in","gen.nz","gen.tr","ggf.br","go.cr","go.id","go.jp","go.th","go.tj","go.tz","go.ug","gob.bo","gob.do","gob.es","gob.hn","gob.mx","gob.ni","gob.pa","gob.pe","gob.pk","gob.sv","gok.pk","gon.pk","gop.pk","gos.pk","gouv.fr","gouv.ht","gouv.rw","gov.ac","gov.ae","gov.af","gov.al","gov.ar","gov.au","gov.az","gov.bb","gov.bd","gov.bf","gov.bm","gov.bo","gov.br","gov.bt","gov.by","gov.ch","gov.cn","gov.co","gov.cu","gov.cx","gov.dm","gov.do","gov.dz","gov.ec","gov.eg","gov.et","gov.fj","gov.fk","gov.ge","gov.gh","gov.gi","gov.gn","gov.gr","gov.hk","gov.ie","gov.il","gov.im","gov.in","gov.ir","gov.it","gov.jm","gov.jo","gov.kh","gov.kw","gov.ky","gov.kz","gov.lb","gov.lc","gov.li","gov.lk","gov.lr","gov.lt","gov.lu","gov.lv","gov.ly","gov.ma","gov.mg","gov.mo","gov.mt","gov.mv","gov.mw","gov.my","gov.ng","gov.np","gov.nr","gov.om","gov.ph","gov.pk","gov.pl","gov.pr","gov.ps","gov.pt","gov.py","gov.rw","gov.sa","gov.sb","gov.sc","gov.sd","gov.sg","gov.sy","gov.tj","gov.tn","gov.to","gov.tp","gov.tr","gov.tt.tv","gov.tv","gov.tw","gov.ua","gov.uk","gov.vi","gov.vn","gov.za","gov.zm","gov.zw","govt.nz","gr.jp","gs.cn","gub.uy","gv.ao","gv.at","gx.cn","gz.cn","h.se","ha.cn","hb.cn","he.cn","hi.cn","hi.us","hl.cn","hl.no","hm.no","hn.cn","i.se","ia.us","id.au","id.lv","id.ly","id.us","idf.il","idn.sg","idv.hk","idv.tw","if.ua","il.us","imb.br","in.th","in.us","ind.br","ind.in","ind.tn","inf.br","inf.cu","info.au","info.az","info.cy","info.ec","info.et","info.fj","info.ht","info.hu","info.mv","info.nr","info.pl","info.pr","info.ro","info.sd","info.tn","info.tr","info.tt","info.ve","info.vn","ing.pa","inima.al","int.ar","int.az","int.bo","int.lk","int.mv","int.mw","int.pt","int.ru","int.rw","int.tj","int.vn","intl.tn","ip6.ar","ip6.pa","iris.ar","iris.pa","isa.us","isla.pr","it.ao","iwi.nz","iz.hr","jet.uk","jl.cn","jor.br","js.cn","jx.cn","k.se","k12.il","k12.tr","kh.ua","kiev.ua","km.ua","kr.ua","ks.ua","ks.us","kv.ua","ky.us","la.us","law.pro","law.za","lel.br","lg.jp","lg.ua","ln.cn","ltd.co.im","ltd.cy","ltd.gi","ltd.lk","ltd.uk","lviv.ua","m.se","ma.us","mat.br","mb.ca","md.us","me.uk","me.us","med.br","med.ec","med.ht","med.ly","med.om","med.pa","med.pro","med.sa","med.sd","mi.th","mi.us","mil.ac","mil.ae","mil.ar","mil.az","mil.bd","mil.bo","mil.br","mil.by","mil.co","mil.do","mil.ec","mil.eg","mil.fj","mil.ge","mil.gh","mil.hn","mil.in","mil.jo","mil.kh","mil.kw","mil.kz","mil.lt","mil.lu","mil.lv","mil.mg","mil.mv","mil.my","mil.no","mil.np","mil.nz","mil.om","mil.pe","mil.pl","mil.rw","mil.se","mil.tj","mil.tr","mil.tw","mil.uk","mil.uy","mil.za","mk.ua","mn.us","mo.us","mod.gi","mod.uk","mr.no","ms.us","msk.ru","mt.us","muni.il","mus.br","n.se","name.ae","name.af","name.az","name.cy","name.et","name.fj","name.hr","name.mv","name.my","name.pr","name.ro","name.tj","name.tr","name.tt","name.vn","nat.tn","navy.mil","nb.ca","nc.us","nd.us","ne.jp","ne.tz","ne.ug","ne.us","nel.uk","net.ac","net.ae","net.af","net.ag","net.ai","net.al","net.an","net.ar","net.au","net.az","net.bb","net.bd","net.bm","net.bn","net.bo","net.br","net.bs","net.bt","net.cd","net.ch","net.cn","net.co","net.cu","net.cy","net.dm","net.do","net.dz","net.ec","net.eg","net.et","net.fj","net.fk","net.ge","net.gg","net.gn","net.gp","net.gr","net.hk","net.hn","net.ht","net.il","net.im","net.in","net.ir","net.je","net.jm","net.jo","net.kh","net.kw","net.ky","net.kz","net.lb","net.li","net.lk","net.lr","net.lu","net.lv","net.ly","net.ma","net.mo","net.mt","net.mv","net.mw","net.mx","net.my","net.ng","net.ni","net.np","net.nr","net.nz","net.om","net.pa","net.pe","net.pg","net.pk","net.pl","net.pr","net.ps","net.pt","net.py","net.ru","net.rw","net.sa","net.sb","net.sc","net.sd","net.sg","net.sy","net.th","net.tj","net.tn","net.tr","net.tt","net.tw","net.ua","net.uk","net.uy","net.ve","net.vn","net.ye","net.za","nf.ca","ngo.lk","ngo.pl","ngo.za","nh.us","nhs.uk","nic.im","nic.in","nic.uk","nj.us","nl.ca","nl.no","nls.uk","nm.cn","nm.us","nom.adae","nom.ag","nom.ai","nom.br","nom.co","nom.es","nom.fk","nom.fr","nom.mg","nom.ni","nom.pa","nom.pe","nom.ro","nom.za","nome.pt","not.br","ns.ca","nsn.us","nsw.au","nt.au","nt.ca","nt.no","nt.ro","ntr.br","nu.ca","nv.us","nx.cn","ny.us","o.se","od.ua","odo.br","of.no","off.ai","og.ao","oh.us","ok.us","ol.no","on.ca","or.at","or.cr","or.id","or.jp","or.kr","or.th","or.tz","or.ug","or.us","org.ac","org.ae","org.ag","org.ai","org.al","org.an","org.au","org.az","org.bb","org.bd","org.bm","org.bn","org.bo","org.br","org.bs","org.bt","org.bw","org.cd","org.ch","org.cn","org.co","org.cu","org.cy","org.dm","org.do","org.dz","org.ec","org.ee","org.eg","org.es","org.et","org.fj","org.fk","org.ge","org.gg","org.gh","org.gi","org.gn","org.gp","org.gr","org.hk","org.hn","org.ht","org.hu","org.il","org.im","org.in","org.ir","org.je","org.jm","org.jo","org.kh","org.kw","org.ky","org.kz","org.lb","org.lc","org.li","org.lk","org.lr","org.ls","org.lu","org.lv","org.ly","org.ma","org.mg","org.mk","org.mo","org.mt","org.mv","org.mw","org.mx","org.my","org.ng","org.ni","org.np","org.nr","org.nz","org.om","org.pa","org.pe","org.pf","org.pk","org.pl","org.pr","org.ps","org.pt","org.py","org.ro","org.ru","org.sa","org.sc","org.sd","org.se","org.sg","org.sv","org.tj","org.tn","org.tr","org.tt","org.tw","org.ua","org.uk","org.uy","org.ve","org.vi","org.vn","org.yu","org.za","org.zm","org.zw","oz.au","pa.us","pb.ao","pe.ca","per.kh","per.sg","perso.ht","pl.ua","plc.co.im","plc.ly","plc.uk","plo.ps","pol.dz","pol.ht","pol.tr","pp.az","pp.ru","pp.se","ppg.br","prd.fr","prd.mg","pri.ee","priv.at","priv.hu","pro.ae","pro.br","pro.cy","pro.ec","pro.fj","pro.ht","pro.mv","pro.om","pro.pr","pro.tt","pro.vn","psc.br","psi.br","pub.sa","publ.pt","pvt.ge","qc.ca","qh.cn","qld.au","qsl.br","rec.br","rec.ro","red.sv","rel.ht","res.in","ri.us","rl.no","rv.ua","s.se","sa.au","sa.cr","sc.cn","sc.ug","sc.us","sch.ae","sch.ir","sch.lk","sch.ly","sch.om","sch.sa","sch.uk","sch.zm","sci.eg","sd.cn","sd.us","sec.ps","sf.no","sh.cn","shop.ht","sk.ca","sld.do","sld.pa","slg.br","sn.cn","soc.lk","soros.al","sport.hu","srv.br","sshn.se","st.no","sumy.ua","sx.cn","t.se","tas.au","te.ua","tel.tr","tirana.al","tj.cn","tm.cy","tm.fr","tm.hu","tm.mc","tm.mg","tm.no","tm.ro","tm.se","tm.za","tmp.br","tn.us","tr.no","trd.br","tur.br","tv.bo","tv.br","tv.sd","tx.us","u.se","uniti.al","upt.al","uri.ar","uri.pa","us.com","ut.us","va.no","va.us","vet.br","vf.no","vgs.no","vic.au","vn.ua","vt.us","w.se","wa.au","wa.us","waw.pl","web.do","web.lk","web.pk","web.tj","web.tr","web.ve","wi.us","wv.us","www.ro","x.se","xj.cn","xz.cn","y.se","yk.ca","yn.cn","z.se","zj.cn","zlg.br","zp.ua","zt.ua"]},"./src/lib/environment.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{api:()=>s,environment:()=>i});let i={chrome:!1,name:"general",version:1,extensionVersion:"",mobile:!1,manifestV3:!1,notSupported:{setProxySettings:!1,keyboardShortcuts:!1},notAllowed:{setProxySettings:!1},bugFreeVersions:{firefoxToProxyScript:56,firefoxConfirmInPopupWorks:57,firefoxNewPacScriptReturnData:57},initialConfig:{displayTooltipOnBadge:!0},storageQuota:{syncQuotaBytesPerItem:()=>(i.chrome,8e3)},browserConfig:{name:"Default",marketName:"Extensions",marketUrl:""}};var s={};"undefined"!=typeof browser?s=browser:"undefined"!=typeof chrome&&(s=chrome,i.chrome=!0),s.browserAction?s.action=s.browserAction:s.action&&(s.browserAction=s.action),s.windows?s.runtime.getBrowserInfo&&s.runtime.getBrowserInfo().then((e=>{"Fennec"==e.name&&(i.mobile=!0)})):i.mobile=!0},"./src/ui/code/CommonUi.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{CommonUi:()=>a});var i=r("./src/lib/External.ts"),s=r("./src/lib/environment.ts"),n=r("./src/core/definitions.ts"),o=r("./src/lib/Utils.ts");class a{static downloadData(e,t){let r="data:application/json;charset=utf-8,"+encodeURIComponent(e);(0,i.jQuery)("<a/>").attr("download",t||"").attr("href",r)[0].dispatchEvent(new MouseEvent("click"))}static onDocumentReady(e){(0,i.jQuery)(document).ready(e)}static selectFileOnTheFly(e,t,r,s){let n=(0,i.jQuery)(`<div style='display: none'><input style='display: none' type=file accept='${s||""}' class='' name='${t}'/></div>`),o=n.find("input");(e=(0,i.jQuery)(e)).append(n),o.on("change",(function(e){n.remove();let t=e.target.files;t.length&&r&&r(o,t)})),o.trigger("click")}static localizeHtmlPage(){function e(e,t){let r=s.api.i18n.getMessage(t.trim());r&&r!=t&&(e.innerHTML=r)}let t=s.api.i18n.getMessage("uiDirection");t&&((0,i.jQuery)(document.body).addClass(t).css("direction",t),"rtl"==t&&a.insertStyleSheet("bootstrap.rtl.min.css"));let r=document.querySelectorAll("[data-localize]");for(let t=0;t<r.length;t++){const i=r[t];e(i,i.dataset.localize)}}static applyThemes(e){function t(e=void 0){a.insertStyleSheet(n.themesDarkFix,e)}function r(e=void 0){a.insertStyleSheet(n.themesDataTablesDarkFix,e)}function s(e){const t=document.createElement("meta");t.name="color-scheme",t.content=e,document.getElementsByTagName("head")[0].appendChild(t);let r=`<style>\n\t\t\t\t:root {\n\t\t\t\t\tcolor-scheme: ${e};\n\t\t\t\t}</style>`;(0,i.jQuery)(r).appendTo((0,i.jQuery)("head"))}e.themeType==n.ThemeType.Auto?(s("dark light"),e.themesDark==n.themesCustomType&&e.themesDarkCustomUrl?(r("(prefers-color-scheme: dark)"),t("(prefers-color-scheme: dark)"),a.insertStyleSheet(e.themesDarkCustomUrl,"(prefers-color-scheme: dark)")):e.themesDark&&(r("(prefers-color-scheme: dark)"),t("(prefers-color-scheme: dark)"),a.insertStyleSheet(e.themesDark+".css","(prefers-color-scheme: dark)")),e.themesLight==n.themesCustomType&&e.themesLightCustomUrl?a.insertStyleSheet(e.themesLightCustomUrl,"(prefers-color-scheme: light)"):e.themesLight&&a.insertStyleSheet(e.themesLight+".css","(prefers-color-scheme: light)")):e.themeType==n.ThemeType.Dark?(s("dark"),e.themesDark==n.themesCustomType&&e.themesDarkCustomUrl?(r(),t(),a.insertStyleSheet(e.themesDarkCustomUrl)):e.themesDark&&(r(),t(),a.insertStyleSheet(e.themesDark+".css"))):e.themeType==n.ThemeType.Light&&(s("light"),e.themesLight==n.themesCustomType&&e.themesLightCustomUrl?a.insertStyleSheet(e.themesLightCustomUrl):e.themesLight&&a.insertStyleSheet(e.themesLight+".css"))}static insertStyleSheet(e,t=void 0){const r=document.createElement("link");r.type="text/css",r.rel="stylesheet",o.Utils.urlHasSchema(e)?r.href=e:r.href=`css/${e}`,t&&(r.media=t),document.getElementsByTagName("head")[0].appendChild(r)}}},"./src/lib/RuleImporterSwitchy.js":(e,t)=>{const r=function(e,t){return e.substr(0,t.length)===t},i={}.hasOwnProperty,s={regExpMetaChars:function(){let e,t,r,i,s;for(e="\\[\\^$.|?*+(){}/",s={},t=r=0,i=15;r<15;t=++r)s["\\[\\^$.|?*+(){}/".charCodeAt(t)]=!0;return s}(),escapeSlash:function(e){let t,r,i,s,n,o,a,l,u;for(r=47,t=92,s=!1,u=0,l="",n=o=0,a=e.length;0<=a?o<a:o>a;n=0<=a?++o:--o)i=e.charCodeAt(n),47!==i||s||(l+=e.substring(u,n),l+="\\",u=n),s=92===i&&!s;return l+e.substr(u)},shExp2RegExp:function(e,t){let r,i,n,o,a,l,u,c,d,p,m;if(m=(null!=t?t.trimAsterisk:void 0)||!1,p=0,o=e.length,r=42,i=63,m){for(;p<o&&42===e.charCodeAt(p);)p++;for(;p<o&&42===e.charCodeAt(o-1);)o--;if(o-p==1&&42===e.charCodeAt(p))return""}for(d="",0===p&&(d+="^"),a=l=u=p,c=o;u<=c?l<c:l>c;a=u<=c?++l:--l)switch(n=e.charCodeAt(a),n){case 42:d+=".*";break;case 63:d+=".";break;default:s.regExpMetaChars[n]>=0&&(d+="\\"),d+=e[a]}return o===e.length&&(d+="$"),d}};let n=function(){function e(e,t){this.tag=t,this.prop=e,void 0===this.tag&&(this.tag=e,this.prop="_cache")}return e.prototype.get=function(e,t){let r,i,s;return i=this.tag(e),r=this._getCache(e),null!=r&&r.tag===i?r.value:(s="function"==typeof t?t():t,this._setCache(e,{tag:i,value:s}),s)},e.prototype.drop=function(e){if(null!=e[this.prop])return e[this.prop]=void 0},e.prototype._getCache=function(e){return e[this.prop]},e.prototype._setCache=function(e,t){return Object.prototype.hasOwnProperty.call(e,this.prop)||Object.defineProperty(e,this.prop,{writable:!0}),e[this.prop]=t},e}(),o={Address:function(e){this.valid=!1,this.address=e,this.groups=o.GROUPS,this.v4=!0,this.subnet="/32",this.subnetMask=32;let t=o.RE_SUBNET_STRING.exec(e);if(t){if(this.parsedSubnet=t[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet="/"+this.subnetMask,this.subnetMask<0||this.subnetMask>o.BITS)return this.valid=!1,void(this.error="Invalid subnet mask.");e=e.replace(o.RE_SUBNET_STRING,"")}this.addressMinusSuffix=e,this.parsedAddress=this.parse(e)}};o.Address.prototype.parse=function(e){let t=e.split(".");return e.match(o.RE_ADDRESS)?this.valid=!0:this.error="Invalid IPv4 address.",t},o.Address.prototype.isValid=function(){return this.valid},o.Address.prototype.correctForm=function(){return this.parsedAddress.map((function(e){return parseInt(e,10)})).join(".")};const a={urlWildcard2HostWildcard:function(e){let t;return t=e.match(/^\*:\/\/((?:\w|[?*._\-])+)\/\*$/),null!=t?t[1]:void 0},tag:function(e){return a._condCache.tag(e)},analyze:function(e){return a._condCache.get(e,(function(){return{analyzed:a._handler(e.conditionType).analyze.call(a,e)}}))},match:function(e,t){let r;return r=a.analyze(e),a._handler(e.conditionType).match.call(a,e,t,r)},compile:function(e){let t,r;return t=a.analyze(e),t.compiled?t.compiled:(r=a._handler(e.conditionType),t.compiled=r.compile.call(a,e,t))},str:function(e,t){let r,i,s,n,o,l,u;return r=(null!=t?t:{abbr:-1}).abbr,s=a._handler(e.conditionType),0===s.abbrs[0].length&&(i=e.pattern.charCodeAt(e.pattern.length-1),i!==a.colonCharCode&&e.pattern.indexOf(" ")<0)?e.pattern:(l=s.str,u="number"==typeof r?s.abbrs[(s.abbrs.length+r)%s.abbrs.length]:e.conditionType,o=u+":",n=l?l.call(a,e):e.pattern,n&&(o+=" "+n),o)},colonCharCode:":".charCodeAt(0),fromStr:function(e){let t,r,i,s;return s=(e=e.trim()).indexOf(" "),s<0&&(s=e.length),e.charCodeAt(s-1)===a.colonCharCode?(r=e.substr(0,s-1),e=e.substr(s+1).trim()):r="",r=a.typeFromAbbr(r),r?(t={conditionType:r},i=a._handler(t.conditionType).fromStr,i?i.call(a,e,t):(t.pattern=e,t)):null},_abbrs:null,typeFromAbbr:function(e){let t,r,s,n,o,l;if(!a._abbrs)for(l in a._abbrs={},o=a._conditionTypes,o)if(i.call(o,l))for(r=o[l].abbrs,a._abbrs[l.toUpperCase()]=l,s=0,n=r.length;s<n;s++)t=r[s],a._abbrs[t.toUpperCase()]=l;return a._abbrs[e.toUpperCase()]},comment:function(e,t){let r;return e?(null==t.start&&(t.start={}),Object.defineProperty(t.start,"_comments_dumped",{get:function(){return!1},set:function(){return!1}}),null==(r=t.start).comments_before&&(r.comments_before=[]),t.start.comments_before.push({type:"comment2",value:e}),t):t},safeRegex:function(e){let t;try{return new RegExp(e)}catch(e){return t=e,/(?!)/}},regTest:function(e,t){return"string"==typeof t&&(t=regexSafe(s.escapeSlash(t))),{args:[e],expression:t}},isInt:function(e){return"number"==typeof e&&!isNaN(e)&&parseFloat(e)===parseInt(e,10)},between:function(e,t,r,i){let s,n,o;return t===r?("number"==typeof t&&(t=t.toString()),a.comment(i,{left:e,operator:"===",right:t})):t>r?a.comment(i,new U2.AST_False):a.isInt(t)&&a.isInt(r)&&r-t<32?(i||(i=t+" <= value && value <= "+r),o="0123456789abcdefghijklmnopqrstuvwxyz",n="0123456789abcdefghijklmnopqrstuvwxyz".substr(r<36?t:0,r-t+1),s=0===t?e:{left:e,operator:"-",right:t},a.comment(i,{left:{expression:{expression:n,property:"charCodeAt"},args:[s]},operator:">",right:0})):("number"==typeof t&&(t=t.toString()),"number"==typeof r&&(r=r.toString()),a.comment(i,{args:[e,t,r],expression:{argnames:["value","min","max"],body:[new U2.AST_Return({value:new U2.AST_Binary({left:new U2.AST_Binary({left:new U2.AST_SymbolRef({name:"min"}),operator:"<=",right:new U2.AST_SymbolRef({name:"value"})}),operator:"&&",right:new U2.AST_Binary({left:new U2.AST_SymbolRef({name:"value"}),operator:"<=",right:new U2.AST_SymbolRef({name:"max"})})})})]}}))},parseIp:function(e){let t;return e.charCodeAt(0)==="[".charCodeAt(0)&&(e=e.substr(1,e.length-2)),t=new IP.v4.Address(e),t.isValid()||(t=new IP.v6.Address(e),t.isValid())?t:null},normalizeIp:function(e){let t;return(null!=(t=e.correctForm)?t:e.canonicalForm).call(e)},localHosts:["127.0.0.1","[::1]","localhost"],getWeekdayList:function(e){let t,r,i,s,n;if(e.days){for(s=[],t=r=0;r<7;t=++r)s.push(e.days.charCodeAt(t)>64);return s}for(n=[],t=i=0;i<7;t=++i)n.push(e.startDay<=t&&t<=e.endDay);return n},_condCache:new n((function(e){let t,r;return r=a._handler(e.conditionType).tag,t=r?r.apply(a,arguments):a.str(e),e.conditionType+"$"+t})),_setProp:function(e,t,r){return Object.prototype.hasOwnProperty.call(e,t)||Object.defineProperty(e,t,{writable:!0}),e[t]=r},_handler:function(e){let t;if("string"!=typeof e&&(e=e.conditionType),t=a._conditionTypes[e],null==t)throw new Error("Unknown condition type: "+e);return t},_conditionTypes:{TrueCondition:{abbrs:["True"],analyze:function(e){return null},match:function(){return!0},compile:function(e){return new U2.AST_True},str:function(e){return""},fromStr:function(e,t){return t}},FalseCondition:{abbrs:["False","Disabled"],analyze:function(e){return null},match:function(){return!1},compile:function(e){return new U2.AST_False},fromStr:function(e,t){return e.length>0&&(t.pattern=e),t}},UrlRegexCondition:{abbrs:["UR","URegex","UrlR","UrlRegex"],analyze:function(e){return this.safeRegex(s.escapeSlash(e.pattern))},match:function(e,t,r){return r.analyzed.test(t.url)},compile:function(e,t){return this.regTest("url",t.analyzed)}},UrlWildcardCondition:{abbrs:["U","UW","Url","UrlW","UWild","UWildcard","UrlWild","UrlWildcard"],analyze:function(e){let t,r;return t=function(){let t,i,n,o;for(n=e.pattern.split("|"),o=[],t=0,i=n.length;t<i;t++)r=n[t],r&&o.push(s.shExp2RegExp(r,{trimAsterisk:!0}));return o}(),this.safeRegex(t.join("|"))},match:function(e,t,r){return r.analyzed.test(t.url)},compile:function(e,t){return this.regTest("url",t.analyzed)}},HostRegexCondition:{abbrs:["R","HR","Regex","HostR","HRegex","HostRegex"],analyze:function(e){return this.safeRegex(s.escapeSlash(e.pattern))},match:function(e,t,r){return r.analyzed.test(t.host)},compile:function(e,t){return this.regTest("host",t.analyzed)}},HostWildcardCondition:{abbrs:["","H","W","HW","Wild","Wildcard","Host","HostW","HWild","HWildcard","HostWild","HostWildcard"],analyze:function(e){let t,r;return t=function(){let t,i,n,o;for(n=e.pattern.split("|"),o=[],t=0,i=n.length;t<i;t++)r=n[t],r&&(r.charCodeAt(0)===".".charCodeAt(0)&&(r="*"+r),0===r.indexOf("**.")?o.push(s.shExp2RegExp(r.substring(1),{trimAsterisk:!0})):0===r.indexOf("*.")?o.push(s.shExp2RegExp(r.substring(2),{trimAsterisk:!1}).replace(/./,"(?:^|\\.)").replace(/\.\*\$$/,"")):o.push(s.shExp2RegExp(r,{trimAsterisk:!0})));return o}(),this.safeRegex(t.join("|"))},match:function(e,t,r){return r.analyzed.test(t.host)},compile:function(e,t){return this.regTest("host",t.analyzed)}},BypassCondition:{abbrs:["B","Bypass"],analyze:function(e){let t,r,i,n,o,a,l,u,c,d,p;return r={host:null,ip:null,scheme:null,url:null,normalizedPattern:""},c=e.pattern,"<local>"===c?(r.host=c,r):(n=c.split("://"),n.length>1&&(r.scheme=n[0],r.normalizedPattern=r.scheme+"://",c=n[1]),n=c.split("/"),n.length>1&&(t=this.parseIp(n[0]),a=parseInt(n[1]),t&&!isNaN(a))?(r.ip={conditionType:"IpCondition",ip:this.normalizeIp(t),prefixLength:a},r.normalizedPattern+=r.ip.ip+"/"+r.ip.prefixLength,r):(d=this.parseIp(c),null==d&&(o=c.lastIndexOf(":"),o>=0&&(i=c.substring(o+1),c=c.substring(0,o)),d=this.parseIp(c)),null!=d?(c=this.normalizeIp(d),d.v4?r.normalizedPattern+=c:r.normalizedPattern+="["+c+"]"):(c.charCodeAt(0)===".".charCodeAt(0)&&(c="*"+c),r.normalizedPattern=c),i?(r.port=i,r.normalizedPattern+=":"+r.port,null==d||d.v4||(c="["+c+"]"),p=s.shExp2RegExp(c),p=p.substring(1,p.length-1),u=null!=(l=r.scheme)?l:"[^:]+",r.url=this.safeRegex("^"+u+":\\/\\/"+p+":"+i+"\\/")):"*"!==c&&(p=s.shExp2RegExp(c,{trimAsterisk:!0}),r.host=this.safeRegex(p)),r))},match:function(e,t,r){if(null!=(r=r.analyzed).scheme&&r.scheme!==t.scheme)return!1;if(null!=r.ip&&!this.match(r.ip,t))return!1;if(null!=r.host){if("<local>"===r.host)return"127.0.0.1"===t.host||"::1"===t.host||t.host.indexOf(".")<0;if(!r.host.test(t.host))return!1}return!(null!=r.url&&!r.url.test(t.url))},str:function(e){let t,r;return t=this._handler(e).analyze,r=t.call(a,e),r.normalizedPattern?r.normalizedPattern:e.pattern},compile:function(e,t){let r,i;if(null!=(t=t.analyzed).url)return this.regTest("url",t.url);if(r=[],"<local>"===t.host)return i=function(e){return new U2.AST_Binary({left:new U2.AST_SymbolRef({name:"host"}),operator:"===",right:new U2.AST_String({value:e})})},new U2.AST_Binary({left:new U2.AST_Binary({left:i("127.0.0.1"),operator:"||",right:i("::1")}),operator:"||",right:new U2.AST_Binary({left:new U2.AST_Call({expression:new U2.AST_Dot({expression:new U2.AST_SymbolRef({name:"host"}),property:"indexOf"}),args:[new U2.AST_String({value:"."})]}),operator:"<",right:new U2.AST_Number({value:0})})});switch(null!=t.scheme&&r.push(new U2.AST_Binary({left:new U2.AST_SymbolRef({name:"scheme"}),operator:"===",right:new U2.AST_String({value:t.scheme})})),null!=t.host?r.push(this.regTest("host",t.host)):null!=t.ip&&r.push(this.compile(t.ip)),r.length){case 0:return new U2.AST_True;case 1:return r[0];case 2:return new U2.AST_Binary({left:r[0],operator:"&&",right:r[1]})}}},KeywordCondition:{abbrs:["K","KW","Keyword"],analyze:function(e){return null},match:function(e,t){return"http"===t.scheme&&t.url.indexOf(e.pattern)>=0},compile:function(e){return new U2.AST_Binary({left:new U2.AST_Binary({left:new U2.AST_SymbolRef({name:"scheme"}),operator:"===",right:new U2.AST_String({value:"http"})}),operator:"&&",right:new U2.AST_Binary({left:new U2.AST_Call({expression:new U2.AST_Dot({expression:new U2.AST_SymbolRef({name:"url"}),property:"indexOf"}),args:[new U2.AST_String({value:e.pattern})]}),operator:">=",right:new U2.AST_Number({value:0})})})}},IpCondition:{abbrs:["Ip"],analyze:function(e){let t,r,i,s;if(r={addr:null,normalized:null},i=e.ip,i.charCodeAt(0)==="[".charCodeAt(0)&&(i=i.substr(1,i.length-2)),t=i+"/"+e.prefixLength,r.addr=this.parseIp(t),null==r.addr)throw new Error("Invalid IP address "+t);return r.normalized=this.normalizeIp(r.addr),s=r.addr.v4?new IP.v4.Address("255.255.255.255/"+r.addr.subnetMask):new IP.v6.Address(this.ipv6Max+"/"+r.addr.subnetMask),r.mask=this.normalizeIp(s.startAddress()),r},match:function(e,t,r){let i;return i=this.parseIp(t.host),null!=i&&(r=r.analyzed,i.v4===r.addr.v4&&i.isInSubnet(r.addr))},compile:function(e,t){let r,i,s;return s=(t=t.analyzed).addr.v4?new U2.AST_Binary({left:new U2.AST_Sub({expression:new U2.AST_SymbolRef({name:"host"}),property:new U2.AST_Binary({left:new U2.AST_Dot({expression:new U2.AST_SymbolRef({name:"host"}),property:"length"}),operator:"-",right:new U2.AST_Number({value:1})})}),operator:">=",right:new U2.AST_Number({value:0})}):new U2.AST_Binary({left:new U2.AST_Call({expression:new U2.AST_Dot({expression:new U2.AST_SymbolRef({name:"host"}),property:"indexOf"}),args:[new U2.AST_String({value:":"})]}),operator:">=",right:new U2.AST_Number({value:0})}),0===t.addr.subnetMask?s:(r=new U2.AST_Call({expression:new U2.AST_SymbolRef({name:"isInNet"}),args:[new U2.AST_SymbolRef({name:"host"}),new U2.AST_String({value:t.normalized}),new U2.AST_String({value:t.mask})]}),t.addr.v4||(i=new U2.AST_Call({expression:new U2.AST_SymbolRef({name:"isInNetEx"}),args:[new U2.AST_SymbolRef({name:"host"}),new U2.AST_String({value:t.normalized+t.addr.subnet})]}),r=new U2.AST_Conditional({condition:new U2.AST_Binary({left:new U2.AST_UnaryPrefix({operator:"typeof",expression:new U2.AST_SymbolRef({name:"isInNetEx"})}),operator:"===",right:new U2.AST_String({value:"function"})}),consequent:i,alternative:r})),new U2.AST_Binary({left:s,operator:"&&",right:r}))},str:function(e){return e.ip+"/"+e.prefixLength},fromStr:function(e,t){let r;return r=this.parseIp(e),null!=r?(t.ip=r.addressMinusSuffix,t.prefixLength=r.subnetMask):(t.ip="0.0.0.0",t.prefixLength=0),t}},HostLevelsCondition:{abbrs:["Lv","Level","Levels","HL","HLv","HLevel","HLevels","HostL","HostLv","HostLevel","HostLevels"],analyze:function(e){return".".charCodeAt(0)},match:function(e,t,r){let i,s,n,o,a;for(i=r.analyzed,s=0,n=o=0,a=t.host.length;0<=a?o<a:o>a;n=0<=a?++o:--o)if(t.host.charCodeAt(n)===i&&(s++,s>e.maxValue))return!1;return s>=e.minValue},compile:function(e){let t;return t={property:"length",expression:{args:["."],expression:{expression:"host",property:"split"}}},this.between(t,e.minValue+1,e.maxValue+1,e.minValue+" <= hostLevels <= "+e.maxValue)},str:function(e){return e.minValue+"~"+e.maxValue},fromStr:function(e,t){let r,i,s;return s=e.split("~"),i=s[0],r=s[1],t.minValue=parseInt(i,10),t.maxValue=parseInt(r,10),t.minValue>0||(t.minValue=1),t.maxValue>0||(t.maxValue=1),t}},WeekdayCondition:{abbrs:["WD","Week","Day","Weekday"],analyze:function(e){return null},match:function(e,t){let r;return r=(new Date).getDay(),e.days?e.days.charCodeAt(r)>64:e.startDay<=r&&r<=e.endDay},compile:function(e){let t;return t=new U2.AST_Call({args:[],expression:new U2.AST_Dot({property:"getDay",expression:new U2.AST_New({args:[],expression:new U2.AST_SymbolRef({name:"Date"})})})}),e.days?new U2.AST_Binary({left:new U2.AST_Call({expression:new U2.AST_Dot({expression:new U2.AST_String({value:e.days}),property:"charCodeAt"}),args:[t]}),operator:">",right:new U2.AST_Number({value:64})}):this.between(t,e.startDay,e.endDay)},str:function(e){return e.days?e.days:e.startDay+"~"+e.endDay},fromStr:function(e,t){let r,i,s,n,o;return e.indexOf("~")<0&&7===e.length?t.days=e:(i=e.split("~"),o=i[0],r=i[1],t.startDay=parseInt(o,10),t.endDay=parseInt(r,10),0<=(s=t.startDay)&&s<=6||(t.startDay=0),0<=(n=t.endDay)&&n<=6||(t.endDay=0)),t}},TimeCondition:{abbrs:["T","Time","Hour"],analyze:function(e){return null},match:function(e,t){let r;return r=(new Date).getHours(),e.startHour<=r&&r<=e.endHour},compile:function(e){let t;return t=new U2.AST_Call({args:[],expression:new U2.AST_Dot({property:"getHours",expression:new U2.AST_New({args:[],expression:new U2.AST_SymbolRef({name:"Date"})})})}),this.between(t,e.startHour,e.endHour)},str:function(e){return e.startHour+"~"+e.endHour},fromStr:function(e,t){let r,i,s,n,o;return i=e.split("~"),o=i[0],r=i[1],t.startHour=parseInt(o,10),t.endHour=parseInt(r,10),0<=(s=t.startHour)&&s<24||(t.startHour=0),0<=(n=t.endHour)&&n<24||(t.endHour=0),t}}}},l={omegaPrefix:"[SwitchyOmega Conditions",specialLineStart:"[;#@!",detect:function(e){if(r(e,l.omegaPrefix))return!0},parse:function(e,t,r){let i,s=l;return i=s.getParser(e),s[i](e,t,r)},directReferenceSet:function(e){let t,r,i,s,n,o,a,u,c,d,p,m,f;if(p=e.ruleList,o=e.matchProfileName,t=e.defaultProfileName,f=p.trim(),m=l,a=m.getParser(f),"parseOmega"===a&&/(^|\n)@with\s+results?(\r|\n|$)/i.test(f)){for(d={},c=f.split(/\n|\r/),r=0,s=c.length;r<s;r++)n=c[r],n=n.trim(),m.specialLineStart.indexOf(n[0])<0&&(i=n.lastIndexOf(" +"),u=i<0?t||"direct":n.substr(i+2).trim(),d["+"+u]=u);return d}},compose:function(e,t){let r,i,s,n,o,u,c,d,p,m,f,h;for(p=e.rules,r=e.defaultProfileName,u=null!=t?t:{},h=u.withResult,f=u.useExclusive,i="\r\n",d="[SwitchyOmega Conditions]\r\n",null==f&&(f=!h),d+=h?"@with result\r\n\r\n":i,m=l.specialLineStart+"+",s=0,n=p.length;s<n;s++)c=p[s],c.note&&(d+="@note "+c.note+i),o=a.str(c.condition),f&&c.profileName===r?o="!"+o:(m.indexOf(o[0])>=0&&(o=": "+o),h&&(o+=" +"+c.profileName)),d+=o+i;return h&&(d+="\r\n* +"+r+i),d},getParser:function(e){let t,i;return i=l,t="parseOmega",r(e,i.omegaPrefix)||("#"===e[0]||e.indexOf("\n#")>=0)&&(t="parseLegacy"),t},conditionFromLegacyWildcard:function(e){let t;return"@"===e[0]?e=e.substring(1):(e.indexOf("://")<=0&&"*"!==e[0]&&(e="*"+e),"*"!==e[e.length-1]&&(e+="*")),t=a.urlWildcard2HostWildcard(e),t?{conditionType:"HostWildcardCondition",pattern:t}:{conditionType:"UrlWildcardCondition",pattern:e}},parseLegacy:function(e,t,r){let i,s,n,o,a,u,c,d,p,m,f,h;for(d=[],n=[],i=!1,f="WILDCARD",m=e.split(/\n|\r/),o=0,a=m.length;o<a;o++)if(u=m[o],u=u.trim(),0!==u.length&&";"!==u[0])if(i){if("#END"===u.toUpperCase())break;"["!==u[0]||"]"!==u[u.length-1]?(h=u,p=t,c=d,"!"===u[0]&&(p=r,c=n,u=u.substring(1)),s=function(){switch(f){case"WILDCARD":return l.conditionFromLegacyWildcard(u);case"REGEXP":return{conditionType:"UrlRegexCondition",pattern:u};default:return null}}(),null!=s&&c.push({condition:s,profileName:p,source:h})):f=u.substring(1,u.length-1).toUpperCase()}else"#BEGIN"===u.toUpperCase()&&(i=!0);return n.concat(d)},parseOmega:function(e,t,r,s){let n,o,l,u,c,d,p,m,f,h,g,S,y,b,x,v,P,R,w,T,k,_,C;for(null==s&&(s={}),_=s.strict,_&&(l=function(e){let t,r,s;for(r in t=new Error(e.message),e)i.call(e,r)&&(s=e[r],t[r]=s);throw t}),m=null==(v=s.source)||v,w=[],T=[],C=!1,u=null,b=null,y=0,P=e.split(/\n|\r/),d=0,h=P.length;d<h;d++)if(S=P[d],y++,S=S.trim(),0!==S.length){switch(S[0]){case"[":case";":continue;case"@":switch(p=S.indexOf(" "),p<0&&(p=S.length),o=S.substr(1,p-1),S=S.substr(p+1).trim(),o.toUpperCase()){case"WITH":c=S.toUpperCase(),"RESULT"!==c&&"RESULTS"!==c||(C=!0);break;case"NOTE":b=S}continue}if(k=null,_&&(u=null),"!"===S[0])x=C?null:r,k=S,S=S.substr(1);else if(C){if(p=S.lastIndexOf(" +"),p<0){"function"==typeof l&&l({message:"Missing result profile name: "+S,reason:"missingResultProfile",source:S,sourceLineNo:y});continue}x=S.substr(p+2).trim(),S=S.substr(0,p).trim(),"*"===S&&(u=x)}else x=t;n=a.fromStr(S),n?(R={condition:n,profileName:x,source:m?null!=k?k:S:void 0},null!=b&&(R.note=b,b=null),w.push(R),x||T.push(R)):"function"==typeof l&&l({message:"Invalid rule: "+S,reason:"invalidRule",source:null!=k?k:S,sourceLineNo:y})}if(C)for(u||(_&&"function"==typeof l&&l({message:"Missing default rule with catch-all '*' condition",reason:"noDefaultRule"}),u=r||"direct"),f=0,g=T.length;f<g;f++)R=T[f],R.profileName=u;return w}};let u={builtinProfiles:{"+direct":{name:"direct",profileType:"DirectProfile",color:"#aaaaaa",builtin:!0},"+system":{name:"system",profileType:"SystemProfile",color:"#000000",builtin:!0}},schemes:[{scheme:"http",prop:"proxyForHttp"},{scheme:"https",prop:"proxyForHttps"},{scheme:"ftp",prop:"proxyForFtp"},{scheme:"",prop:"fallbackProxy"}],pacProtocols:{http:"PROXY",https:"HTTPS",socks4:"SOCKS",socks5:"SOCKS5"},formatByType:{SwitchyRuleListProfile:"Switchy",AutoProxyRuleListProfile:"AutoProxy"},ruleListFormats:["Switchy","AutoProxy"],parseHostPort:function(e,t){let r,i,s;if(s=e.lastIndexOf(":"),!(s<0)&&(i=parseInt(e.substr(s+1))||80,r=e.substr(0,s),r))return{scheme:t,host:r,port:i}},pacResult:function(e){return e?"socks5"===e.scheme?"SOCKS5 "+e.host+":"+e.port+"; SOCKS "+e.host+":"+e.port:u.pacProtocols[e.scheme]+" "+e.host+":"+e.port:"DIRECT"},isFileUrl:function(e){return!("FILE:"!==(null!=e?e.substr(0,5).toUpperCase():void 0))},nameAsKey:function(e){return"string"!=typeof e&&(e=e.name),"+"+e},byName:function(e,t){let r,i;return"string"==typeof e&&(r=u.nameAsKey(e),e=null!=(i=u.builtinProfiles[r])?i:t[r]),e},byKey:function(e,t){let r;return"string"==typeof e&&(e=null!=(r=u.builtinProfiles[e])?r:t[e]),e},each:function(e,t){let r,i,s,n,o;for(i in r="+".charCodeAt(0),e)s=e[i],i.charCodeAt(0)===r&&t(i,s);for(i in n=u.builtinProfiles,o=[],n)s=n[i],i.charCodeAt(0)===r?o.push(t(i,s)):o.push(void 0);return o},profileResult:function(e){let t;return t=u.nameAsKey(e),"+direct"===t&&(t=u.pacResult()),t},isIncludable:function(e){let t;return t=u._handler(e).includable,"function"==typeof t&&(t=t.call(u,e)),!!t},isInclusive:function(e){return!!u._handler(e).inclusive},updateUrl:function(e){let t;return null!=(t=u._handler(e).updateUrl)?t.call(u,e):void 0},updateContentTypeHints:function(e){let t;return null!=(t=u._handler(e).updateContentTypeHints)?t.call(u,e):void 0},update:function(e,t){return u._handler(e).update.call(u,e,t)},tag:function(e){return u._profileCache.tag(e)},create:function(e,t){let r;return"string"==typeof e?e={name:e,profileType:t}:t&&(e.profileType=t),r=u._handler(e).create,r?(r.call(u,e),e):e},updateRevision:function(e,t){return null==t&&(t=Revision.fromTime()),e.revision=t},replaceRef:function(e,t,r){let i;return!!u.isInclusive(e)&&(i=u._handler(e),i.replaceRef.call(u,e,t,r))},analyze:function(e){let t,r,i;return r=u._profileCache.get(e,{}),Object.prototype.hasOwnProperty.call(r,"analyzed")||(t=u._handler(e).analyze,i=null!=t?t.call(u,e):void 0,r.analyzed=i),r},directReferenceSet:function(e){let t,r;return u.isInclusive(e)?(t=u._profileCache.get(e,{}),t.directReferenceSet?t.directReferenceSet:(r=u._handler(e),t.directReferenceSet=r.directReferenceSet.call(u,e))):{}},profileNotFound:function(e,t){if(null==t)throw new Error("Profile "+e+" does not exist!");if("function"==typeof t&&(t=t(e)),"object"==typeof t&&t.profileType)return t;switch(t){case"ignore":return null;case"dumb":return u.create({name:e,profileType:"VirtualProfile",defaultProfileName:"direct"})}throw t},allReferenceSet:function(e,t,r){let i,s,n,o,a,l;if(o=e,null==(e=u.byName(e,t))&&(e="function"==typeof u.profileNotFound?u.profileNotFound(o,r.profileNotFound):void 0),null==r&&(r={}),i=null!=r.out,l=null!=r.out?r.out:r.out={},e)for(s in l[u.nameAsKey(e.name)]=e.name,a=u.directReferenceSet(e),a)n=a[s],u.allReferenceSet(n,t,r);return i||delete r.out,l},referencedBySet:function(e,t,r){let i,s,n;return s=u.nameAsKey(e),null==r&&(r={}),i=null!=r.out,n=null!=r.out?r.out:r.out={},u.each(t,(function(e,i){if(u.directReferenceSet(i)[s])return n[e]=i.name,u.referencedBySet(i,t,r)})),i||delete r.out,n},validResultProfilesFor:function(e,t){let r,i,s;return e=u.byName(e,t),u.isInclusive(e)?(r=u.nameAsKey(e),i=u.referencedBySet(e,t),i[r]=r,s=[],u.each(t,(function(e,t){if(!i[e]&&u.isIncludable(t))return s.push(t)})),s):[]},match:function(e,t,r){let i,s;return null==r&&(r=e.profileType),i=u.analyze(e),s=u._handler(r).match,null!=s?s.call(u,e,t,i):void 0},compile:function(e,t){let r,i;return null==t&&(t=e.profileType),r=u.analyze(e),r.compiled?r.compiled:(i=u._handler(t),r.compiled=i.compile.call(u,e,r))},_profileCache:new n((function(e){return e.revision})),_handler:function(e){let t;for("string"!=typeof e&&(e=e.profileType),t=e;"string"==typeof t;)t=u._profileTypes[t];if(null==t)throw new Error("Unknown profile type: "+e);return t},_profileTypes:{SwitchProfile:{includable:!0,inclusive:!0,create:function(e){return null==e.defaultProfileName&&(e.defaultProfileName="direct"),null!=e.rules?e.rules:e.rules=[]},directReferenceSet:function(e){let t,r,i,s,n;for(s={},s[u.nameAsKey(e.defaultProfileName)]=e.defaultProfileName,i=e.rules,t=0,r=i.length;t<r;t++)n=i[t],s[u.nameAsKey(n.profileName)]=n.profileName;return s},analyze:function(e){return e.rules},replaceRef:function(e,t,r){let i,s,n,o,a;for(i=!1,e.defaultProfileName===t&&(e.defaultProfileName=r,i=!0),o=e.rules,s=0,n=o.length;s<n;s++)a=o[s],a.profileName===t&&(a.profileName=r,i=!0);return i},match:function(e,t,r){let i,s,n,o;for(n=r.analyzed,i=0,s=n.length;i<s;i++)if(o=n[i],a.match(o.condition,t))return o;return[u.nameAsKey(e.defaultProfileName),null]},compile:function(e,t){let r,i,s,n;if(n=t.analyzed,0===n.length)return this.profileResult(e.defaultProfileName);let o=[];for(r=0,i=n.length;r<i;r++){s=n[r];let e=a.compile(s.condition);e.source=s.source,o.push(e)}return{compiled:o,argnames:[{name:"url"},{name:"host"},{name:"scheme"}]}}}}};t.RuleImporterSwitchy={switchy:l,compiler:u}},"./node_modules/pako/dist/pako.esm.mjs":(e,t,r)=>{"use strict";function i(e){let t=e.length;for(;--t>=0;)e[t]=0}r.r(t),r.d(t,{Deflate:()=>cr,Inflate:()=>fr,constants:()=>yr,default:()=>br,deflate:()=>dr,deflateRaw:()=>pr,gzip:()=>mr,inflate:()=>hr,inflateRaw:()=>gr,ungzip:()=>Sr});const s=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),n=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),o=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),a=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),l=new Array(576);i(l);const u=new Array(60);i(u);const c=new Array(512);i(c);const d=new Array(256);i(d);const p=new Array(29);i(p);const m=new Array(30);function f(e,t,r,i,s){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=i,this.max_length=s,this.has_stree=e&&e.length}let h,g,S;function y(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}i(m);const b=e=>e<256?c[e]:c[256+(e>>>7)],x=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},v=(e,t,r)=>{e.bi_valid>16-r?(e.bi_buf|=t<<e.bi_valid&65535,x(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=r-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)},P=(e,t,r)=>{v(e,r[2*t],r[2*t+1])},R=(e,t)=>{let r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1},w=(e,t,r)=>{const i=new Array(16);let s,n,o=0;for(s=1;s<=15;s++)o=o+r[s-1]<<1,i[s]=o;for(n=0;n<=t;n++){let t=e[2*n+1];0!==t&&(e[2*n]=R(i[t]++,t))}},T=e=>{let t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},k=e=>{e.bi_valid>8?x(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},_=(e,t,r,i)=>{const s=2*t,n=2*r;return e[s]<e[n]||e[s]===e[n]&&i[t]<=i[r]},C=(e,t,r)=>{const i=e.heap[r];let s=r<<1;for(;s<=e.heap_len&&(s<e.heap_len&&_(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!_(t,i,e.heap[s],e.depth));)e.heap[r]=e.heap[s],r=s,s<<=1;e.heap[r]=i},I=(e,t,r)=>{let i,o,a,l,u=0;if(0!==e.sym_next)do{i=255&e.pending_buf[e.sym_buf+u++],i+=(255&e.pending_buf[e.sym_buf+u++])<<8,o=e.pending_buf[e.sym_buf+u++],0===i?P(e,o,t):(a=d[o],P(e,a+256+1,t),l=s[a],0!==l&&(o-=p[a],v(e,o,l)),i--,a=b(i),P(e,a,r),l=n[a],0!==l&&(i-=m[a],v(e,i,l)))}while(u<e.sym_next);P(e,256,t)},A=(e,t)=>{const r=t.dyn_tree,i=t.stat_desc.static_tree,s=t.stat_desc.has_stree,n=t.stat_desc.elems;let o,a,l,u=-1;for(e.heap_len=0,e.heap_max=573,o=0;o<n;o++)0!==r[2*o]?(e.heap[++e.heap_len]=u=o,e.depth[o]=0):r[2*o+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=u<2?++u:0,r[2*l]=1,e.depth[l]=0,e.opt_len--,s&&(e.static_len-=i[2*l+1]);for(t.max_code=u,o=e.heap_len>>1;o>=1;o--)C(e,r,o);l=n;do{o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],C(e,r,1),a=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=a,r[2*l]=r[2*o]+r[2*a],e.depth[l]=(e.depth[o]>=e.depth[a]?e.depth[o]:e.depth[a])+1,r[2*o+1]=r[2*a+1]=l,e.heap[1]=l++,C(e,r,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const r=t.dyn_tree,i=t.max_code,s=t.stat_desc.static_tree,n=t.stat_desc.has_stree,o=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,l=t.stat_desc.max_length;let u,c,d,p,m,f,h=0;for(p=0;p<=15;p++)e.bl_count[p]=0;for(r[2*e.heap[e.heap_max]+1]=0,u=e.heap_max+1;u<573;u++)c=e.heap[u],p=r[2*r[2*c+1]+1]+1,p>l&&(p=l,h++),r[2*c+1]=p,c>i||(e.bl_count[p]++,m=0,c>=a&&(m=o[c-a]),f=r[2*c],e.opt_len+=f*(p+m),n&&(e.static_len+=f*(s[2*c+1]+m)));if(0!==h){do{for(p=l-1;0===e.bl_count[p];)p--;e.bl_count[p]--,e.bl_count[p+1]+=2,e.bl_count[l]--,h-=2}while(h>0);for(p=l;0!==p;p--)for(c=e.bl_count[p];0!==c;)d=e.heap[--u],d>i||(r[2*d+1]!==p&&(e.opt_len+=(p-r[2*d+1])*r[2*d],r[2*d+1]=p),c--)}})(e,t),w(r,u,e.bl_count)},D=(e,t,r)=>{let i,s,n=-1,o=t[1],a=0,l=7,u=4;for(0===o&&(l=138,u=3),t[2*(r+1)+1]=65535,i=0;i<=r;i++)s=o,o=t[2*(i+1)+1],++a<l&&s===o||(a<u?e.bl_tree[2*s]+=a:0!==s?(s!==n&&e.bl_tree[2*s]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,n=s,0===o?(l=138,u=3):s===o?(l=6,u=3):(l=7,u=4))},U=(e,t,r)=>{let i,s,n=-1,o=t[1],a=0,l=7,u=4;for(0===o&&(l=138,u=3),i=0;i<=r;i++)if(s=o,o=t[2*(i+1)+1],!(++a<l&&s===o)){if(a<u)do{P(e,s,e.bl_tree)}while(0!=--a);else 0!==s?(s!==n&&(P(e,s,e.bl_tree),a--),P(e,16,e.bl_tree),v(e,a-3,2)):a<=10?(P(e,17,e.bl_tree),v(e,a-3,3)):(P(e,18,e.bl_tree),v(e,a-11,7));a=0,n=s,0===o?(l=138,u=3):s===o?(l=6,u=3):(l=7,u=4)}};let M=!1;const E=(e,t,r,i)=>{v(e,0+(i?1:0),3),k(e),x(e,r),x(e,~r),r&&e.pending_buf.set(e.window.subarray(t,t+r),e.pending),e.pending+=r};var F={_tr_init:e=>{M||((()=>{let e,t,r,i,a;const y=new Array(16);for(r=0,i=0;i<28;i++)for(p[i]=r,e=0;e<1<<s[i];e++)d[r++]=i;for(d[r-1]=i,a=0,i=0;i<16;i++)for(m[i]=a,e=0;e<1<<n[i];e++)c[a++]=i;for(a>>=7;i<30;i++)for(m[i]=a<<7,e=0;e<1<<n[i]-7;e++)c[256+a++]=i;for(t=0;t<=15;t++)y[t]=0;for(e=0;e<=143;)l[2*e+1]=8,e++,y[8]++;for(;e<=255;)l[2*e+1]=9,e++,y[9]++;for(;e<=279;)l[2*e+1]=7,e++,y[7]++;for(;e<=287;)l[2*e+1]=8,e++,y[8]++;for(w(l,287,y),e=0;e<30;e++)u[2*e+1]=5,u[2*e]=R(e,5);h=new f(l,s,257,286,15),g=new f(u,n,0,30,15),S=new f(new Array(0),o,0,19,7)})(),M=!0),e.l_desc=new y(e.dyn_ltree,h),e.d_desc=new y(e.dyn_dtree,g),e.bl_desc=new y(e.bl_tree,S),e.bi_buf=0,e.bi_valid=0,T(e)},_tr_stored_block:E,_tr_flush_block:(e,t,r,i)=>{let s,n,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),A(e,e.l_desc),A(e,e.d_desc),o=(e=>{let t;for(D(e,e.dyn_ltree,e.l_desc.max_code),D(e,e.dyn_dtree,e.d_desc.max_code),A(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*a[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),s=e.opt_len+3+7>>>3,n=e.static_len+3+7>>>3,n<=s&&(s=n)):s=n=r+5,r+4<=s&&-1!==t?E(e,t,r,i):4===e.strategy||n===s?(v(e,2+(i?1:0),3),I(e,l,u)):(v(e,4+(i?1:0),3),((e,t,r,i)=>{let s;for(v(e,t-257,5),v(e,r-1,5),v(e,i-4,4),s=0;s<i;s++)v(e,e.bl_tree[2*a[s]+1],3);U(e,e.dyn_ltree,t-1),U(e,e.dyn_dtree,r-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),I(e,e.dyn_ltree,e.dyn_dtree)),T(e),i&&k(e)},_tr_tally:(e,t,r)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=r,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(d[r]+256+1)]++,e.dyn_dtree[2*b(t)]++),e.sym_next===e.sym_end),_tr_align:e=>{v(e,2,3),P(e,256,l),(e=>{16===e.bi_valid?(x(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}},L=(e,t,r,i)=>{let s=65535&e|0,n=e>>>16&65535|0,o=0;for(;0!==r;){o=r>2e3?2e3:r,r-=o;do{s=s+t[i++]|0,n=n+s|0}while(--o);s%=65521,n%=65521}return s|n<<16|0};const O=new Uint32Array((()=>{let e,t=[];for(var r=0;r<256;r++){e=r;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t})());var N=(e,t,r,i)=>{const s=O,n=i+r;e^=-1;for(let r=i;r<n;r++)e=e>>>8^s[255&(e^t[r])];return-1^e},B={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},z={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:G,_tr_stored_block:H,_tr_flush_block:W,_tr_tally:$,_tr_align:j}=F,{Z_NO_FLUSH:q,Z_PARTIAL_FLUSH:V,Z_FULL_FLUSH:Z,Z_FINISH:K,Z_BLOCK:J,Z_OK:Q,Z_STREAM_END:Y,Z_STREAM_ERROR:X,Z_DATA_ERROR:ee,Z_BUF_ERROR:te,Z_DEFAULT_COMPRESSION:re,Z_FILTERED:ie,Z_HUFFMAN_ONLY:se,Z_RLE:ne,Z_FIXED:oe,Z_DEFAULT_STRATEGY:ae,Z_UNKNOWN:le,Z_DEFLATED:ue}=z,ce=258,de=262,pe=42,me=113,fe=666,he=(e,t)=>(e.msg=B[t],t),ge=e=>2*e-(e>4?9:0),Se=e=>{let t=e.length;for(;--t>=0;)e[t]=0},ye=e=>{let t,r,i,s=e.w_size;t=e.hash_size,i=t;do{r=e.head[--i],e.head[i]=r>=s?r-s:0}while(--t);t=s,i=t;do{r=e.prev[--i],e.prev[i]=r>=s?r-s:0}while(--t)};let be=(e,t,r)=>(t<<e.hash_shift^r)&e.hash_mask;const xe=e=>{const t=e.state;let r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+r),e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))},ve=(e,t)=>{W(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,xe(e.strm)},Pe=(e,t)=>{e.pending_buf[e.pending++]=t},Re=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},we=(e,t,r,i)=>{let s=e.avail_in;return s>i&&(s=i),0===s?0:(e.avail_in-=s,t.set(e.input.subarray(e.next_in,e.next_in+s),r),1===e.state.wrap?e.adler=L(e.adler,t,s,r):2===e.state.wrap&&(e.adler=N(e.adler,t,s,r)),e.next_in+=s,e.total_in+=s,s)},Te=(e,t)=>{let r,i,s=e.max_chain_length,n=e.strstart,o=e.prev_length,a=e.nice_match;const l=e.strstart>e.w_size-de?e.strstart-(e.w_size-de):0,u=e.window,c=e.w_mask,d=e.prev,p=e.strstart+ce;let m=u[n+o-1],f=u[n+o];e.prev_length>=e.good_match&&(s>>=2),a>e.lookahead&&(a=e.lookahead);do{if(r=t,u[r+o]===f&&u[r+o-1]===m&&u[r]===u[n]&&u[++r]===u[n+1]){n+=2,r++;do{}while(u[++n]===u[++r]&&u[++n]===u[++r]&&u[++n]===u[++r]&&u[++n]===u[++r]&&u[++n]===u[++r]&&u[++n]===u[++r]&&u[++n]===u[++r]&&u[++n]===u[++r]&&n<p);if(i=ce-(p-n),n=p-ce,i>o){if(e.match_start=t,o=i,i>=a)break;m=u[n+o-1],f=u[n+o]}}}while((t=d[t&c])>l&&0!=--s);return o<=e.lookahead?o:e.lookahead},ke=e=>{const t=e.w_size;let r,i,s;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-de)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),ye(e),i+=t),0===e.strm.avail_in)break;if(r=we(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=r,e.lookahead+e.insert>=3)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=be(e,e.ins_h,e.window[s+1]);e.insert&&(e.ins_h=be(e,e.ins_h,e.window[s+3-1]),e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<de&&0!==e.strm.avail_in)},_e=(e,t)=>{let r,i,s,n=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,a=e.strm.avail_in;do{if(r=65535,s=e.bi_valid+42>>3,e.strm.avail_out<s)break;if(s=e.strm.avail_out-s,i=e.strstart-e.block_start,r>i+e.strm.avail_in&&(r=i+e.strm.avail_in),r>s&&(r=s),r<n&&(0===r&&t!==K||t===q||r!==i+e.strm.avail_in))break;o=t===K&&r===i+e.strm.avail_in?1:0,H(e,0,0,o),e.pending_buf[e.pending-4]=r,e.pending_buf[e.pending-3]=r>>8,e.pending_buf[e.pending-2]=~r,e.pending_buf[e.pending-1]=~r>>8,xe(e.strm),i&&(i>r&&(i=r),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,r-=i),r&&(we(e.strm,e.strm.output,e.strm.next_out,r),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r)}while(0===o);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==q&&t!==K&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(s=e.window_size-e.strstart,e.strm.avail_in>s&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,s+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),s>e.strm.avail_in&&(s=e.strm.avail_in),s&&(we(e.strm,e.window,e.strstart,s),e.strstart+=s,e.insert+=s>e.w_size-e.insert?e.w_size-e.insert:s),e.high_water<e.strstart&&(e.high_water=e.strstart),s=e.bi_valid+42>>3,s=e.pending_buf_size-s>65535?65535:e.pending_buf_size-s,n=s>e.w_size?e.w_size:s,i=e.strstart-e.block_start,(i>=n||(i||t===K)&&t!==q&&0===e.strm.avail_in&&i<=s)&&(r=i>s?s:i,o=t===K&&0===e.strm.avail_in&&r===i?1:0,H(e,e.block_start,r,o),e.block_start+=r,xe(e.strm)),o?3:1)},Ce=(e,t)=>{let r,i;for(;;){if(e.lookahead<de){if(ke(e),e.lookahead<de&&t===q)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-de&&(e.match_length=Te(e,r)),e.match_length>=3)if(i=$(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=be(e,e.ins_h,e.window[e.strstart+1]);else i=$(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(ve(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===K?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2},Ie=(e,t)=>{let r,i,s;for(;;){if(e.lookahead<de){if(ke(e),e.lookahead<de&&t===q)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-de&&(e.match_length=Te(e,r),e.match_length<=5&&(e.strategy===ie||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,i=$(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(ve(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(i=$(e,0,e.window[e.strstart-1]),i&&ve(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=$(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===K?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2};function Ae(e,t,r,i,s){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=i,this.func=s}const De=[new Ae(0,0,0,0,_e),new Ae(4,4,8,4,Ce),new Ae(4,5,16,8,Ce),new Ae(4,6,32,32,Ce),new Ae(4,4,16,16,Ie),new Ae(8,16,32,32,Ie),new Ae(8,16,128,128,Ie),new Ae(8,32,128,256,Ie),new Ae(32,128,258,1024,Ie),new Ae(32,258,258,4096,Ie)];function Ue(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=ue,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Se(this.dyn_ltree),Se(this.dyn_dtree),Se(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Se(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Se(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Me=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==pe&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==me&&t.status!==fe?1:0},Ee=e=>{if(Me(e))return he(e,X);e.total_in=e.total_out=0,e.data_type=le;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?pe:me,e.adler=2===t.wrap?0:1,t.last_flush=-2,G(t),Q},Fe=e=>{const t=Ee(e);var r;return t===Q&&((r=e.state).window_size=2*r.w_size,Se(r.head),r.max_lazy_match=De[r.level].max_lazy,r.good_match=De[r.level].good_length,r.nice_match=De[r.level].nice_length,r.max_chain_length=De[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=2,r.match_available=0,r.ins_h=0),t},Le=(e,t,r,i,s,n)=>{if(!e)return X;let o=1;if(t===re&&(t=6),i<0?(o=0,i=-i):i>15&&(o=2,i-=16),s<1||s>9||r!==ue||i<8||i>15||t<0||t>9||n<0||n>oe||8===i&&1!==o)return he(e,X);8===i&&(i=9);const a=new Ue;return e.state=a,a.strm=e,a.status=pe,a.wrap=o,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=n,a.method=r,Fe(e)};var Oe={deflateInit:(e,t)=>Le(e,t,ue,15,8,ae),deflateInit2:Le,deflateReset:Fe,deflateResetKeep:Ee,deflateSetHeader:(e,t)=>Me(e)||2!==e.state.wrap?X:(e.state.gzhead=t,Q),deflate:(e,t)=>{if(Me(e)||t>J||t<0)return e?he(e,X):X;const r=e.state;if(!e.output||0!==e.avail_in&&!e.input||r.status===fe&&t!==K)return he(e,0===e.avail_out?te:X);const i=r.last_flush;if(r.last_flush=t,0!==r.pending){if(xe(e),0===e.avail_out)return r.last_flush=-1,Q}else if(0===e.avail_in&&ge(t)<=ge(i)&&t!==K)return he(e,te);if(r.status===fe&&0!==e.avail_in)return he(e,te);if(r.status===pe&&0===r.wrap&&(r.status=me),r.status===pe){let t=ue+(r.w_bits-8<<4)<<8,i=-1;if(i=r.strategy>=se||r.level<2?0:r.level<6?1:6===r.level?2:3,t|=i<<6,0!==r.strstart&&(t|=32),t+=31-t%31,Re(r,t),0!==r.strstart&&(Re(r,e.adler>>>16),Re(r,65535&e.adler)),e.adler=1,r.status=me,xe(e),0!==r.pending)return r.last_flush=-1,Q}if(57===r.status)if(e.adler=0,Pe(r,31),Pe(r,139),Pe(r,8),r.gzhead)Pe(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),Pe(r,255&r.gzhead.time),Pe(r,r.gzhead.time>>8&255),Pe(r,r.gzhead.time>>16&255),Pe(r,r.gzhead.time>>24&255),Pe(r,9===r.level?2:r.strategy>=se||r.level<2?4:0),Pe(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(Pe(r,255&r.gzhead.extra.length),Pe(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=N(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69;else if(Pe(r,0),Pe(r,0),Pe(r,0),Pe(r,0),Pe(r,0),Pe(r,9===r.level?2:r.strategy>=se||r.level<2?4:0),Pe(r,3),r.status=me,xe(e),0!==r.pending)return r.last_flush=-1,Q;if(69===r.status){if(r.gzhead.extra){let t=r.pending,i=(65535&r.gzhead.extra.length)-r.gzindex;for(;r.pending+i>r.pending_buf_size;){let s=r.pending_buf_size-r.pending;if(r.pending_buf.set(r.gzhead.extra.subarray(r.gzindex,r.gzindex+s),r.pending),r.pending=r.pending_buf_size,r.gzhead.hcrc&&r.pending>t&&(e.adler=N(e.adler,r.pending_buf,r.pending-t,t)),r.gzindex+=s,xe(e),0!==r.pending)return r.last_flush=-1,Q;t=0,i-=s}let s=new Uint8Array(r.gzhead.extra);r.pending_buf.set(s.subarray(r.gzindex,r.gzindex+i),r.pending),r.pending+=i,r.gzhead.hcrc&&r.pending>t&&(e.adler=N(e.adler,r.pending_buf,r.pending-t,t)),r.gzindex=0}r.status=73}if(73===r.status){if(r.gzhead.name){let t,i=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>i&&(e.adler=N(e.adler,r.pending_buf,r.pending-i,i)),xe(e),0!==r.pending)return r.last_flush=-1,Q;i=0}t=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,Pe(r,t)}while(0!==t);r.gzhead.hcrc&&r.pending>i&&(e.adler=N(e.adler,r.pending_buf,r.pending-i,i)),r.gzindex=0}r.status=91}if(91===r.status){if(r.gzhead.comment){let t,i=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>i&&(e.adler=N(e.adler,r.pending_buf,r.pending-i,i)),xe(e),0!==r.pending)return r.last_flush=-1,Q;i=0}t=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,Pe(r,t)}while(0!==t);r.gzhead.hcrc&&r.pending>i&&(e.adler=N(e.adler,r.pending_buf,r.pending-i,i))}r.status=103}if(103===r.status){if(r.gzhead.hcrc){if(r.pending+2>r.pending_buf_size&&(xe(e),0!==r.pending))return r.last_flush=-1,Q;Pe(r,255&e.adler),Pe(r,e.adler>>8&255),e.adler=0}if(r.status=me,xe(e),0!==r.pending)return r.last_flush=-1,Q}if(0!==e.avail_in||0!==r.lookahead||t!==q&&r.status!==fe){let i=0===r.level?_e(r,t):r.strategy===se?((e,t)=>{let r;for(;;){if(0===e.lookahead&&(ke(e),0===e.lookahead)){if(t===q)return 1;break}if(e.match_length=0,r=$(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(ve(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===K?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2})(r,t):r.strategy===ne?((e,t)=>{let r,i,s,n;const o=e.window;for(;;){if(e.lookahead<=ce){if(ke(e),e.lookahead<=ce&&t===q)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(s=e.strstart-1,i=o[s],i===o[++s]&&i===o[++s]&&i===o[++s])){n=e.strstart+ce;do{}while(i===o[++s]&&i===o[++s]&&i===o[++s]&&i===o[++s]&&i===o[++s]&&i===o[++s]&&i===o[++s]&&i===o[++s]&&s<n);e.match_length=ce-(n-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(r=$(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=$(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(ve(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===K?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2})(r,t):De[r.level].func(r,t);if(3!==i&&4!==i||(r.status=fe),1===i||3===i)return 0===e.avail_out&&(r.last_flush=-1),Q;if(2===i&&(t===V?j(r):t!==J&&(H(r,0,0,!1),t===Z&&(Se(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),xe(e),0===e.avail_out))return r.last_flush=-1,Q}return t!==K?Q:r.wrap<=0?Y:(2===r.wrap?(Pe(r,255&e.adler),Pe(r,e.adler>>8&255),Pe(r,e.adler>>16&255),Pe(r,e.adler>>24&255),Pe(r,255&e.total_in),Pe(r,e.total_in>>8&255),Pe(r,e.total_in>>16&255),Pe(r,e.total_in>>24&255)):(Re(r,e.adler>>>16),Re(r,65535&e.adler)),xe(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?Q:Y)},deflateEnd:e=>{if(Me(e))return X;const t=e.state.status;return e.state=null,t===me?he(e,ee):Q},deflateSetDictionary:(e,t)=>{let r=t.length;if(Me(e))return X;const i=e.state,s=i.wrap;if(2===s||1===s&&i.status!==pe||i.lookahead)return X;if(1===s&&(e.adler=L(e.adler,t,r,0)),i.wrap=0,r>=i.w_size){0===s&&(Se(i.head),i.strstart=0,i.block_start=0,i.insert=0);let e=new Uint8Array(i.w_size);e.set(t.subarray(r-i.w_size,r),0),t=e,r=i.w_size}const n=e.avail_in,o=e.next_in,a=e.input;for(e.avail_in=r,e.next_in=0,e.input=t,ke(i);i.lookahead>=3;){let e=i.strstart,t=i.lookahead-2;do{i.ins_h=be(i,i.ins_h,i.window[e+3-1]),i.prev[e&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=e,e++}while(--t);i.strstart=e,i.lookahead=2,ke(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=o,e.input=a,e.avail_in=n,i.wrap=s,Q},deflateInfo:"pako deflate (from Nodeca project)"};const Ne=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Be={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(const t in r)Ne(r,t)&&(e[t]=r[t])}}return e},flattenChunks:e=>{let t=0;for(let r=0,i=e.length;r<i;r++)t+=e[r].length;const r=new Uint8Array(t);for(let t=0,i=0,s=e.length;t<s;t++){let s=e[t];r.set(s,i),i+=s.length}return r}};let ze=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){ze=!1}const Ge=new Uint8Array(256);for(let e=0;e<256;e++)Ge[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Ge[254]=Ge[254]=1;var He={string2buf:e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,r,i,s,n,o=e.length,a=0;for(s=0;s<o;s++)r=e.charCodeAt(s),55296==(64512&r)&&s+1<o&&(i=e.charCodeAt(s+1),56320==(64512&i)&&(r=65536+(r-55296<<10)+(i-56320),s++)),a+=r<128?1:r<2048?2:r<65536?3:4;for(t=new Uint8Array(a),n=0,s=0;n<a;s++)r=e.charCodeAt(s),55296==(64512&r)&&s+1<o&&(i=e.charCodeAt(s+1),56320==(64512&i)&&(r=65536+(r-55296<<10)+(i-56320),s++)),r<128?t[n++]=r:r<2048?(t[n++]=192|r>>>6,t[n++]=128|63&r):r<65536?(t[n++]=224|r>>>12,t[n++]=128|r>>>6&63,t[n++]=128|63&r):(t[n++]=240|r>>>18,t[n++]=128|r>>>12&63,t[n++]=128|r>>>6&63,t[n++]=128|63&r);return t},buf2string:(e,t)=>{const r=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let i,s;const n=new Array(2*r);for(s=0,i=0;i<r;){let t=e[i++];if(t<128){n[s++]=t;continue}let o=Ge[t];if(o>4)n[s++]=65533,i+=o-1;else{for(t&=2===o?31:3===o?15:7;o>1&&i<r;)t=t<<6|63&e[i++],o--;o>1?n[s++]=65533:t<65536?n[s++]=t:(t-=65536,n[s++]=55296|t>>10&1023,n[s++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&ze)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(e[i]);return r})(n,s)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let r=t-1;for(;r>=0&&128==(192&e[r]);)r--;return r<0||0===r?t:r+Ge[e[r]]>t?r:t}},We=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const $e=Object.prototype.toString,{Z_NO_FLUSH:je,Z_SYNC_FLUSH:qe,Z_FULL_FLUSH:Ve,Z_FINISH:Ze,Z_OK:Ke,Z_STREAM_END:Je,Z_DEFAULT_COMPRESSION:Qe,Z_DEFAULT_STRATEGY:Ye,Z_DEFLATED:Xe}=z;function et(e){this.options=Be.assign({level:Qe,method:Xe,chunkSize:16384,windowBits:15,memLevel:8,strategy:Ye},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new We,this.strm.avail_out=0;let r=Oe.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(r!==Ke)throw new Error(B[r]);if(t.header&&Oe.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?He.string2buf(t.dictionary):"[object ArrayBuffer]"===$e.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,r=Oe.deflateSetDictionary(this.strm,e),r!==Ke)throw new Error(B[r]);this._dict_set=!0}}function tt(e,t){const r=new et(t);if(r.push(e,!0),r.err)throw r.msg||B[r.err];return r.result}et.prototype.push=function(e,t){const r=this.strm,i=this.options.chunkSize;let s,n;if(this.ended)return!1;for(n=t===~~t?t:!0===t?Ze:je,"string"==typeof e?r.input=He.string2buf(e):"[object ArrayBuffer]"===$e.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;;)if(0===r.avail_out&&(r.output=new Uint8Array(i),r.next_out=0,r.avail_out=i),(n===qe||n===Ve)&&r.avail_out<=6)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else{if(s=Oe.deflate(r,n),s===Je)return r.next_out>0&&this.onData(r.output.subarray(0,r.next_out)),s=Oe.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===Ke;if(0!==r.avail_out){if(n>0&&r.next_out>0)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else if(0===r.avail_in)break}else this.onData(r.output)}return!0},et.prototype.onData=function(e){this.chunks.push(e)},et.prototype.onEnd=function(e){e===Ke&&(this.result=Be.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var rt={Deflate:et,deflate:tt,deflateRaw:function(e,t){return(t=t||{}).raw=!0,tt(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,tt(e,t)},constants:z};const it=16209;var st=function(e,t){let r,i,s,n,o,a,l,u,c,d,p,m,f,h,g,S,y,b,x,v,P,R,w,T;const k=e.state;r=e.next_in,w=e.input,i=r+(e.avail_in-5),s=e.next_out,T=e.output,n=s-(t-e.avail_out),o=s+(e.avail_out-257),a=k.dmax,l=k.wsize,u=k.whave,c=k.wnext,d=k.window,p=k.hold,m=k.bits,f=k.lencode,h=k.distcode,g=(1<<k.lenbits)-1,S=(1<<k.distbits)-1;e:do{m<15&&(p+=w[r++]<<m,m+=8,p+=w[r++]<<m,m+=8),y=f[p&g];t:for(;;){if(b=y>>>24,p>>>=b,m-=b,b=y>>>16&255,0===b)T[s++]=65535&y;else{if(!(16&b)){if(0==(64&b)){y=f[(65535&y)+(p&(1<<b)-1)];continue t}if(32&b){k.mode=16191;break e}e.msg="invalid literal/length code",k.mode=it;break e}x=65535&y,b&=15,b&&(m<b&&(p+=w[r++]<<m,m+=8),x+=p&(1<<b)-1,p>>>=b,m-=b),m<15&&(p+=w[r++]<<m,m+=8,p+=w[r++]<<m,m+=8),y=h[p&S];r:for(;;){if(b=y>>>24,p>>>=b,m-=b,b=y>>>16&255,!(16&b)){if(0==(64&b)){y=h[(65535&y)+(p&(1<<b)-1)];continue r}e.msg="invalid distance code",k.mode=it;break e}if(v=65535&y,b&=15,m<b&&(p+=w[r++]<<m,m+=8,m<b&&(p+=w[r++]<<m,m+=8)),v+=p&(1<<b)-1,v>a){e.msg="invalid distance too far back",k.mode=it;break e}if(p>>>=b,m-=b,b=s-n,v>b){if(b=v-b,b>u&&k.sane){e.msg="invalid distance too far back",k.mode=it;break e}if(P=0,R=d,0===c){if(P+=l-b,b<x){x-=b;do{T[s++]=d[P++]}while(--b);P=s-v,R=T}}else if(c<b){if(P+=l+c-b,b-=c,b<x){x-=b;do{T[s++]=d[P++]}while(--b);if(P=0,c<x){b=c,x-=b;do{T[s++]=d[P++]}while(--b);P=s-v,R=T}}}else if(P+=c-b,b<x){x-=b;do{T[s++]=d[P++]}while(--b);P=s-v,R=T}for(;x>2;)T[s++]=R[P++],T[s++]=R[P++],T[s++]=R[P++],x-=3;x&&(T[s++]=R[P++],x>1&&(T[s++]=R[P++]))}else{P=s-v;do{T[s++]=T[P++],T[s++]=T[P++],T[s++]=T[P++],x-=3}while(x>2);x&&(T[s++]=T[P++],x>1&&(T[s++]=T[P++]))}break}}break}}while(r<i&&s<o);x=m>>3,r-=x,m-=x<<3,p&=(1<<m)-1,e.next_in=r,e.next_out=s,e.avail_in=r<i?i-r+5:5-(r-i),e.avail_out=s<o?o-s+257:257-(s-o),k.hold=p,k.bits=m};const nt=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ot=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),at=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),lt=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var ut=(e,t,r,i,s,n,o,a)=>{const l=a.bits;let u,c,d,p,m,f,h=0,g=0,S=0,y=0,b=0,x=0,v=0,P=0,R=0,w=0,T=null;const k=new Uint16Array(16),_=new Uint16Array(16);let C,I,A,D=null;for(h=0;h<=15;h++)k[h]=0;for(g=0;g<i;g++)k[t[r+g]]++;for(b=l,y=15;y>=1&&0===k[y];y--);if(b>y&&(b=y),0===y)return s[n++]=20971520,s[n++]=20971520,a.bits=1,0;for(S=1;S<y&&0===k[S];S++);for(b<S&&(b=S),P=1,h=1;h<=15;h++)if(P<<=1,P-=k[h],P<0)return-1;if(P>0&&(0===e||1!==y))return-1;for(_[1]=0,h=1;h<15;h++)_[h+1]=_[h]+k[h];for(g=0;g<i;g++)0!==t[r+g]&&(o[_[t[r+g]]++]=g);if(0===e?(T=D=o,f=20):1===e?(T=nt,D=ot,f=257):(T=at,D=lt,f=0),w=0,g=0,h=S,m=n,x=b,v=0,d=-1,R=1<<b,p=R-1,1===e&&R>852||2===e&&R>592)return 1;for(;;){C=h-v,o[g]+1<f?(I=0,A=o[g]):o[g]>=f?(I=D[o[g]-f],A=T[o[g]-f]):(I=96,A=0),u=1<<h-v,c=1<<x,S=c;do{c-=u,s[m+(w>>v)+c]=C<<24|I<<16|A|0}while(0!==c);for(u=1<<h-1;w&u;)u>>=1;if(0!==u?(w&=u-1,w+=u):w=0,g++,0==--k[h]){if(h===y)break;h=t[r+o[g]]}if(h>b&&(w&p)!==d){for(0===v&&(v=b),m+=S,x=h-v,P=1<<x;x+v<y&&(P-=k[x+v],!(P<=0));)x++,P<<=1;if(R+=1<<x,1===e&&R>852||2===e&&R>592)return 1;d=w&p,s[d]=b<<24|x<<16|m-n|0}}return 0!==w&&(s[m+w]=h-v<<24|64<<16|0),a.bits=b,0};const{Z_FINISH:ct,Z_BLOCK:dt,Z_TREES:pt,Z_OK:mt,Z_STREAM_END:ft,Z_NEED_DICT:ht,Z_STREAM_ERROR:gt,Z_DATA_ERROR:St,Z_MEM_ERROR:yt,Z_BUF_ERROR:bt,Z_DEFLATED:xt}=z,vt=16180,Pt=16190,Rt=16191,wt=16192,Tt=16194,kt=16199,_t=16200,Ct=16206,It=16209,At=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Dt(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Ut=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<vt||t.mode>16211?1:0},Mt=e=>{if(Ut(e))return gt;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=vt,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,mt},Et=e=>{if(Ut(e))return gt;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Mt(e)},Ft=(e,t)=>{let r;if(Ut(e))return gt;const i=e.state;return t<0?(r=0,t=-t):(r=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?gt:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=r,i.wbits=t,Et(e))},Lt=(e,t)=>{if(!e)return gt;const r=new Dt;e.state=r,r.strm=e,r.window=null,r.mode=vt;const i=Ft(e,t);return i!==mt&&(e.state=null),i};let Ot,Nt,Bt=!0;const zt=e=>{if(Bt){Ot=new Int32Array(512),Nt=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(ut(1,e.lens,0,288,Ot,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;ut(2,e.lens,0,32,Nt,0,e.work,{bits:5}),Bt=!1}e.lencode=Ot,e.lenbits=9,e.distcode=Nt,e.distbits=5},Gt=(e,t,r,i)=>{let s;const n=e.state;return null===n.window&&(n.wsize=1<<n.wbits,n.wnext=0,n.whave=0,n.window=new Uint8Array(n.wsize)),i>=n.wsize?(n.window.set(t.subarray(r-n.wsize,r),0),n.wnext=0,n.whave=n.wsize):(s=n.wsize-n.wnext,s>i&&(s=i),n.window.set(t.subarray(r-i,r-i+s),n.wnext),(i-=s)?(n.window.set(t.subarray(r-i,r),0),n.wnext=i,n.whave=n.wsize):(n.wnext+=s,n.wnext===n.wsize&&(n.wnext=0),n.whave<n.wsize&&(n.whave+=s))),0};var Ht={inflateReset:Et,inflateReset2:Ft,inflateResetKeep:Mt,inflateInit:e=>Lt(e,15),inflateInit2:Lt,inflate:(e,t)=>{let r,i,s,n,o,a,l,u,c,d,p,m,f,h,g,S,y,b,x,v,P,R,w=0;const T=new Uint8Array(4);let k,_;const C=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Ut(e)||!e.output||!e.input&&0!==e.avail_in)return gt;r=e.state,r.mode===Rt&&(r.mode=wt),o=e.next_out,s=e.output,l=e.avail_out,n=e.next_in,i=e.input,a=e.avail_in,u=r.hold,c=r.bits,d=a,p=l,R=mt;e:for(;;)switch(r.mode){case vt:if(0===r.wrap){r.mode=wt;break}for(;c<16;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(2&r.wrap&&35615===u){0===r.wbits&&(r.wbits=15),r.check=0,T[0]=255&u,T[1]=u>>>8&255,r.check=N(r.check,T,2,0),u=0,c=0,r.mode=16181;break}if(r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",r.mode=It;break}if((15&u)!==xt){e.msg="unknown compression method",r.mode=It;break}if(u>>>=4,c-=4,P=8+(15&u),0===r.wbits&&(r.wbits=P),P>15||P>r.wbits){e.msg="invalid window size",r.mode=It;break}r.dmax=1<<r.wbits,r.flags=0,e.adler=r.check=1,r.mode=512&u?16189:Rt,u=0,c=0;break;case 16181:for(;c<16;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(r.flags=u,(255&r.flags)!==xt){e.msg="unknown compression method",r.mode=It;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=It;break}r.head&&(r.head.text=u>>8&1),512&r.flags&&4&r.wrap&&(T[0]=255&u,T[1]=u>>>8&255,r.check=N(r.check,T,2,0)),u=0,c=0,r.mode=16182;case 16182:for(;c<32;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}r.head&&(r.head.time=u),512&r.flags&&4&r.wrap&&(T[0]=255&u,T[1]=u>>>8&255,T[2]=u>>>16&255,T[3]=u>>>24&255,r.check=N(r.check,T,4,0)),u=0,c=0,r.mode=16183;case 16183:for(;c<16;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&4&r.wrap&&(T[0]=255&u,T[1]=u>>>8&255,r.check=N(r.check,T,2,0)),u=0,c=0,r.mode=16184;case 16184:if(1024&r.flags){for(;c<16;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&4&r.wrap&&(T[0]=255&u,T[1]=u>>>8&255,r.check=N(r.check,T,2,0)),u=0,c=0}else r.head&&(r.head.extra=null);r.mode=16185;case 16185:if(1024&r.flags&&(m=r.length,m>a&&(m=a),m&&(r.head&&(P=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Uint8Array(r.head.extra_len)),r.head.extra.set(i.subarray(n,n+m),P)),512&r.flags&&4&r.wrap&&(r.check=N(r.check,i,m,n)),a-=m,n+=m,r.length-=m),r.length))break e;r.length=0,r.mode=16186;case 16186:if(2048&r.flags){if(0===a)break e;m=0;do{P=i[n+m++],r.head&&P&&r.length<65536&&(r.head.name+=String.fromCharCode(P))}while(P&&m<a);if(512&r.flags&&4&r.wrap&&(r.check=N(r.check,i,m,n)),a-=m,n+=m,P)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=16187;case 16187:if(4096&r.flags){if(0===a)break e;m=0;do{P=i[n+m++],r.head&&P&&r.length<65536&&(r.head.comment+=String.fromCharCode(P))}while(P&&m<a);if(512&r.flags&&4&r.wrap&&(r.check=N(r.check,i,m,n)),a-=m,n+=m,P)break e}else r.head&&(r.head.comment=null);r.mode=16188;case 16188:if(512&r.flags){for(;c<16;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(4&r.wrap&&u!==(65535&r.check)){e.msg="header crc mismatch",r.mode=It;break}u=0,c=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=Rt;break;case 16189:for(;c<32;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}e.adler=r.check=At(u),u=0,c=0,r.mode=Pt;case Pt:if(0===r.havedict)return e.next_out=o,e.avail_out=l,e.next_in=n,e.avail_in=a,r.hold=u,r.bits=c,ht;e.adler=r.check=1,r.mode=Rt;case Rt:if(t===dt||t===pt)break e;case wt:if(r.last){u>>>=7&c,c-=7&c,r.mode=Ct;break}for(;c<3;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}switch(r.last=1&u,u>>>=1,c-=1,3&u){case 0:r.mode=16193;break;case 1:if(zt(r),r.mode=kt,t===pt){u>>>=2,c-=2;break e}break;case 2:r.mode=16196;break;case 3:e.msg="invalid block type",r.mode=It}u>>>=2,c-=2;break;case 16193:for(u>>>=7&c,c-=7&c;c<32;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",r.mode=It;break}if(r.length=65535&u,u=0,c=0,r.mode=Tt,t===pt)break e;case Tt:r.mode=16195;case 16195:if(m=r.length,m){if(m>a&&(m=a),m>l&&(m=l),0===m)break e;s.set(i.subarray(n,n+m),o),a-=m,n+=m,l-=m,o+=m,r.length-=m;break}r.mode=Rt;break;case 16196:for(;c<14;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(r.nlen=257+(31&u),u>>>=5,c-=5,r.ndist=1+(31&u),u>>>=5,c-=5,r.ncode=4+(15&u),u>>>=4,c-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=It;break}r.have=0,r.mode=16197;case 16197:for(;r.have<r.ncode;){for(;c<3;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}r.lens[C[r.have++]]=7&u,u>>>=3,c-=3}for(;r.have<19;)r.lens[C[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,k={bits:r.lenbits},R=ut(0,r.lens,0,19,r.lencode,0,r.work,k),r.lenbits=k.bits,R){e.msg="invalid code lengths set",r.mode=It;break}r.have=0,r.mode=16198;case 16198:for(;r.have<r.nlen+r.ndist;){for(;w=r.lencode[u&(1<<r.lenbits)-1],g=w>>>24,S=w>>>16&255,y=65535&w,!(g<=c);){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(y<16)u>>>=g,c-=g,r.lens[r.have++]=y;else{if(16===y){for(_=g+2;c<_;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(u>>>=g,c-=g,0===r.have){e.msg="invalid bit length repeat",r.mode=It;break}P=r.lens[r.have-1],m=3+(3&u),u>>>=2,c-=2}else if(17===y){for(_=g+3;c<_;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}u>>>=g,c-=g,P=0,m=3+(7&u),u>>>=3,c-=3}else{for(_=g+7;c<_;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}u>>>=g,c-=g,P=0,m=11+(127&u),u>>>=7,c-=7}if(r.have+m>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=It;break}for(;m--;)r.lens[r.have++]=P}}if(r.mode===It)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=It;break}if(r.lenbits=9,k={bits:r.lenbits},R=ut(1,r.lens,0,r.nlen,r.lencode,0,r.work,k),r.lenbits=k.bits,R){e.msg="invalid literal/lengths set",r.mode=It;break}if(r.distbits=6,r.distcode=r.distdyn,k={bits:r.distbits},R=ut(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,k),r.distbits=k.bits,R){e.msg="invalid distances set",r.mode=It;break}if(r.mode=kt,t===pt)break e;case kt:r.mode=_t;case _t:if(a>=6&&l>=258){e.next_out=o,e.avail_out=l,e.next_in=n,e.avail_in=a,r.hold=u,r.bits=c,st(e,p),o=e.next_out,s=e.output,l=e.avail_out,n=e.next_in,i=e.input,a=e.avail_in,u=r.hold,c=r.bits,r.mode===Rt&&(r.back=-1);break}for(r.back=0;w=r.lencode[u&(1<<r.lenbits)-1],g=w>>>24,S=w>>>16&255,y=65535&w,!(g<=c);){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(S&&0==(240&S)){for(b=g,x=S,v=y;w=r.lencode[v+((u&(1<<b+x)-1)>>b)],g=w>>>24,S=w>>>16&255,y=65535&w,!(b+g<=c);){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}u>>>=b,c-=b,r.back+=b}if(u>>>=g,c-=g,r.back+=g,r.length=y,0===S){r.mode=16205;break}if(32&S){r.back=-1,r.mode=Rt;break}if(64&S){e.msg="invalid literal/length code",r.mode=It;break}r.extra=15&S,r.mode=16201;case 16201:if(r.extra){for(_=r.extra;c<_;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,c-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=16202;case 16202:for(;w=r.distcode[u&(1<<r.distbits)-1],g=w>>>24,S=w>>>16&255,y=65535&w,!(g<=c);){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(0==(240&S)){for(b=g,x=S,v=y;w=r.distcode[v+((u&(1<<b+x)-1)>>b)],g=w>>>24,S=w>>>16&255,y=65535&w,!(b+g<=c);){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}u>>>=b,c-=b,r.back+=b}if(u>>>=g,c-=g,r.back+=g,64&S){e.msg="invalid distance code",r.mode=It;break}r.offset=y,r.extra=15&S,r.mode=16203;case 16203:if(r.extra){for(_=r.extra;c<_;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,c-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=It;break}r.mode=16204;case 16204:if(0===l)break e;if(m=p-l,r.offset>m){if(m=r.offset-m,m>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=It;break}m>r.wnext?(m-=r.wnext,f=r.wsize-m):f=r.wnext-m,m>r.length&&(m=r.length),h=r.window}else h=s,f=o-r.offset,m=r.length;m>l&&(m=l),l-=m,r.length-=m;do{s[o++]=h[f++]}while(--m);0===r.length&&(r.mode=_t);break;case 16205:if(0===l)break e;s[o++]=r.length,l--,r.mode=_t;break;case Ct:if(r.wrap){for(;c<32;){if(0===a)break e;a--,u|=i[n++]<<c,c+=8}if(p-=l,e.total_out+=p,r.total+=p,4&r.wrap&&p&&(e.adler=r.check=r.flags?N(r.check,s,p,o-p):L(r.check,s,p,o-p)),p=l,4&r.wrap&&(r.flags?u:At(u))!==r.check){e.msg="incorrect data check",r.mode=It;break}u=0,c=0}r.mode=16207;case 16207:if(r.wrap&&r.flags){for(;c<32;){if(0===a)break e;a--,u+=i[n++]<<c,c+=8}if(4&r.wrap&&u!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=It;break}u=0,c=0}r.mode=16208;case 16208:R=ft;break e;case It:R=St;break e;case 16210:return yt;default:return gt}return e.next_out=o,e.avail_out=l,e.next_in=n,e.avail_in=a,r.hold=u,r.bits=c,(r.wsize||p!==e.avail_out&&r.mode<It&&(r.mode<Ct||t!==ct))&&Gt(e,e.output,e.next_out,p-e.avail_out),d-=e.avail_in,p-=e.avail_out,e.total_in+=d,e.total_out+=p,r.total+=p,4&r.wrap&&p&&(e.adler=r.check=r.flags?N(r.check,s,p,e.next_out-p):L(r.check,s,p,e.next_out-p)),e.data_type=r.bits+(r.last?64:0)+(r.mode===Rt?128:0)+(r.mode===kt||r.mode===Tt?256:0),(0===d&&0===p||t===ct)&&R===mt&&(R=bt),R},inflateEnd:e=>{if(Ut(e))return gt;let t=e.state;return t.window&&(t.window=null),e.state=null,mt},inflateGetHeader:(e,t)=>{if(Ut(e))return gt;const r=e.state;return 0==(2&r.wrap)?gt:(r.head=t,t.done=!1,mt)},inflateSetDictionary:(e,t)=>{const r=t.length;let i,s,n;return Ut(e)?gt:(i=e.state,0!==i.wrap&&i.mode!==Pt?gt:i.mode===Pt&&(s=1,s=L(s,t,r,0),s!==i.check)?St:(n=Gt(e,t,r,r),n?(i.mode=16210,yt):(i.havedict=1,mt)))},inflateInfo:"pako inflate (from Nodeca project)"},Wt=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const $t=Object.prototype.toString,{Z_NO_FLUSH:jt,Z_FINISH:qt,Z_OK:Vt,Z_STREAM_END:Zt,Z_NEED_DICT:Kt,Z_STREAM_ERROR:Jt,Z_DATA_ERROR:Qt,Z_MEM_ERROR:Yt}=z;function Xt(e){this.options=Be.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new We,this.strm.avail_out=0;let r=Ht.inflateInit2(this.strm,t.windowBits);if(r!==Vt)throw new Error(B[r]);if(this.header=new Wt,Ht.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=He.string2buf(t.dictionary):"[object ArrayBuffer]"===$t.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(r=Ht.inflateSetDictionary(this.strm,t.dictionary),r!==Vt)))throw new Error(B[r])}function er(e,t){const r=new Xt(t);if(r.push(e),r.err)throw r.msg||B[r.err];return r.result}Xt.prototype.push=function(e,t){const r=this.strm,i=this.options.chunkSize,s=this.options.dictionary;let n,o,a;if(this.ended)return!1;for(o=t===~~t?t:!0===t?qt:jt,"[object ArrayBuffer]"===$t.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;;){for(0===r.avail_out&&(r.output=new Uint8Array(i),r.next_out=0,r.avail_out=i),n=Ht.inflate(r,o),n===Kt&&s&&(n=Ht.inflateSetDictionary(r,s),n===Vt?n=Ht.inflate(r,o):n===Qt&&(n=Kt));r.avail_in>0&&n===Zt&&r.state.wrap>0&&0!==e[r.next_in];)Ht.inflateReset(r),n=Ht.inflate(r,o);switch(n){case Jt:case Qt:case Kt:case Yt:return this.onEnd(n),this.ended=!0,!1}if(a=r.avail_out,r.next_out&&(0===r.avail_out||n===Zt))if("string"===this.options.to){let e=He.utf8border(r.output,r.next_out),t=r.next_out-e,s=He.buf2string(r.output,e);r.next_out=t,r.avail_out=i-t,t&&r.output.set(r.output.subarray(e,e+t),0),this.onData(s)}else this.onData(r.output.length===r.next_out?r.output:r.output.subarray(0,r.next_out));if(n!==Vt||0!==a){if(n===Zt)return n=Ht.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,!0;if(0===r.avail_in)break}}return!0},Xt.prototype.onData=function(e){this.chunks.push(e)},Xt.prototype.onEnd=function(e){e===Vt&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Be.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var tr={Inflate:Xt,inflate:er,inflateRaw:function(e,t){return(t=t||{}).raw=!0,er(e,t)},ungzip:er,constants:z};const{Deflate:rr,deflate:ir,deflateRaw:sr,gzip:nr}=rt,{Inflate:or,inflate:ar,inflateRaw:lr,ungzip:ur}=tr;var cr=rr,dr=ir,pr=sr,mr=nr,fr=or,hr=ar,gr=lr,Sr=ur,yr=z,br={Deflate:rr,deflate:ir,deflateRaw:sr,gzip:nr,Inflate:or,inflate:ar,inflateRaw:lr,ungzip:ur,constants:z}}},t={};function r(i){var s=t[i];if(void 0!==s)return s.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{"use strict";var e={};r.r(e),r.d(e,{settingsPage:()=>f});var t=r("./src/ui/code/CommonUi.ts"),i=r("./src/lib/PolyFill.ts"),s=r("./src/lib/External.ts"),n=r("./src/lib/environment.ts"),o=r("./src/lib/Utils.ts"),a=r("./src/lib/ProxyImporter.ts"),l=r("./src/lib/RuleImporter.ts"),u=r("./src/core/definitions.ts"),c=r("./src/lib/Debug.ts"),d=r("./src/core/ProfileOperations.ts"),p=r("./src/core/SettingsOperation.ts");const m=s.jQuery;class f{static initialize(){f.registerMessageReader(),t.CommonUi.onDocumentReady(this.initializeAboutTab),t.CommonUi.onDocumentReady(this.localizeUi),t.CommonUi.onDocumentReady(this.bindEvents),t.CommonUi.onDocumentReady(this.initializeGrids),t.CommonUi.onDocumentReady(this.initializeUi),f.readSettingsPageData()}static handleMessages(e,t,r){let i;if(i="string"==typeof e?e:e.command,i===u.CommandMessages.SettingsPageGetInitialDataResponse){let t=e.settingsPageInitialData;f.applySettingsPageData(t)}}static registerMessageReader(){n.api.runtime.onMessage.addListener(f.handleMessages)}static readSettingsPageData(){i.PolyFill.runtimeSendMessage(u.CommandMessages.SettingsPageGetInitialData,(e=>{e?f.applySettingsPageData(e):n.environment.chrome||s.messageBox.error(n.api.i18n.getMessage("settingsInitializeFailed"))}),(e=>{i.PolyFill.runtimeSendMessage("SettingsPageGetInitialData failed! > "+e),s.messageBox.error(n.api.i18n.getMessage("settingsInitializeFailed"))}))}static applySettingsPageData(e){e&&(f.settingsLoaded||(f.settingsLoaded=!0,f.localizeUi(),t.CommonUi.applyThemes(e.settings.options),t.CommonUi.onDocumentReady((()=>f.populateDataForSettings(e))),t.CommonUi.onDocumentReady(f.showNewUserWelcome)))}static populateDataForSettings(e){this.currentSettings=e.settings,t.CommonUi.applyThemes(this.currentSettings.options),this.populateSettingsUiData(e),this.loadServersGrid(this.currentSettings.proxyServers),this.loadServerSubscriptionsGrid(this.currentSettings.proxyServerSubscriptions),this.loadDefaultProxyServer(this.currentSettings.proxyServers,this.currentSettings.proxyServerSubscriptions),this.loadSmartProfiles(this.currentSettings.proxyProfiles),this.loadGeneralOptions(this.currentSettings.options),t.CommonUi.onDocumentReady(this.loadAllProfilesProxyServers),this.originalSettings=new u.SettingsConfig,this.originalSettings.CopyFrom(this.currentSettings)}static bindEvents(){m("#tabSettingsOffCanvas .nav-link").click(f.uiEvents.onClickMenuOffCanvas),m("#btnSkipWelcome").click(f.uiEvents.onClickSkipWelcome),m("#cmbGeneralIncognitoProfile").on("focus",f.uiEvents.onGeneralIncognitoProfileFocus),m("#btnSaveGeneralOptions").click(f.uiEvents.onClickSaveGeneralOptions),m("#btnRejectGeneralOptions").click(f.uiEvents.onClickRejectGeneralOptions),m("#chkSyncSettings").change(f.uiEvents.onSyncSettingsChanged),m("#btnIgnoreRequestFailuresForDomains").click(f.uiEvents.onClickIgnoreRequestFailuresForDomains),m("#btnViewShortcuts").click(f.uiEvents.onClickViewShortcuts),m("#cmbThemesLight").change(f.uiEvents.onChangeThemesLight),m("#cmbThemesDark").change(f.uiEvents.onChangeThemesDark),m(".menu-add-smart-profile").click(f.uiEvents.onClickAddNewSmartProfile),m("#btnSubmitContinueAddingProfile").click(f.uiEvents.onClickSubmitContinueAddingProfile),m("#cmbActiveProxyServer").on("change",f.uiEvents.onChangeActiveProxyServer),m("#btnAddProxyServer").click(f.uiEvents.onClickAddProxyServer),m("#btnRemoveMultipleProxyServer").click(f.uiEvents.onClickRemoveMultipleProxyServer),m("#cmdServerProtocol").on("change",f.uiEvents.onChangeServerProtocol),m("#btnSubmitProxyServer").click(f.uiEvents.onClickSubmitProxyServer),m("#btnSaveProxyServers").click(f.uiEvents.onClickSaveProxyServers),m("#btnRejectProxyServers").click(f.uiEvents.onClickRejectProxyServers),m("#btnClearProxyServers").click(f.uiEvents.onClickClearProxyServers),m("#btnExportProxyServerOpen,#btnExportProxyServerOpenBackup").click(f.uiEvents.onClickExportProxyServerOpenBackup),m("#btnImportProxyServer").click(f.uiEvents.onClickImportProxyServer),m("#btnBackupComplete").click(f.uiEvents.onClickBackupComplete),m("#btnRestoreBackup").click(f.uiEvents.onClickRestoreBackup),m("#btnFactoryReset").click(f.uiEvents.onClickFactoryReset),m("#btnAddServerSubscription").click(f.uiEvents.onClickAddServerSubscription),m("#btnRemoveMultipleServerSubscription").click(f.uiEvents.onClickRemoveMultipleServerSubscription),m("#btnSaveServerSubscription").click(f.uiEvents.onClickSaveServerSubscription),m("#btnTestServerSubscription").click(f.uiEvents.onClickTestServerSubscription),m("#btnClearServerSubscriptions").click(f.uiEvents.onClickClearServerSubscriptions),m("#btnSaveServerSubscriptionsChanges").click(f.uiEvents.onClickSaveServerSubscriptionsChanges),m("#btnRejectServerSubscriptionsChanges").click(f.uiEvents.onClickRejectServerSubscriptionsChanges),m("#btnEnableDiagnostics").click(f.uiEvents.onClickEnableDiagnostics),m(window).on("beforeunload",f.uiEvents.onWindowUnload)}static initializeGrids(){let e='<t><"row"<"col-sm-12 col-md-5"<"text-left float-left"f>><"col-sm-12 col-md-7"<"text-right"l>>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>';f.grdServers=m("#grdServers").DataTable({dom:e,paging:!0,select:{style:"os"},scrollY:460,scrollCollapse:!0,responsive:!0,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],ordering:!0,rowReorder:{dataSrc:"order",selector:"tr>td:first-child>i",snapX:!0},columnDefs:[{targets:0,visible:!1}],columns:[{name:"order",data:"order",title:"",defaultContent:'<i class="fas fa-random"></i>',width:20,orderable:!1},{name:"name",data:"name",title:n.api.i18n.getMessage("settingsServersGridColName"),render:(e,t,r)=>'<i class="fas fa-bars fa-xs px-2 cursor-move"></i>  '+(r.name||""),orderable:!1,responsivePriority:1},{name:"protocol",data:"protocol",title:n.api.i18n.getMessage("settingsServersGridColProtocol"),orderable:!1},{name:"host",data:"host",title:n.api.i18n.getMessage("settingsServersGridColServer"),orderable:!1},{name:"port",data:"port",type:"num",title:n.api.i18n.getMessage("settingsServersGridColPort"),orderable:!1},{width:"70px",data:null,orderable:!1,className:"text-nowrap",defaultContent:`<button class='btn btn-sm btn-success' id='btnServersEdit'>${n.api.i18n.getMessage("settingsEditButton")}</button> <button class='btn btn-sm btn-danger' id='btnServersRemove'><i class='fas fa-times'></button>`,responsivePriority:2}]}),f.grdServers.on("responsive-display",(function(e,t,r,i,s){let n=r.child();i&&n&&n.length&&f.refreshServersGridRowElement(n[0])})),f.grdServers.on("select deselect",(()=>{f.uiEvents.onRowSelectionChanged(f.grdServers,m("#btnRemoveMultipleProxyServer"))})),f.grdServers.draw(),f.grdServerSubscriptions=m("#grdServerSubscriptions").DataTable({dom:e,paging:!0,select:{style:"os"},scrollY:460,scrollCollapse:!0,responsive:!0,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],ordering:!1,columns:[{name:"name",data:"name",title:n.api.i18n.getMessage("settingsServerSubscriptionsGridColName"),responsivePriority:1},{name:"url",data:"url",title:n.api.i18n.getMessage("settingsServerSubscriptionsGridColUrl"),responsivePriority:3,render:(e,t,r)=>{let i=r.url,s=r.stats;if(s){let e=u.SubscriptionStats.ToString(s);r.stats.lastStatus?i+=` <div id='btnServerSubscriptionsViewStats' title='${e}' class='cursor-pointer float-end'><i class="fas fa-check-circle text-success"></i></div> `:i+=` <div id='btnServerSubscriptionsViewStats' title='${e}' class='cursor-pointer float-end'><i class="fas fa-exclamation-triangle text-danger"></i></div> `}return i}},{name:"totalCount",data:"totalCount",type:"num",title:n.api.i18n.getMessage("settingsServerSubscriptionsGridColCount")},{name:"enabled",data:"enabled",title:n.api.i18n.getMessage("settingsServerSubscriptionsGridColEnabled")},{width:"70px",data:null,className:"text-nowrap",defaultContent:`<button class='btn btn-sm btn-success' id='btnSubscriptionsEdit'>${n.api.i18n.getMessage("settingsEditButton")}</button> <button class='btn btn-sm btn-danger' id='btnSubscriptionsRemove'><i class='fas fa-times'></button>`,responsivePriority:2}]}),f.grdServerSubscriptions.on("responsive-display",(function(e,t,r,i,s){let n=r.child();i&&n&&n.length&&f.refreshServerSubscriptionsGridRowElement(n[0])})),f.grdServerSubscriptions.on("select deselect",(()=>{f.uiEvents.onRowSelectionChanged(f.grdServerSubscriptions,m("#btnRemoveMultipleServerSubscription"))})),f.grdServerSubscriptions.draw(),f.currentSettings?(f.currentSettings.proxyServers&&f.loadServersGrid(f.currentSettings.proxyServers),f.currentSettings.proxyServerSubscriptions&&f.loadServerSubscriptionsGrid(f.currentSettings.proxyServerSubscriptions)):(f.loadServersGrid([]),f.loadServerSubscriptionsGrid([])),m(".nav-link[href='#tab-servers'],\n\t\t\t.nav-link[href='#tab-server-subscriptions']").on("shown.bs.tab",(e=>{f.grdServers.columns.adjust().draw(),f.grdServerSubscriptions.columns.adjust().draw()}))}static localizeUi(){f.localized||(f.localized=!0,t.CommonUi.localizeHtmlPage())}static initializeUi(){n.environment.chrome?(m("#divAlertChrome").show().removeClass("d-none"),m(".firefox-only").hide(),m(".chrome-only").show().removeClass("d-none"),n.environment.manifestV3&&m(".chrome-mv3-only").show().removeClass("d-none")):(m("#divAlertFirefox").show().removeClass("d-none"),m(".firefox-only").show().removeClass("d-none"),m(".chrome-only").hide());let e=m("#cmbServerSubscriptionProtocol"),t=m("#cmbServerSubscriptionObfuscation");m("<option>").attr("value","").text(n.api.i18n.getMessage("settingsServerSubscriptionProtocolDefault")).appendTo(e),u.proxyServerProtocols.forEach((t=>{m("<option>").attr("value",t).text(t).appendTo(e)})),u.proxyServerSubscriptionObfuscate.forEach((e=>{m("<option>").attr("value",e).text(e).appendTo(t)}));let r=m("#cmbServerSubscriptionFormat");u.proxyServerSubscriptionFormat.forEach(((e,t)=>{m("<option>").attr("value",t).text(e).appendTo(r)}));let i=m("#cmbServerSubscriptionApplyProxy");u.specialRequestApplyProxyModeKeys.forEach(((e,t)=>{m("<option>").attr("value",t).text(n.api.i18n.getMessage("settingsServerSubscriptionApplyProxy_"+e)).appendTo(i)})),n.environment.chrome&&i.attr("disabled","disabled"),document.body.clientWidth<576&&s.bootstrap.Offcanvas.getOrCreateInstance(m("#tabSettingsOffCanvas")).show()}static showNewUserWelcome(){!0===f.currentSettings.firstEverInstallNotified||null!=f.currentSettings.proxyServers&&f.currentSettings.proxyServers.length>0||m("#modalWelcome").modal("show")}static hideMenuOffCanvas(){const e=s.bootstrap.Offcanvas.getInstance(m("#tabSettingsOffCanvas"));e&&e.hide()}static windowScrollToTop(e){e?setTimeout((()=>{window.scrollTo({top:0,behavior:"smooth"})}),300):window.scrollTo({top:0,behavior:"smooth"})}static populateSettingsUiData(e){let t=e.settings,r=m("#divNoServersWarning");t.proxyServers.length>0||t.proxyServerSubscriptions&&t.proxyServerSubscriptions.length>0?r.hide():r.show().removeClass("d-none"),m("#spanVersion").text("Version: "+t.version);const i=t.updateInfo;if(i&&i.updateIsAvailable){let e=n.api.i18n.getMessage("settingsTabUpdateText").replace("{0}",i.versionName);m(".menu-update-available").removeClass("d-none").attr("href",i.downloadPage).find("span").text(e)}}static populateProxyServersToComboBox(e,t,r,i,s){if(!e)return;r||(r=f.readServers()),i||(i=f.readServerSubscriptions());let o=e.val()==u.ProxyRuleSpecialProxyServer.DefaultGeneral||e.val()==u.ProxyRuleSpecialProxyServer.ProfileProxy;if(r.forEach((r=>{if(s&&r.username)return;let i=m("<option>").attr("value",r.id).text(r.name).appendTo(e),n=r.id===t;i.prop("selected",n),n&&(o=!0)})),i&&i.length>0){let r=m("<optgroup>").attr("label",n.api.i18n.getMessage("settingsActiveProxyServerSubscriptions")).appendTo(e),a=!1;for(let e of i)if(e.enabled&&e.proxies)for(let i of e.proxies){if(s&&i.username)return;let e=m("<option>").attr("value",i.id).text(i.name).appendTo(r),n=i.id===t;e.prop("selected",n),n&&(o=!0),a=!0}a||r.remove()}o||(e[0].selectedIndex=0,e.trigger("change"))}static populateServerProtocol(){let e=m("#modalModifyProxyServer"),t=f.readServerModel(e);"SOCKS5"==t.protocol?e.find("#chkServerProxyDNS-Control").show().removeClass("d-none"):e.find("#chkServerProxyDNS-Control").hide(),"SOCKS4"==t.protocol||"SOCKS5"==t.protocol&&n.environment.chrome?e.find("#chkServerProxy-Authentication").hide():e.find("#chkServerProxy-Authentication").show().removeClass("d-none")}static populateServerModal(e,t){t?(e.find("#txtServerOrder").val(t.order),e.find("#txtServerName").val(t.name),e.find("#txtServerAddress").val(t.host),e.find("#txtServerPort").val(t.port),e.find("#cmdServerProtocol").val(t.protocol),e.find("#chkServerProxyDNS").prop("checked",t.proxyDNS),e.find("#txtServerUsername").val(t.username),e.find("#txtServerPassword").val(t.password)):(e.find("#txtServerOrder").val(0),e.find("#txtServerName").val(this.generateNewServerName()),e.find("#txtServerAddress").val("127.0.0.1"),e.find("#txtServerPort").val(""),e.find("#cmdServerProtocol").val("HTTP"),e.find("#chkServerProxyDNS").prop("checked",!0),e.find("#txtServerUsername").val(""),e.find("#txtServerPassword").val("")),f.populateServerProtocol()}static readServerModel(e){let t=new u.ProxyServer;if(t.order=+e.find("#txtServerOrder").val().trim(),t.name=e.find("#txtServerName").val().trim(),t.host=e.find("#txtServerAddress").val().trim(),t.port=e.find("#txtServerPort").val(),t.protocol=e.find("#cmdServerProtocol").val(),t.username=e.find("#txtServerUsername").val().trim(),t.password=e.find("#txtServerPassword").val().trim(),t.proxyDNS=e.find("#chkServerProxyDNS").prop("checked"),0==t.order){let e=f.readServers();t.order=e.length+1}return t}static populateRuleModal(e,t,r){let i=t.find("#cmdRuleProxyServer");i.empty();let s=t.find("#cmdRuleAction");i.length&&(m("<option>").attr("value",u.ProxyRuleSpecialProxyServer.DefaultGeneral).text(n.api.i18n.getMessage("settingsRulesProxyDefault")).appendTo(i),m("<option>").attr("value",u.ProxyRuleSpecialProxyServer.ProfileProxy).text(n.api.i18n.getMessage("settingsRulesProxyFromProfile")).appendTo(i));let o=!1;if(n.environment.chrome&&(o=!0,t.find("#cmdRuleType").find(`option[value=${u.ProxyRuleType.MatchPatternUrl}],option[value=${u.ProxyRuleType.RegexUrl}],option[value=${u.ProxyRuleType.Exact}]`).remove()),r){t.find("#chkRuleGeneratePattern").prop("checked",r.autoGeneratePattern),t.find("#cmdRuleType").val(r.ruleType),t.find("#txtRuleSource").val(r.hostName),t.find("#txtRuleMatchPattern").val(r.rulePattern),t.find("#txtRuleUrlRegex").val(r.ruleRegex),t.find("#txtRuleUrlExact").val(r.ruleExact),t.find("#chkRuleEnabled").prop("checked",r.enabled),s.val(r.whiteList?"1":"0");let e=r.proxyServerId;r.proxy&&(e=r.proxy.id),i.length&&(i.val(e),f.populateProxyServersToComboBox(i,e,null,null,o))}else t.find("#chkRuleGeneratePattern").prop("checked",!0),t.find("#cmdRuleType").val(u.ProxyRuleType.DomainSubdomain),t.find("#txtRuleSource").val(""),t.find("#txtRuleMatchPattern").val(""),t.find("#txtRuleUrlRegex").val(""),t.find("#txtRuleUrlExact").val(""),t.find("#chkRuleEnabled").prop("checked",!0),s.length&&(1==e.smartProfile.profileTypeConfig.defaultRuleActionIsWhitelist?s[0].selectedIndex=1:s[0].selectedIndex=0),i.length&&f.populateProxyServersToComboBox(i,null,null,null,o);f.updateProxyRuleModal(e.htmlProfileTab)}static updateProxyRuleModal(e){e.find("#chkRuleGeneratePattern").prop("checked")?e.find("#txtRuleMatchPattern").attr("disabled","disabled"):e.find("#txtRuleMatchPattern").removeAttr("disabled");let t=e.find("#cmdRuleType").val();t==u.ProxyRuleType.MatchPatternHost||t==u.ProxyRuleType.MatchPatternUrl?(e.find("#divRuleMatchPattern").show(),e.find("#divRuleGeneratePattern").show(),e.find("#divRuleUrlRegex").hide(),e.find("#divRuleUrlExact").hide()):t==u.ProxyRuleType.RegexHost||t==u.ProxyRuleType.RegexUrl?(e.find("#divRuleMatchPattern").hide(),e.find("#divRuleGeneratePattern").hide(),e.find("#divRuleUrlRegex").show(),e.find("#divRuleUrlExact").hide()):t==u.ProxyRuleType.DomainSubdomain||t==u.ProxyRuleType.DomainExact||t==u.ProxyRuleType.DomainAndPath||t==u.ProxyRuleType.DomainSubdomainAndPath||t==u.ProxyRuleType.SearchUrl?(e.find("#divRuleMatchPattern").hide(),e.find("#divRuleGeneratePattern").hide(),e.find("#divRuleUrlRegex").hide(),e.find("#divRuleUrlExact").hide()):(e.find("#divRuleMatchPattern").hide(),e.find("#divRuleGeneratePattern").hide(),e.find("#divRuleUrlRegex").hide(),e.find("#divRuleUrlExact").show()),0!=parseInt(e.find("#cmdRuleAction").val())?e.find("#divRuleProxyServer").hide():e.find("#divRuleProxyServer").show()}static readProxyRuleModel(e){let t=e.find("#cmdRuleProxyServer").val(),r=null;t&&(r=f.findProxyServerById(t));let i=new u.ProxyRule;return i.autoGeneratePattern=e.find("#chkRuleGeneratePattern").prop("checked"),i.ruleType=parseInt(e.find("#cmdRuleType").val()),i.hostName=e.find("#txtRuleSource").val(),i.rulePattern=e.find("#txtRuleMatchPattern").val(),i.ruleRegex=e.find("#txtRuleUrlRegex").val(),i.ruleExact=e.find("#txtRuleUrlExact").val(),i.proxy=r,i.proxyServerId=t,i.enabled=e.find("#chkRuleEnabled").prop("checked"),i.whiteList=0!=parseInt(e.find("#cmdRuleAction").val()),i}static populateServerSubscriptionsModal(e,t){t?(e.find("#txtName").val(t.name),e.find("#txtUrl").val(t.url),e.find("#numRefreshRate").val(t.refreshRate),e.find("#chkServerSubscriptionEnabled").prop("checked",t.enabled),e.find("#cmbServerSubscriptionProtocol").val(t.proxyProtocol),e.find("#cmbServerSubscriptionObfuscation").val(t.obfuscation),e.find("#cmbServerSubscriptionFormat").val(t.format),e.find("#cmbServerSubscriptionApplyProxy").val(t.applyProxy??u.SpecialRequestApplyProxyMode.CurrentProxy),e.find("#cmbServerSubscriptionUsername").val(t.username),null!=t.password?e.find("#cmbServerSubscriptionPassword").val(atob(t.password)):e.find("#cmbServerSubscriptionPassword").val("")):(e.find("#txtName").val(f.generateNewSubscriptionName()),e.find("#txtUrl").val(""),e.find("#numRefreshRate").val(0),e.find("#chkServerSubscriptionEnabled").prop("checked",!0),e.find("#cmbServerSubscriptionProtocol")[0].selectedIndex=0,e.find("#cmbServerSubscriptionObfuscation")[0].selectedIndex=0,e.find("#cmbServerSubscriptionFormat")[0].selectedIndex=0,e.find("#cmbServerSubscriptionApplyProxy")[0].selectedIndex=0,e.find("#cmbServerSubscriptionUsername").val(""),e.find("#cmbServerSubscriptionPassword").val(""))}static readServerSubscriptionModel(e){let t=new u.ProxyServerSubscription;return t.name=e.find("#txtName").val(),t.url=e.find("#txtUrl").val(),t.enabled=e.find("#chkServerSubscriptionEnabled").prop("checked"),t.proxyProtocol=e.find("#cmbServerSubscriptionProtocol").val(),t.refreshRate=+(e.find("#numRefreshRate").val()||0),t.obfuscation=e.find("#cmbServerSubscriptionObfuscation").val(),t.format=+e.find("#cmbServerSubscriptionFormat").val(),t.applyProxy=+e.find("#cmbServerSubscriptionApplyProxy").val(),t.username=e.find("#cmbServerSubscriptionUsername").val(),t.password=btoa(e.find("#cmbServerSubscriptionPassword").val()),t.totalCount=0,t}static populateRulesSubscriptionsModal(e,t,r){r?(t.find("#txtName").val(r.name),t.find("#txtUrl").val(r.url),t.find("#numRefreshRate").val(r.refreshRate),t.find("#chkRulesSubscriptionEnabled").prop("checked",r.enabled),t.find("#cmbRulesSubscriptionObfuscation").val(r.obfuscation),t.find("#cmbRulesSubscriptionFormat").val(r.format),t.find("#cmbRulesSubscriptionApplyProxy").val(r.applyProxy??u.SpecialRequestApplyProxyMode.CurrentProxy),t.find("#cmbRulesSubscriptionUsername").val(r.username),null!=r.password?t.find("#cmbRulesSubscriptionPassword").val(atob(r.password)):t.find("#cmbRulesSubscriptionPassword").val("")):(t.find("#txtName").val(f.generateNewRulesSubscriptionName(e)),t.find("#txtUrl").val(""),t.find("#numRefreshRate").val(0),t.find("#chkRulesSubscriptionEnabled").prop("checked",!0),t.find("#cmbRulesSubscriptionObfuscation")[0].selectedIndex=-1,t.find("#cmbRulesSubscriptionFormat")[0].selectedIndex=-1,t.find("#cmbRulesSubscriptionApplyProxy")[0].selectedIndex=0,t.find("#cmbRulesSubscriptionUsername").val(""),t.find("#cmbRulesSubscriptionPassword").val(""))}static readRulesSubscriptionModel(e){let t=new u.ProxyRulesSubscription;return t.name=e.find("#txtName").val(),t.url=e.find("#txtUrl").val(),t.enabled=e.find("#chkRulesSubscriptionEnabled").prop("checked"),t.refreshRate=+(e.find("#numRefreshRate").val()||0),t.obfuscation=e.find("#cmbRulesSubscriptionObfuscation").val(),t.format=+e.find("#cmbRulesSubscriptionFormat").val(),t.applyProxy=+e.find("#cmbRulesSubscriptionApplyProxy").val(),t.username=e.find("#cmbRulesSubscriptionUsername").val(),t.password=btoa(e.find("#cmbRulesSubscriptionPassword").val()),t.totalCount=0,t}static enableGridMultipleDelete(e,t){t?m(e).removeAttr("disabled"):m(e).attr("disabled",!0)}static initializeAboutTab(){let e=m("#settingAboutPlaceHolder");function t(t){e.html(t),e.data("loaded",!0),m("#linkAddonsMarket").text(n.environment.browserConfig.marketName).attr("href",n.environment.browserConfig.marketUrl||"#")}e.data("loaded")||function e(r=!1,s){let o=`${s||n.api.i18n.getMessage("languageCode")}/settings-about.html`,a=i.PolyFill.extensionGetURL(`_locales/${o}`);fetch(a).then((e=>e.text())).then((e=>{t(e)})).catch((i=>{r?e(!1,"en"):t("Failed to load about...!"),c.Debug.warn("Failed to load "+o,i)}))}(!0)}static loadGeneralOptions(e){if(!e)return;let t=m("#tab-general");t.find("#chkProxyPerOrigin").prop("checked",e.proxyPerOrigin||!1),e.activeIncognitoProfileId&&this.populateIncognitoProfileDropDown(e.activeIncognitoProfileId),t.find("#cmbGeneralIncognitoProfile").val(e.activeIncognitoProfileId||""),t.find("#chkSyncSettings").prop("checked",e.syncSettings||!1),t.find("#chkSyncProxyMode").prop("checked",e.syncActiveProfile||!1),t.find("#chkSyncActiveProxy").prop("checked",e.syncActiveProxy||!1),t.find("#chkDetectRequestFailures").prop("checked",e.detectRequestFailures||!1),t.find("#chkDisplayFailedOnBadge").prop("checked",e.displayFailedOnBadge||!1),t.find("#chkEnableShortcuts").prop("checked",e.enableShortcuts||!1),t.find("#chkShortcutNotification").prop("checked",e.shortcutNotification||!1),t.find("#chkDisplayAppliedProxyOnBadge").prop("checked",e.displayAppliedProxyOnBadge||!1),t.find("#chkDisplayMatchedRuleOnBadge").prop("checked",e.displayMatchedRuleOnBadge||!1),t.find("#chkRefreshTabOnConfigChanges").prop("checked",e.refreshTabOnConfigChanges||!1),t.find("#rbtnThemesAutoSwitchBySystem").prop("checked",e.themeType==u.ThemeType.Auto),t.find("#rbtnThemesLight").prop("checked",e.themeType==u.ThemeType.Light),t.find("#rbtnThemesDark").prop("checked",e.themeType==u.ThemeType.Dark),t.find("#cmbThemesLight").val(e.themesLight),t.find("#txtThemesLightCustomUrl").val(e.themesLightCustomUrl),t.find("#cmbThemesDark").val(e.themesDark),t.find("#txtThemesDarkCustomUrl").val(e.themesDarkCustomUrl),f.uiEvents.onSyncSettingsChanged(),f.uiEvents.onChangeThemesLight(),f.uiEvents.onChangeThemesDark(),n.environment.chrome&&(t.find("#chkProxyPerOrigin").attr("disabled","disabled").parents("label").attr("disabled","disabled"),t.find("#cmbGeneralIncognitoProfile").attr("disabled","disabled").parents("label").attr("disabled","disabled"))}static readGeneralOptions(e){e||(e=new u.GeneralOptions);let t=m("#tab-general");return e.proxyPerOrigin=t.find("#chkProxyPerOrigin").prop("checked"),e.activeIncognitoProfileId=t.find("#cmbGeneralIncognitoProfile").val(),e.syncSettings=t.find("#chkSyncSettings").prop("checked"),e.syncActiveProfile=t.find("#chkSyncProxyMode").prop("checked"),e.syncActiveProxy=t.find("#chkSyncActiveProxy").prop("checked"),e.detectRequestFailures=t.find("#chkDetectRequestFailures").prop("checked"),e.displayFailedOnBadge=t.find("#chkDisplayFailedOnBadge").prop("checked"),e.enableShortcuts=t.find("#chkEnableShortcuts").prop("checked"),e.shortcutNotification=t.find("#chkShortcutNotification").prop("checked"),e.displayAppliedProxyOnBadge=t.find("#chkDisplayAppliedProxyOnBadge").prop("checked"),e.displayMatchedRuleOnBadge=t.find("#chkDisplayMatchedRuleOnBadge").prop("checked"),e.refreshTabOnConfigChanges=t.find("#chkRefreshTabOnConfigChanges").prop("checked"),t.find("#rbtnThemesLight").prop("checked")?e.themeType=u.ThemeType.Light:t.find("#rbtnThemesDark").prop("checked")?e.themeType=u.ThemeType.Dark:e.themeType=u.ThemeType.Auto,e.themesLight=t.find("#cmbThemesLight").val(),e.themesLightCustomUrl=t.find("#txtThemesLightCustomUrl").val(),e.themesDark=t.find("#cmbThemesDark").val(),e.themesDarkCustomUrl=t.find("#txtThemesDarkCustomUrl").val(),e}static populateIncognitoProfileDropDown(e){const t=m("#cmbGeneralIncognitoProfile"),r=e||t.val();t.empty(),m("<option>").attr("value","").text(n.api.i18n.getMessage("settingsGeneralIncognitoProfileDisabled")).appendTo(t);for(const e of f.pageSmartProfiles){const r=e.smartProfile;m("<option>").attr("value",r.profileId).text(r.profileName).appendTo(t)}t.val(r)}static loadServersGrid(e){this.grdServers&&(this.grdServers.clear(),this.grdServers.rows.add(e).draw("full-hold"),this.refreshServersGridAllRows())}static loadDefaultProxyServer(e,t){let r=this.currentSettings.defaultProxyServerId,i=m("#cmbActiveProxyServer");i.children().remove(),this.populateProxyServersToComboBox(i,r,e,t)}static readServers(){return this.grdServers.data().toArray()}static readSelectedServer(e){let t;if(e&&e.target){let r=m(e.target).parents("tr");r.hasClass("child")?(this.grdServers.rows().deselect(),t=this.grdServers.row(r.prev("tr.parent")).select().data()):t=this.grdServers.row(r).data()}else t=this.grdServers.row({selected:!0}).data();return t}static readSelectedServerRow(e){if(e&&e.target){let t=m(e.target).parents("tr");return t.hasClass("child")?this.grdServers.row({selected:!0}):this.grdServers.row(t)}return null}static refreshServersGrid(){let e=this.grdServers.row(".selected");e&&e.data()?f.refreshServersGridRow(e,!0):(this.grdServers.rows().invalidate(),f.refreshServersGridAllRows()),this.grdServers.draw("full-hold")}static refreshServersGridRow(e,t){if(!e)return;t&&e.invalidate();let r=m(e.node());r.find("#btnServersRemove").on("click",f.uiEvents.onServersRemoveClick),r.find("#btnServersEdit").on("click",f.uiEvents.onServersEditClick)}static refreshServersGridRowElement(e,t){e&&((e=m(e)).find("#btnServersRemove").on("click",f.uiEvents.onServersRemoveClick),e.find("#btnServersEdit").on("click",f.uiEvents.onServersEditClick))}static refreshServersGridAllRows(){var e=this.grdServers.rows().nodes();for(let t=0;t<e.length;t++){const r=m(e[t]);r.find("#btnServersRemove").on("click",f.uiEvents.onServersRemoveClick),r.find("#btnServersEdit").on("click",f.uiEvents.onServersEditClick)}}static insertNewServerInGrid(e){try{let t=this.grdServers.row.add(e).draw("full-hold");f.refreshServersGridRow(t)}catch(e){throw i.PolyFill.runtimeSendMessage("insertNewServerInGrid failed! > "+e),e}}static findProxyServerById(e){let t=f.readServers().find((t=>t.id===e));if(void 0!==t)return t;let r=f.readServerSubscriptions();for(let i of r)if(t=i.proxies.find((t=>t.id===e)),void 0!==t)return t;return null}static exportServersListFormatted(){let e=f.readServers(),t="[SmartProxy Servers]\r\n";for(let r of e){let e=`${r.host}:${r.port} [${r.protocol}]`;r.username?e+=` [${r.name}] [${r.username}] [${r.password}]`:r.name!=`${r.host}:${r.port}`&&(e+=` [${r.name}]`),t+=e+"\r\n"}return t}static readSmartProfile(e){let t=e.smartProfile,r=e.htmlProfileTab,i=new u.SmartProfile;d.ProfileOperations.copySmartProfileBase(t,i),i.profileName=r.find("#txtSmartProfileName").val(),i.profileProxyServerId=r.find("#cmbProfileProxyServer").val(),i.proxyRules=this.readRules(e),i.rulesSubscriptions=this.readRulesSubscriptions(e);let s=r.find("#chkSmartProfileEnabled");return s.length&&(i.enabled=s.prop("checked")),i}static loadSmartProfiles(e){m(".menu-smart-profile").hide();let t=m("#tab-smart-profile").hide(),r=m(".menu-add-smart-profile"),i=t;for(const t of e){if(!t.profileTypeConfig.editable)continue;t.rulesSubscriptions=t.rulesSubscriptions||[],t.proxyRules=t.proxyRules||[];let e=this.createProfileContainer(t,!1,!0),s=e.htmlProfileMenu,n=e.htmlProfileTab,o=s.insertBefore(r);e.htmlProfileMenu=o,i.after(n),i=n,this.pageSmartProfiles.push(e)}}static removePageSmartProfile(e){e.modalAddMultipleRules.remove(),e.modalAddMultipleRules=null,e.modalImportRules.remove(),e.modalImportRules=null,e.modalModifyRule.remove(),e.modalModifyRule=null,e.modalRulesSubscription.remove(),e.modalRulesSubscription=null,e.htmlProfileMenu.remove(),e.htmlProfileMenu=null,e.htmlProfileTab.remove(),e.htmlProfileTab=null,e.grdRules=null,e.grdRulesSubscriptions=null}static removePageProfileAndReset(e){let t=e.htmlProfileMenu.prev();this.removePageSmartProfile(e),t.tab("show")}static removeUnsavedProfileAndReload(e,t){this.removePageSmartProfile(e),f.changeTracking.newSmartProfile=!1;let r=this.createProfileContainer(t,!1,!0);this.pageSmartProfiles.push(r);let i=r.htmlProfileMenu,s=r.htmlProfileTab,n=m("#tab-smart-profile"),o=m(".menu-add-smart-profile");n.after(s),o.before(i),i.tab("show"),f.loadProfileProxyServer(r)}static createNewUnsavedProfile(e){let t=new u.SmartProfile;return t.profileType=e,t.profileTypeConfig=(0,u.getUserSmartProfileTypeConfig)(e),t.profileName="",this.createProfileContainerAttached(t,!0,!1)}static createProfileContainerAttached(e,t=!1,r=!0){let i=this.createProfileContainer(e,t,r),s=i.htmlProfileMenu,n=i.htmlProfileTab,o=m("#tab-smart-profile"),a=m(".menu-add-smart-profile");return o.after(n),a.before(s),f.updateProfileGridsLayout(i),i}static createProfileContainer(e,t=!1,r=!0){let i=new u.SettingsPageSmartProfile;i.smartProfile=e;let s=this.createProfileTab(e,t),n=s.tabId,o=s.profileTab;i.modalModifyRule=o.find("#modalModifyRule").hide(),i.modalAddMultipleRules=o.find("#modalAddMultipleRules").hide(),i.modalRulesSubscription=o.find("#modalRulesSubscription").hide(),i.modalImportRules=o.find("#modalImportRules").hide(),i.htmlProfileTab=o;let a=this.createProfileMenu(e,n,t);return i.htmlProfileMenu=a,this.initializeSmartProfileGrids(i),this.bindSmartProfileEvents(i),this.initializeSmartProfileUi(i),this.loadRulesSubscriptions(i,e.rulesSubscriptions),this.loadRules(i,e.proxyRules),t?this.loadProfileProxyServer(i):this.loadProfileProxyServer(i,[],[]),r&&a.show().removeClass("d-none"),o.css("display",""),i}static createProfileMenu(e,t,r=!1){let i=m(".menu-smart-profile"),s="menu-smart-profile-"+o.Utils.getNewUniqueIdNumber();r&&(s+="-new");let n=i.first().clone();return n.find("#menu-smart-profile-name").text(e.profileName),n.find(".icon").addClass((0,u.getSmartProfileTypeIcon)(e.profileType)),n.attr("id",s),n.attr("href","#"+t),n.addClass("nav-smart-profile-item"),n.click((()=>{f.hideMenuOffCanvas(),f.windowScrollToTop(!0)})),n}static createProfileTab(e,t=!1){let r=m("#tab-smart-profile"),i="tab-smart-profile-"+o.Utils.getNewUniqueIdNumber();t&&(i+="-new");let s=r.clone();return s.attr("id",i),s.addClass("tab-smart-profile-item"),t&&s.addClass("tab-new-unsaved-smart-profile-item"),s.find("#lblProfileName").html(e.profileName+' <i class="fas fa-pencil-alt fa-xs"></i>'),s.find("#txtSmartProfileName").val(e.profileName),s.find("#lblProfileType").text((0,u.getSmartProfileTypeName)(e.profileType)),s.find("#lblProfileTypeIcon").addClass((0,u.getSmartProfileTypeIcon)(e.profileType)),s.find(".label-profile-type-description").hide(),s.find(`.label-profile-type-description-for-${u.SmartProfileType[e.profileType]}`).show(),s.find("#chkSmartProfileEnabled").prop("checked",e.enabled),t&&this.showProfileNameEdit(s),(t||e.profileTypeConfig.builtin)&&s.find("#btnDeleteSmartProfile").remove(),e.profileTypeConfig.canBeDisabled||s.find("#divSmartProfileEnabled").remove(),e.profileTypeConfig.supportsProfileProxy||s.find("#divProfileProxyServer").remove(),e.profileTypeConfig.supportsSubscriptions||s.find("#divSmartProfileSubscription").remove(),e.profileTypeConfig.customProxyPerRule||s.find("#divRuleProxyServer").remove(),{profileTab:s,tabId:i}}static updateProfileGridsLayout(e){e.grdRules.columns.adjust().draw(),e.grdRulesSubscriptions.columns.adjust().draw()}static showProfileTab(e){let t=e.htmlProfileTab,r=e.htmlProfileMenu;m("#tabSettingsContent").find(".tab-pane").removeClass("active show"),t.css("display",""),r.tab("show")}static showProfileNameEdit(e){e.find("#lblProfileName").hide(),e.find("#txtSmartProfileName").addClass("d-inline").removeClass("d-none").focus().select()}static selectAddNewProfileMenu(){m(".menu-add-smart-profile").first().tab("show")}static updateProfileMenuName(e){e.htmlProfileMenu.find("#menu-smart-profile-name").text(e.smartProfile.profileName)}static loadProfileProxyServer(e,t,r){let i=e.smartProfile.profileProxyServerId,s=e.htmlProfileTab.find("#cmbProfileProxyServer");s.length&&(s.children().remove(),m("<option>").attr("value","").text(n.api.i18n.getMessage("settingsProfilesProxyServer")).appendTo(s),this.populateProxyServersToComboBox(s,i,t,r))}static loadAllProfilesProxyServers(){for(const e of f.pageSmartProfiles)f.loadProfileProxyServer(e)}static initializeSmartProfileGrids(e){let t='<t><"row"<"col-sm-12 col-md-5"<"text-left float-left"f>><"col-sm-12 col-md-7"<"text-right"l>>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',r=e.htmlProfileTab,i=[{name:"ruleType",data:"ruleTypeName",title:n.api.i18n.getMessage("settingsRulesGridColRuleType"),responsivePriority:3},{name:"hostName",data:"hostName",title:n.api.i18n.getMessage("settingsRulesGridColSource"),responsivePriority:1},{name:"rule",data:"rule",title:n.api.i18n.getMessage("settingsRulesGridColRule")},{name:"enabled",data:"enabled",title:n.api.i18n.getMessage("settingsRulesGridColEnabled"),render:function(e,t,r){return r&&r.whiteList?`${e} <i class="far fa-hand-paper" title="${n.api.i18n.getMessage("settingsRuleActionWhitelist")}"></i>`:e}},{name:"proxy",data:"proxyName",title:n.api.i18n.getMessage("settingsRulesGridColProxy"),defaultContent:n.api.i18n.getMessage("settingsRulesProxyDefault")},{width:"60px",data:null,className:"text-nowrap",defaultContent:`<button class='btn btn-sm btn-success' id='btnRulesEdit'>${n.api.i18n.getMessage("settingsEditButton")}</button> <button class='btn btn-sm btn-danger' id='btnRulesRemove'><i class='fas fa-times'></button>`,responsivePriority:2}];if(!e.smartProfile.profileTypeConfig.customProxyPerRule){let e=i.findIndex((e=>"proxy"==e.name));i.splice(e,1)}let s=r.find("#grdRules").DataTable({dom:t,paging:!0,select:{style:"os"},scrollY:460,scrollCollapse:!0,responsive:!0,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],ordering:!1,columns:i});s.on("responsive-display",(function(t,r,i,s,n){let o=i.child();s&&o&&o.length&&f.refreshRulesGridRowElement(e,o[0])})),s.on("select deselect",(()=>{this.uiEvents.onRowSelectionChanged(e.grdRules,r.find("#btnRemoveMultipleProxyRule"))})),s.draw(),new m.fn.dataTable.Responsive(s),m.fn.dataTable.select.init(s);let o=r.find("#grdRulesSubscriptions").DataTable({dom:t,paging:!0,select:{style:"os"},scrollY:460,scrollCollapse:!0,responsive:!0,lengthMenu:[[10,25,50,-1],[10,25,50,"All"]],ordering:!1,columns:[{name:"name",data:"name",title:n.api.i18n.getMessage("settingsRulesSubscriptionsGridColName"),responsivePriority:1},{name:"url",data:"url",className:"text-break-word",title:n.api.i18n.getMessage("settingsRulesSubscriptionsGridColUrl"),responsivePriority:3,render:(e,t,r)=>{let i=r.url,s=r.stats;if(s){let e=u.SubscriptionStats.ToString(s);r.stats.lastStatus?i+=` <div id='btnRuleSubscriptionsViewStats' title='${e}' class='cursor-pointer float-end'><i class="fas fa-check-circle text-success"></i></div> `:i+=` <div id='btnRuleSubscriptionsViewStats' title='${e}' class='cursor-pointer float-end'><i class="fas fa-exclamation-triangle text-danger"></i></div> `}return i}},{name:"totalCount",data:"totalCount",type:"num",title:n.api.i18n.getMessage("settingsRulesSubscriptionsGridColCount")},{name:"enabled",data:"enabled",title:n.api.i18n.getMessage("settingsRulesSubscriptionsGridColEnabled")},{width:"100px",data:null,className:"text-nowrap",defaultContent:`<button class='btn btn-sm btn-success' id='btnRuleSubscriptionsEdit'>${n.api.i18n.getMessage("settingsEditButton")}</button> <button class='btn btn-sm btn-info' id='btnRuleSubscriptionsRefresh'><i class='fas fa-sync'></i></button> <button class='btn btn-sm btn-danger' id='btnRuleSubscriptionsRemove'><i class='fas fa-times'></button>`,responsivePriority:2}]});o.on("responsive-display",(function(t,r,i,s,n){let o=i.child();s&&o&&o.length&&f.refreshRulesSubscriptionsGridRowElement(e,o[0])})),o.on("select deselect",(()=>{this.uiEvents.onRowSelectionChanged(e.grdRulesSubscriptions,r.find("#btnRemoveMultipleRulesSubscription"))})),o.draw(),r.find("#grdRulesSubscriptions").length&&m.fn.dataTable.select.init(o),e.grdRules=s,e.grdRulesSubscriptions=o}static initializeSmartProfileUi(e){let t=e.htmlProfileTab;n.environment.chrome?(t.find("#divAlertChrome").show().removeClass("d-none"),t.find(".firefox-only").hide(),t.find(".chrome-only").show().removeClass("d-none"),n.environment.manifestV3&&t.find(".chrome-mv3-only").show().removeClass("d-none")):(t.find("#divAlertFirefox").show().removeClass("d-none"),t.find(".firefox-only").show().removeClass("d-none"),t.find(".chrome-only").hide());let r=t.find("#cmbRulesSubscriptionObfuscation");u.proxyServerSubscriptionObfuscate.forEach((e=>{m("<option>").attr("value",e).text(e).appendTo(r)}));let i=t.find("#cmbRulesSubscriptionApplyProxy");u.specialRequestApplyProxyModeKeys.forEach(((e,t)=>{m("<option>").attr("value",t).text(n.api.i18n.getMessage("settingsServerSubscriptionApplyProxy_"+e)).appendTo(i)})),n.environment.chrome&&i.attr("disabled","disabled")}static bindSmartProfileEvents(e){let t=e.htmlProfileMenu,r=e.htmlProfileTab;r.find("#lblProfileName").click((()=>f.uiEvents.onProfileNameClick(e))),r.find("#cmdRuleType").change((()=>f.uiEvents.onChangeRuleType(e))),r.find("#cmdRuleAction").change((()=>f.uiEvents.onChangeRuleAction(e))),r.find("#chkRuleGeneratePattern").change((()=>f.uiEvents.onChangeRuleGeneratePattern(e))),r.find("#btnSubmitRule").click((()=>f.uiEvents.onClickSubmitProxyRule(e))),r.find("#btnAddProxyRule").click((()=>f.uiEvents.onClickAddProxyRule(e))),r.find("#btnImportRulesOpen").click((()=>f.uiEvents.onClickImportRulesOpenDialog(e))),r.find("#btnImportRules").click((()=>f.uiEvents.onClickImportRules(e))),r.find("#btnAddMultipleProxyRule").click((()=>f.uiEvents.onClickAddMultipleProxyRule(e))),r.find("#btnRemoveMultipleProxyRule").click((()=>f.uiEvents.onClickRemoveMultipleProxyRule(e))),r.find("#btnSubmitMultipleRule").click((()=>f.uiEvents.onClickSubmitMultipleRule(e))),r.find("#btnClearProxyRules").click((()=>f.uiEvents.onClickClearProxyRules(e))),r.find("#btnAddRulesSubscription").click((()=>f.uiEvents.onClickAddRulesSubscription(e))),r.find("#btnRemoveMultipleRulesSubscription").click((()=>f.uiEvents.onClickRemoveMultipleRulesSubscription(e))),r.find("#btnSaveRulesSubscriptions").click((()=>f.uiEvents.onClickSaveRulesSubscription(e))),r.find("#btnTestRulesSubscriptions").click((()=>f.uiEvents.onClickTestRulesSubscription(e))),r.find("#btnClearRulesSubscriptions").click((()=>f.uiEvents.onClickClearRulesSubscriptions(e))),r.find("#btnSaveSmartProfile").click((()=>f.uiEvents.onClickSaveSmartProfile(e))),r.find("#btnRejectSmartProfile").click((()=>f.uiEvents.onClickRejectSmartProfile(e))),r.find("#btnDeleteSmartProfile").click((()=>f.uiEvents.onClickDeleteSmartProfile(e))),e.grdRules.columns.adjust().draw(),e.grdRulesSubscriptions.columns.adjust().draw(),t.on("shown.bs.tab",(t=>{f.updateProfileGridsLayout(e)})),r.find("#txtSmartProfileName").on("input",(()=>{f.changeTracking.smartProfiles=!0})),r.find("#chkSmartProfileEnabled").on("change",(()=>{f.changeTracking.smartProfiles=!0})),r.find("#cmbProfileProxyServer").on("change",(e=>{e.originalEvent&&e.originalEvent.isTrusted&&(f.changeTracking.smartProfiles=!0)}))}static loadRules(e,t){if(!e.grdRules)return;e.grdRules.clear();let r=u.ProxyRule.assignArray(t);e.grdRules.rows.add(r).draw("full-hold"),this.refreshRulesGridAllRows(e)}static readRules(e){return e.grdRules.data().toArray()}static readSelectedRule(e,t){let r;if(t&&t.target){let i=m(t.target).parents("tr");i.hasClass("child")?(e.grdRules.rows().deselect(),r=e.grdRules.row(i.prev("tr.parent")).select().data()):r=e.grdRules.row(i).data()}else r=e.grdRules.row({selected:!0}).data();return r}static readSelectedRuleRow(e,t){if(t&&t.target){let r=m(t.target).parents("tr");return r.hasClass("child")?e.grdRules.row({selected:!0}):e.grdRules.row(r)}return null}static refreshRulesGrid(e){let t=e.grdRules.row(".selected");t&&t.data()?f.refreshRulesGridRow(e,t,!0):(e.grdRules.rows().invalidate(),f.refreshRulesGridAllRows(e)),e.grdRules.draw("full-hold")}static refreshRulesGridRow(e,t,r){if(!t)return;r&&t.invalidate();let i=m(t.node());i.find("#btnRulesRemove").on("click",(t=>f.uiEvents.onRulesRemoveClick(e,t))),i.find("#btnRulesEdit").on("click",(t=>f.uiEvents.onRulesEditClick(e,t)))}static refreshRulesGridRowElement(e,t){t&&((t=m(t)).find("#btnRulesRemove").on("click",(t=>f.uiEvents.onRulesRemoveClick(e,t))),t.find("#btnRulesEdit").on("click",(t=>f.uiEvents.onRulesEditClick(e,t))))}static refreshRulesGridAllRows(e){var t=e.grdRules.rows().nodes();for(let r=0;r<t.length;r++){const i=m(t[r]);i.find("#btnRulesRemove").on("click",(t=>f.uiEvents.onRulesRemoveClick(e,t))),i.find("#btnRulesEdit").on("click",(t=>f.uiEvents.onRulesEditClick(e,t)))}}static insertNewRuleInGrid(e,t){try{let r=e.grdRules.row.add(t).draw("full-hold");f.refreshRulesGridRow(e,r)}catch(e){throw i.PolyFill.runtimeSendMessage("insertNewRuleInGrid failed! > "+e),e}}static insertNewRuleListInGrid(e,t){try{let r;for(const i of t)r=e.grdRules.row.add(i);r&&(r.draw("full-hold"),f.refreshRulesGridAllRows(e))}catch(e){throw i.PolyFill.runtimeSendMessage("insertNewRuleInGrid failed! > "+e),e}}static loadServerSubscriptionsGrid(e){this.grdServerSubscriptions&&(this.grdServerSubscriptions.clear(),this.grdServerSubscriptions.rows.add(e).draw("full-hold"),this.refreshServerSubscriptionsGridAllRows())}static readServerSubscriptions(){return this.grdServerSubscriptions.data().toArray()}static readSelectedServerSubscription(e){let t;if(e&&e.target){let r=m(e.target).parents("tr");r.hasClass("child")?(this.grdServerSubscriptions.rows().deselect(),t=this.grdServerSubscriptions.row(r.prev("tr.parent")).select().data()):t=this.grdServerSubscriptions.row(r).data()}else t=this.grdServerSubscriptions.row({selected:!0}).data();return t}static readSelectedServerSubscriptionRow(e){if(e&&e.target){let t=m(e.target).parents("tr");return t.hasClass("child")?this.grdServerSubscriptions.row({selected:!0}):this.grdServerSubscriptions.row(t)}return null}static refreshServerSubscriptionsGrid(){let e=this.grdServerSubscriptions.row(".selected");e&&e.data()?f.refreshServerSubscriptionsGridRow(e,!0):(this.grdServerSubscriptions.rows().invalidate(),f.refreshServerSubscriptionsGridAllRows()),this.grdServerSubscriptions.draw("full-hold")}static refreshServerSubscriptionsGridRow(e,t){if(!e)return;t&&e.invalidate();let r=m(e.node());r.find("#btnSubscriptionsRemove").on("click",f.uiEvents.onServerSubscriptionRemoveClick),r.find("#btnSubscriptionsEdit").on("click",f.uiEvents.onServerSubscriptionEditClick),r.find("#btnServerSubscriptionsViewStats").on("click",f.uiEvents.onServerSubscriptionViewStatsClick)}static refreshServerSubscriptionsGridRowElement(e,t){e&&((e=m(e)).find("#btnSubscriptionsRemove").on("click",f.uiEvents.onServerSubscriptionRemoveClick),e.find("#btnSubscriptionsEdit").on("click",f.uiEvents.onServerSubscriptionEditClick),e.find("#btnServerSubscriptionsViewStats").on("click",f.uiEvents.onServerSubscriptionViewStatsClick))}static refreshServerSubscriptionsGridAllRows(){var e=this.grdServerSubscriptions.rows().nodes();for(let t=0;t<e.length;t++){const r=m(e[t]);r.find("#btnSubscriptionsRemove").on("click",f.uiEvents.onServerSubscriptionRemoveClick),r.find("#btnSubscriptionsEdit").on("click",f.uiEvents.onServerSubscriptionEditClick),r.find("#btnServerSubscriptionsViewStats").on("click",f.uiEvents.onServerSubscriptionViewStatsClick)}}static insertNewServerSubscriptionInGrid(e){try{let t=this.grdServerSubscriptions.row.add(e).draw("full-hold");f.refreshServerSubscriptionsGridRow(t)}catch(e){throw i.PolyFill.runtimeSendMessage("insertNewServerSubscriptionInGrid failed! > "+e),e}}static loadRulesSubscriptions(e,t){e.grdRulesSubscriptions&&(e.grdRulesSubscriptions.clear(),e.grdRulesSubscriptions.rows.add(t).draw("full-hold"),this.refreshRulesSubscriptionsGridAllRows(e))}static readRulesSubscriptions(e){return e.grdRulesSubscriptions.data().toArray()}static readSelectedRulesSubscription(e,t){let r;if(t&&t.target){let i=m(t.target).parents("tr");i.hasClass("child")?(e.grdRulesSubscriptions.rows().deselect(),r=e.grdRulesSubscriptions.row(i.prev("tr.parent")).select().data()):r=e.grdRulesSubscriptions.row(i).data()}else r=e.grdRulesSubscriptions.row({selected:!0}).data();return r}static readSelectedRulesSubscriptionRow(e,t){if(t&&t.target){let r=m(t.target).parents("tr");return r.hasClass("child")?e.grdRulesSubscriptions.row({selected:!0}):e.grdRulesSubscriptions.row(r)}return null}static refreshRulesSubscriptionsGrid(e){let t=e.grdRulesSubscriptions.row(".selected");t&&t.data()?f.refreshRulesSubscriptionsGridRow(e,t,!0):(e.grdRulesSubscriptions.rows().invalidate(),f.refreshRulesSubscriptionsGridAllRows(e)),e.grdRulesSubscriptions.draw("full-hold")}static rulesSubscriptionsGridRowBindEvents(e,t){t.find("#btnRuleSubscriptionsRemove").on("click",(t=>f.uiEvents.onRulesSubscriptionRemoveClick(e,t))),t.find("#btnRuleSubscriptionsEdit").on("click",(t=>f.uiEvents.onRulesSubscriptionEditClick(e,t))),t.find("#btnRuleSubscriptionsRefresh").on("click",(t=>f.uiEvents.onRulesSubscriptionRefreshClick(e,t))),t.find("#btnRuleSubscriptionsViewStats").on("click",(t=>f.uiEvents.onRulesSubscriptionViewStatsClick(e,t)))}static refreshRulesSubscriptionsGridRow(e,t,r=!1){if(!t)return;r&&t.invalidate();let i=m(t.node());f.rulesSubscriptionsGridRowBindEvents(e,i)}static refreshRulesSubscriptionsGridRowElement(e,t,r){t&&(t=m(t),f.rulesSubscriptionsGridRowBindEvents(e,t))}static refreshRulesSubscriptionsGridAllRows(e){var t=e.grdRulesSubscriptions.rows().nodes();for(let r=0;r<t.length;r++){const i=m(t[r]);f.rulesSubscriptionsGridRowBindEvents(e,i)}}static insertNewRulesSubscriptionInGrid(e,t){try{let r=e.grdRulesSubscriptions.row.add(t).draw("full-hold");f.refreshRulesSubscriptionsGridRow(e,r)}catch(e){throw i.PolyFill.runtimeSendMessage("insertNewRulesSubscriptionInGrid failed! > "+e),e}}static generateNewServerName(){let e=this.readServers(),t=1,r=`Server ${t}`;if(e&&e.length>0){let i;t=e.length+1,r=`Server ${t}`;do{i=!1;for(let s=e.length-1;s>=0;s--)if(e[s].name===r){i=!0,t++,r=`Server ${t}`;break}}while(i)}return r}static generateNewSubscriptionName(){let e=f.readServerSubscriptions(),t=1,r=`Subscription ${t}`;if(e&&e.length>0){let i;t=e.length+1,r=`Subscription ${t}`;do{i=!1;for(let s=e.length-1;s>=0;s--)if(e[s].name===r){i=!0,t++,r=`Subscription ${t}`;break}}while(i)}return r}static generateNewRulesSubscriptionName(e){let t=f.readRulesSubscriptions(e),r=1,i=`Rules Sub ${r}`;if(t&&t.length>0){let e;r=t.length+1,i=`Rules Sub ${r}`;do{e=!1;for(let s=t.length-1;s>=0;s--)if(t[s].name===i){e=!0,r++,i=`Rules Sub ${r}`;break}}while(e)}return i}}f.localized=!1,f.settingsLoaded=!1,f.pageSmartProfiles=[],f.debugDiagnosticsRequested=!1,f.changeTracking={options:!1,smartProfiles:!1,newSmartProfile:!1,servers:!1,activeProxy:!1,serverSubscriptions:!1,rulesSubscriptions:!1,isDirty:function(){return this.options||this.servers||this.activeProxy||this.smartProfiles||this.newSmartProfile||this.rulesSubscriptions||this.serverSubscriptions},resetStats:function(){this.options=!1,this.servers=!1,this.activeProxy=!1,this.smartProfiles=!1,this.newSmartProfile=!1,this.rulesSubscriptions=!1,this.serverSubscriptions=!1}},f.uiEvents={onClickMenuOffCanvas(){f.hideMenuOffCanvas(),f.windowScrollToTop(!0)},onClickSkipWelcome(){i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageSkipWelcome})},onGeneralIncognitoProfileFocus(){f.populateIncognitoProfileDropDown()},onClickSaveGeneralOptions(){let e=f.readGeneralOptions();if(e.themesLight==u.themesCustomType){if(!o.Utils.isValidUrl(e.themesLightCustomUrl))return void s.messageBox.error(n.api.i18n.getMessage("settingsGeneralThemesLight_ErrorValidUrl"));if(!o.Utils.isUrlHttps(e.themesLightCustomUrl))return void s.messageBox.error(n.api.i18n.getMessage("settingsGeneralThemesLight_ErrorValidUrl"))}if(e.themesDark==u.themesCustomType){if(!o.Utils.isValidUrl(e.themesDarkCustomUrl))return void s.messageBox.error(n.api.i18n.getMessage("settingsGeneralThemesDark_ErrorValidUrl"));if(!o.Utils.isUrlHttps(e.themesDarkCustomUrl))return void s.messageBox.error(n.api.i18n.getMessage("settingsGeneralThemesDark_ErrorValidUrl"))}i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageSaveOptions,options:e},(t=>{t&&(t.success?(t.message&&s.messageBox.success(t.message),f.currentSettings.options=e,f.changeTracking.options=!1):t.message&&s.messageBox.error(t.message))}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsErrorFailedToSaveGeneral")+" "+e.message)}))},onClickRejectGeneralOptions(){f.currentSettings.options=s.jQuery.extend({},f.originalSettings.options),f.loadGeneralOptions(f.currentSettings.options),f.changeTracking.options=!1,s.messageBox.info(n.api.i18n.getMessage("settingsChangesReverted"))},onSyncSettingsChanged(){m("#chkSyncSettings").prop("checked")?(m("#chkSyncProxyMode").removeAttr("disabled"),m("#chkSyncActiveProxy").removeAttr("disabled")):(m("#chkSyncProxyMode").attr("disabled","disabled"),m("#chkSyncActiveProxy").attr("disabled","disabled"))},onClickIgnoreRequestFailuresForDomains(){let e=f.currentSettings,t=f.pageSmartProfiles.find((e=>e.smartProfile.profileType==u.SmartProfileType.IgnoreFailureRules));if(t)f.showProfileTab(t);else{let r=e.proxyProfiles.find((e=>e.profileType==u.SmartProfileType.IgnoreFailureRules));r?(t=f.createProfileContainerAttached(r,!1,!1),f.pageSmartProfiles.push(t),f.showProfileTab(t)):(r=new u.SmartProfile,r.profileType=u.SmartProfileType.IgnoreFailureRules,r.profileTypeConfig=(0,u.getSmartProfileTypeConfig)(u.SmartProfileType.IgnoreFailureRules),r.profileName="Ignore Failure Rules",e.proxyProfiles.push(r),d.ProfileOperations.addUpdateProfile(r),t=f.createProfileContainerAttached(r,!1,!1),f.pageSmartProfiles.push(t),f.showProfileTab(t))}},onClickViewShortcuts(){if(n.environment.notSupported.keyboardShortcuts)return void s.messageBox.info("Keyboard shortcuts are not supported on mobile devices.");let e=m("#modalShortcuts");return i.PolyFill.browserCommandsGetAll((t=>{let r="<dl>";for(const e of t)r+=`<dt>${e.description}</dt><dd>${n.api.i18n.getMessage("settingsGeneralViewShortcutKeys")} : <span class='text-primary'>${e.shortcut}</span></dd>`;r+="</dl>",e.find(".modal-body").html(r),e.modal("show")})),!1},onChangeThemesLight(){m("#cmbThemesLight").val()==u.themesCustomType?m("#divThemesLightCustom").removeClass("d-none"):m("#divThemesLightCustom").addClass("d-none")},onChangeThemesDark(){m("#cmbThemesDark").val()==u.themesCustomType?m("#divThemesDarkCustom").removeClass("d-none"):m("#divThemesDarkCustom").addClass("d-none")},onRowSelectionChanged(e,t){let r=e.rows({selected:!0}).data().length>1;f.enableGridMultipleDelete(t,r)},onClickAddNewSmartProfile(){m("#modalAddNewSmartProfile").find("#rbtnNewSmartProfile_SmartRules").prop("checked",!0)},onClickSubmitContinueAddingProfile(){let e,t=m("#modalAddNewSmartProfile"),r=t.find("#rbtnNewSmartProfile_SmartRules").prop("checked"),i=t.find("#rbtnNewSmartProfile_AlwaysEnabled").prop("checked");if(r)e=u.SmartProfileType.SmartRules;else{if(!i)return void s.messageBox.error(n.api.i18n.getMessage("settingsProfilesAddErrorTypeRequired"));e=u.SmartProfileType.AlwaysEnabledBypassRules}let o=f.createNewUnsavedProfile(e);f.showProfileTab(o),f.updateProfileGridsLayout(o),f.selectAddNewProfileMenu(),f.changeTracking.newSmartProfile=!0,o.htmlProfileMenu.one("hidden.bs.tab",(()=>{f.changeTracking.newSmartProfile=!1})),t.modal("hide")},onChangeActiveProxyServer(){let e=m("#cmbActiveProxyServer").val(),t=f.findProxyServerById(e);t?(f.currentSettings.defaultProxyServerId=t.id,f.changeTracking.activeProxy=!0):c.Debug.warn("Settings> Selected ActiveProxyServer ID not found!")},onClickAddProxyServer(){let e=m("#modalModifyProxyServer");e.data("editing",null),f.populateServerModal(e,null),e.modal("show"),e.find("#txtServerAddress").focus()},onClickRemoveMultipleProxyServer(){var e=f.grdServers.rows({selected:!0});e&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveMultipleProxyServer"),(()=>{e.remove().draw("full-hold"),f.changeTracking.servers=!0,f.loadDefaultProxyServer(),f.enableGridMultipleDelete(m("#btnRemoveMultipleProxyServer"),!1)}))},onChangeServerProtocol(){f.populateServerProtocol()},onClickSubmitProxyServer(){let e=m("#modalModifyProxyServer"),t=e.data("editing"),r=f.readServerModel(e);if(!r.name)return void s.messageBox.error(n.api.i18n.getMessage("settingsServerNameRequired"));let i=null;if(t&&(i=t.name),f.readServers().some((e=>e.name===r.name&&e.name!=i)))s.messageBox.error(n.api.i18n.getMessage("settingsServerNameExists"));else if(r.host)if(!r.port||r.port<=0||r.port>65535)s.messageBox.error(n.api.i18n.getMessage("settingsServerPortNoInvalid"));else if(r.username||!r.password){if(t){const e=t.id;s.jQuery.extend(t,r),t.id=e,f.refreshServersGrid()}else f.insertNewServerInGrid(r);f.changeTracking.servers=!0,e.modal("hide"),f.loadDefaultProxyServer()}else s.messageBox.error(n.api.i18n.getMessage("settingsServerAuthenticationInvalid"));else s.messageBox.error(n.api.i18n.getMessage("settingsServerServerAddressIsEmpty"))},onServersEditClick(e){let t=f.readSelectedServer(e);if(!t)return;let r=m("#modalModifyProxyServer");r.data("editing",t),f.populateServerModal(r,t),r.modal("show"),r.find("#txtServerAddress").focus()},onServersRemoveClick(e){var t=f.readSelectedServerRow(e);t&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveProxyServer"),(()=>{t.remove().draw("full-hold"),f.changeTracking.servers=!0,f.loadDefaultProxyServer()}))},onClickSaveProxyServers(){m("#cmbActiveProxyServer").trigger("change");let e={proxyServers:f.readServers(),defaultProxyServerId:f.currentSettings.defaultProxyServerId};i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageSaveProxyServers,saveData:e},(t=>{t&&(t.success?(t.message&&s.messageBox.success(t.message),f.currentSettings.proxyServers=e.proxyServers,f.currentSettings.defaultProxyServerId=e.defaultProxyServerId,f.changeTracking.servers=!1,f.changeTracking.activeProxy=!1):t.message&&s.messageBox.error(t.message))}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsErrorFailedToSaveServers")+" "+e.message)}))},onClickRejectProxyServers(){f.currentSettings.proxyServers=f.originalSettings.proxyServers.slice(),f.loadServersGrid(f.currentSettings.proxyServers),f.loadDefaultProxyServer(),f.changeTracking.servers=!1,s.messageBox.info(n.api.i18n.getMessage("settingsChangesReverted"))},onClickClearProxyServers(){s.messageBox.confirm(n.api.i18n.getMessage("settingsRemoveAllProxyServers"),(()=>{f.loadServersGrid([]),f.loadDefaultProxyServer(),f.changeTracking.servers=!0,s.messageBox.info(n.api.i18n.getMessage("settingsRemoveAllProxyServersSuccess"))}))},onClickAddMultipleProxyRule(e){let t=e.htmlProfileTab.find("#modalAddMultipleRules");t.data("editing",null),t.find("#cmdMultipleRuleType").val(0),t.find("#txtMultipleRuleList").val(""),f.populateRuleModal(e,t,null),t.modal("show"),t.find("#txtMultipleRuleList").focus()},onClickRemoveMultipleProxyRule(e){var t=e.grdRules.rows({selected:!0});t&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveMultipleProxyRule"),(()=>{t.remove().draw("full-hold"),f.changeTracking.smartProfiles=!0,f.enableGridMultipleDelete(e.htmlProfileTab.find("#btnRemoveMultipleProxyRule"),!1)}))},onClickSubmitMultipleRule(e){let t=e.htmlProfileTab.find("#modalAddMultipleRules"),r=t.find("#cmdRuleProxyServer").val(),i=null;r&&(i=f.findProxyServerById(r));let a=0!=parseInt(t.find("#cmdRuleAction").val()),l=+t.find("#cmdMultipleRuleType").val(),c=t.find("#txtMultipleRuleList").val().split(/[\r\n]+/),d=[],p=f.readRules(e);for(let e of c){if(!e)continue;let t;e=e.trim().toLowerCase();let c=new u.ProxyRule;if(l==u.ProxyRuleType.Exact){if(!o.Utils.isValidUrl(e))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleExactUrlInvalid").replace("{0}",e));c.ruleExact=e,t=o.Utils.extractHostFromUrl(e)}else if(l==u.ProxyRuleType.MatchPatternHost){if(o.Utils.urlHasSchema(e)||(e="http://"+e),t=o.Utils.extractHostFromUrl(e),!o.Utils.isValidHost(t))return void s.messageBox.error(n.api.i18n.getMessage("settingsMultipleRuleInvalidHost").replace("{0}",t));t=o.Utils.extractHostFromUrl(e),c.rulePattern=o.Utils.hostToMatchPattern(t,!1)}else{if(l!=u.ProxyRuleType.MatchPatternUrl)continue;if(!o.Utils.isValidUrl(e))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleUrlInvalid"));t=o.Utils.extractHostFromUrl(e),c.rulePattern=o.Utils.hostToMatchPattern(e,!0)}p.some((e=>e.hostName===t))||(c.autoGeneratePattern=!0,c.enabled=!0,c.proxy=null,c.hostName=t,c.ruleType=l,c.proxy=i,c.proxyServerId=r,c.whiteList=a,d.push(c))}d.length?(f.insertNewRuleListInGrid(e,d),f.changeTracking.smartProfiles=!0,t.modal("hide")):s.messageBox.error(n.api.i18n.getMessage("settingsMultipleRuleNoNewRuleAdded"))},onClickAddProxyRule(e){let t=e.htmlProfileTab.find("#modalModifyRule");t.data("editing",null),f.populateRuleModal(e,t,null),t.modal("show"),t.find("#txtRuleSource").focus()},onClickImportRulesOpenDialog(e){let t=e.htmlProfileTab.find("#modalImportRules");t.data("editing",null),t.modal("show"),t.find("#txtRuleSource").focus(),function(){var e=t.find("#rbtnImportRulesSelect_File"),r=t.find("#rbtnImportRulesSelect_Text");e.prop("checked")||r.prop("checked")||e.prop("checked",!0),t.find("#txtImportRulesSelectText").val("");let i=t.find("#cmbImportRulesOverride_Append"),s=t.find("#cmbImportRulesOverride_Replace");i.prop("checked")||s.prop("checked")||i.prop("checked",!0)}()},onClickImportRules(e){let t,r,i=e.htmlProfileTab.find("#modalImportRules"),o=i.find("#btnImportRulesSelectFile")[0];if(i.find("#rbtnImportRulesSelect_File").prop("checked")){if(0==o.files.length)return void s.messageBox.error(n.api.i18n.getMessage("settingsRulesFileNotSelected"));t=o.files[0]}else{let e=i.find("#txtImportRulesSelectText").val().trim();if(""==e)return void s.messageBox.error(n.api.i18n.getMessage("settingsImportRulesTextIsEmpty"));r=e}let a=i.find("#cmbImportRulesOverride_Append").prop("checked"),c=+i.find("#cmbImportRulesFormat").val(),d=f.readRules(e),p=new u.ProxyRulesImportFromUI;p.format=c,c==u.ExternalRulesFormat.AutoProxy||c==u.ExternalRulesFormat.SwitchyOmega?l.RuleImporter.importRulesBatch(p,r,t,a,d,(t=>{t&&(t.success?(t.message&&s.messageBox.success(t.message),o.value="",function(t){let r,i=t.blackList.map((e=>e.getProxyRule())),s=t.whiteList.map((e=>{let t=e.getProxyRule();return t.whiteList=!0,t}));r=a?d.concat(i).concat(s):i.concat(s),f.loadRules(e,r)}(t.rules),i.modal("hide")):t.message&&s.messageBox.error(t.message))}),(e=>{let t="";e&&e.message&&(t=e.message),s.messageBox.error(n.api.i18n.getMessage("settingsImportRulesFailed")+" "+t)})):s.messageBox.warning(n.api.i18n.getMessage("settingsSourceTypeNotSelected"))},onChangeRuleGeneratePattern(e){f.updateProxyRuleModal(e.htmlProfileTab)},onChangeRuleType(e){f.updateProxyRuleModal(e.htmlProfileTab)},onChangeRuleAction(e){f.updateProxyRuleModal(e.htmlProfileTab)},onClickSubmitProxyRule(e){let t=e.htmlProfileTab.find("#modalModifyRule"),r=t.data("editing"),i=f.readProxyRuleModel(t),a=i.hostName;function l(){return!!a||(s.messageBox.error(n.api.i18n.getMessage("settingsRuleSourceRequired")),!1)}if(a){if(!o.Utils.isValidHost(a))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleSourceInvalid"));let e=a;o.Utils.urlHasSchema(a)||(e="http://"+a);let t=o.Utils.extractHostFromUrl(e);if(null==t||!o.Utils.isValidHost(t))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleHostInvalid").replace("{0}",t||a));a=t}if(i.hostName=a,i.ruleType==u.ProxyRuleType.MatchPatternHost){if(i.autoGeneratePattern){if(!l())return;i.rulePattern=o.Utils.hostToMatchPattern(a,!1)}else if(a&&!i.rulePattern.includes(a))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleDoesntIncludeDomain").replace("{0}",a))}else if(i.ruleType==u.ProxyRuleType.MatchPatternUrl){if(i.autoGeneratePattern){if(!l())return;i.rulePattern=o.Utils.hostToMatchPattern(a,!0)}else if(a&&!i.rulePattern.includes(a))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleDoesntIncludeDomain").replace("{0}",a))}else if(i.ruleType==u.ProxyRuleType.RegexHost)try{if(!i.ruleRegex)return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleRegexInvalid").replace("{0}",i.ruleRegex));let e=new RegExp(i.ruleRegex);if(a&&!e.test(a))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleRegexNotMatchDomain").replace("{0}",a))}catch(e){return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleRegexInvalid").replace("{0}",i.ruleRegex))}else if(i.ruleType==u.ProxyRuleType.RegexUrl)try{if(!i.ruleRegex)return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleRegexInvalid").replace("{0}",i.ruleRegex));let e=new RegExp(i.ruleRegex);if(a&&!e.test(a))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleRegexNotMatchDomain").replace("{0}",a))}catch(e){return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleRegexInvalid").replace("{0}",i.ruleRegex))}else if(i.ruleType==u.ProxyRuleType.DomainSubdomain||i.ruleType==u.ProxyRuleType.DomainSubdomainAndPath||i.ruleType==u.ProxyRuleType.DomainAndPath||i.ruleType==u.ProxyRuleType.DomainExact||i.ruleType==u.ProxyRuleType.SearchUrl){if(!l())return;i.ruleSearch=a}else if(!o.Utils.isValidUrl(i.ruleExact))return void s.messageBox.error(n.api.i18n.getMessage("settingsRuleExactUrlInvalid").replace("{0}",i.ruleExact));let c=null;r&&(c=r.hostName);let d=f.readRules(e),p=!1;if(a&&(p=d.some((e=>e.hostName===a&&e.hostName!=c))),p)s.messageBox.error(n.api.i18n.getMessage("settingsRuleSourceAlreadyExists"));else{if(!r)do{p=d.some((e=>e.ruleId===i.ruleId)),p&&(i.ruleId=o.Utils.getNewUniqueIdNumber())}while(p);r?(s.jQuery.extend(r,i),f.refreshRulesGrid(e)):f.insertNewRuleInGrid(e,i),f.changeTracking.smartProfiles=!0,t.modal("hide")}},onRulesEditClick(e,t){let r=f.readSelectedRule(e,t);if(!r)return;let i=e.htmlProfileTab.find("#modalModifyRule");i.data("editing",r),f.populateRuleModal(e,i,r),i.modal("show"),i.find("#txtRuleSource").focus()},onRulesRemoveClick(e,t){var r=f.readSelectedRuleRow(e,t);r&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveProxyRule"),(()=>{r.remove().draw("full-hold"),f.changeTracking.smartProfiles=!0}))},onClickClearProxyRules(e){s.messageBox.confirm(n.api.i18n.getMessage("settingsRemoveAllRules"),(()=>{f.loadRules(e,[]),f.changeTracking.smartProfiles=!0,s.messageBox.info(n.api.i18n.getMessage("settingsRemoveAllRulesSuccess"))}))},onProfileNameClick(e){let t=e.htmlProfileTab;f.showProfileNameEdit(t)},onClickSaveSmartProfile(e){let t=f.readSmartProfile(e),r=e.smartProfile;Object.assign(r,t),""!=r.profileName.trim()?null==f.currentSettings.proxyProfiles.find((e=>e.profileName==r.profileName&&e.profileId!=r.profileId))?i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageSaveSmartProfile,smartProfile:r},(t=>{if(t)if(t.success){t.message&&s.messageBox.success(t.message);let i=t.smartProfile||r;f.changeTracking.smartProfiles=!1,f.changeTracking.rulesSubscriptions=!1,r.profileId||r.profileType==u.SmartProfileType.IgnoreFailureRules?f.updateProfileMenuName(e):(f.currentSettings.proxyProfiles.push(i),f.removeUnsavedProfileAndReload(e,i))}else t.message&&s.messageBox.error(t.message)}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsErrorFailedToSaveSmartProfile")+" "+e.message)})):s.messageBox.error(n.api.i18n.getMessage("settingsProfilesAddErrorNameExists")):s.messageBox.error(n.api.i18n.getMessage("settingsProfilesAddErrorNameRequired"))},saveUnsavedSmartProfile(){let e=m(".tab-smart-profile-item.tab-new-unsaved-smart-profile-item:visible");e.length&&e.find("#btnSaveSmartProfile").trigger("click")},onClickRejectSmartProfile(e){},onClickDeleteSmartProfile(e){let t=e.smartProfile;t.profileId&&(t.profileTypeConfig.builtin||s.messageBox.confirm(n.api.i18n.getMessage("settingsProfilesDeleteConfirm"),(()=>{i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageDeleteSmartProfile,smartProfileId:t.profileId},(t=>{t&&(t.success?(t.message&&s.messageBox.success(t.message),f.removePageProfileAndReset(e)):t.message&&s.messageBox.error(t.message))}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsProfilesDeleteFailed")+" "+e.message)}))})))},onClickAddServerSubscription(){let e=m("#modalServerSubscription");e.data("editing",null),f.populateServerSubscriptionsModal(e,null),e.modal("show"),e.on("shown.bs.modal",(function t(){e.off("shown.bs.modal",t),e.find("#txtUrl").focus()}))},onClickRemoveMultipleServerSubscription(){var e=f.grdServerSubscriptions.rows({selected:!0});e&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveMultipleServerSubscription"),(()=>{e.remove().draw("full-hold"),f.changeTracking.serverSubscriptions=!0,f.enableGridMultipleDelete(m("#btnRemoveMultipleServerSubscription"),!1)}))},onServerSubscriptionEditClick(e){let t=f.readSelectedServerSubscription(e);if(!t)return;let r=m("#modalServerSubscription");r.data("editing",t),f.populateServerSubscriptionsModal(r,t),r.modal("show")},onServerSubscriptionRemoveClick(e){var t=f.readSelectedServerSubscriptionRow(e);t&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveServerSubscription"),(()=>{t.remove().draw("full-hold"),f.changeTracking.serverSubscriptions=!0}))},onServerSubscriptionViewStatsClick(e){let t=e.currentTarget?.title;t&&(t=t.replaceAll("\r\n","<br>").replaceAll("\n","<br>"),s.messageBox.info(t))},onClickSaveServerSubscription(){let e=m("#modalServerSubscription");if(!e.find("form")[0].checkValidity())return void s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionIncompleteForm"));let t=f.readServerSubscriptionModel(e);if(!t)return void s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionInvalidForm"));let r=f.readServerSubscriptions(),i=e.data("editing"),o="";if(i&&(o=i.name),i){let e=!1;for(let i of r)i.name==t.name&&t.name!=o&&(e=!0);if(t.name!=o&&e)return void s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionDuplicateName"))}t.stats||(t.stats=new u.SubscriptionStats),m("#btnSaveServerSubscription").attr("data-loading-text",n.api.i18n.getMessage("settingsServerSubscriptionSavingButton")),m("#btnSaveServerSubscription").button("loading"),a.ProxyImporter.readFromServer(t,(r=>{if(m("#btnSaveServerSubscription").button("reset"),r.success){let o=r.result.length;t.enabled?t.proxies=r.result:t.proxies=[],t.totalCount=o,u.SubscriptionStats.updateStats(t.stats,!0),i?(s.jQuery.extend(i,t),f.refreshServerSubscriptionsGrid(),s.messageBox.success(n.api.i18n.getMessage("settingsServerSubscriptionSaveUpdated").replace("{0}",o))):(f.insertNewServerSubscriptionInGrid(t),s.messageBox.success(n.api.i18n.getMessage("settingsServerSubscriptionSaveAdded").replace("{0}",o))),f.changeTracking.serverSubscriptions=!0,f.loadDefaultProxyServer(),e.modal("hide")}else u.SubscriptionStats.updateStats(t.stats,!1),s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionSaveFailedGet"))}),(e=>{u.SubscriptionStats.updateStats(t.stats,!1,e),s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionSaveFailedGet")),m("#btnSaveServerSubscription").button("reset")}))},onClickTestServerSubscription(){let e=m("#modalServerSubscription");if(!e.find("form")[0].checkValidity())return void s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionIncompleteForm"));let t=f.readServerSubscriptionModel(e);if(t){m("#btnTestServerSubscription").attr("data-loading-text",n.api.i18n.getMessage("settingsServerSubscriptionTestingButton")),m("#btnTestServerSubscription").button("loading");var r=t.applyProxy;t.applyProxy=null,i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageMakeRequestSpecial,url:t.url,applyProxy:r,selectedProxy:null},(e=>{e&&(e.success?(e.message&&s.messageBox.success(e.message),a.ProxyImporter.readFromServer(t,(e=>{if(m("#btnTestServerSubscription").button("reset"),e.success){let t=e.result.length;s.messageBox.success(n.api.i18n.getMessage("settingsServerSubscriptionTestSuccess").replace("{0}",t))}else s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionTestFailed"))}),(()=>{s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionTestFailed")),m("#btnTestServerSubscription").button("reset")}))):e.message&&s.messageBox.error(e.message))}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionTestFailed")),m("#btnTestServerSubscription").button("reset")}))}else s.messageBox.error(n.api.i18n.getMessage("settingsServerSubscriptionInvalidForm"))},onClickSaveServerSubscriptionsChanges(){let e=f.readServerSubscriptions();i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageSaveProxySubscriptions,proxyServerSubscriptions:e},(t=>{t&&(t.success?(t.message&&s.messageBox.success(t.message),f.currentSettings.proxyServerSubscriptions=e,f.changeTracking.serverSubscriptions=!1,f.loadDefaultProxyServer()):t.message&&s.messageBox.error(t.message))}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsFailedToSaveProxySubscriptions")+" "+e.message)}))},onClickRejectServerSubscriptionsChanges(){f.currentSettings.proxyServerSubscriptions=f.originalSettings.proxyServerSubscriptions.slice(),f.loadServerSubscriptionsGrid(f.currentSettings.proxyServerSubscriptions),f.loadDefaultProxyServer(),f.changeTracking.serverSubscriptions=!1,s.messageBox.info(n.api.i18n.getMessage("settingsChangesReverted"))},onClickClearServerSubscriptions(){s.messageBox.confirm(n.api.i18n.getMessage("settingsRemoveAllProxyServerSubscriptions"),(()=>{f.loadServerSubscriptionsGrid([]),f.loadDefaultProxyServer(),f.changeTracking.serverSubscriptions=!0,s.messageBox.info(n.api.i18n.getMessage("settingsRemoveAllProxyServerSubscriptionsSuccess"))}))},onClickAddRulesSubscription(e){let t=e.htmlProfileTab.find("#modalRulesSubscription");t.data("editing",null),f.populateRulesSubscriptionsModal(e,t,null),t.modal("show"),t.on("shown.bs.modal",(function e(){t.off("shown.bs.modal",e),t.find("#txtUrl").focus()}))},onClickRemoveMultipleRulesSubscription(e){var t=e.grdRulesSubscriptions.rows({selected:!0});t&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveMultipleRulesSubscription"),(()=>{t.remove().draw("full-hold"),f.changeTracking.rulesSubscriptions=!0,f.enableGridMultipleDelete(e.htmlProfileTab.find("#btnRemoveMultipleRulesSubscription"),!1)}))},onRulesSubscriptionEditClick(e,t){let r=f.readSelectedRulesSubscription(e,t);if(!r)return;let i=e.htmlProfileTab.find("#modalRulesSubscription");i.data("editing",r),f.populateRulesSubscriptionsModal(e,i,r),i.modal("show")},onRulesSubscriptionRemoveClick(e,t){var r=f.readSelectedRulesSubscriptionRow(e,t);r&&s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmRemoveRulesSubscription"),(()=>{r.remove().draw("full-hold"),f.changeTracking.rulesSubscriptions=!0}))},onRulesSubscriptionRefreshClick(e,t){if(!f.readSelectedRulesSubscriptionRow(e,t))return;let r=f.readSelectedRulesSubscription(e,t);r&&(r.enabled?(r.stats||(r.stats=new u.SubscriptionStats),l.RuleImporter.readFromServerAndImport(r,(t=>{if(t.success){let i=t.rules.blackList.length+t.rules.whiteList.length;r.enabled?(r.proxyRules=t.rules.blackList,r.whitelistRules=t.rules.whiteList):(r.proxyRules=[],r.whitelistRules=[]),r.totalCount=i,u.SubscriptionStats.updateStats(r.stats,!0),f.refreshRulesSubscriptionsGrid(e),s.messageBox.success(n.api.i18n.getMessage("settingsRulesSubscriptionSaveUpdated").replace("{0}",t.rules.blackList.length).replace("{1}",t.rules.whiteList.length)),f.changeTracking.rulesSubscriptions=!0}else u.SubscriptionStats.updateStats(r.stats,!1),s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionSaveFailedGet"))}),(e=>{u.SubscriptionStats.updateStats(r.stats,!1,e),s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionSaveFailedGet"))}))):s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionRefreshOnDisabled")))},onRulesSubscriptionViewStatsClick(e,t){let r=t.currentTarget?.title;r&&(r=r.replaceAll("\r\n","<br>").replaceAll("\n","<br>"),s.messageBox.info(r))},onClickSaveRulesSubscription(e){let t=e.htmlProfileTab,r=t.find("#modalRulesSubscription");if(!r.find("form")[0].checkValidity())return void s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionIncompleteForm"));let i=f.readRulesSubscriptionModel(r);if(!i)return void s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionInvalidForm"));let o=f.readRulesSubscriptions(e),a=r.data("editing"),c="";if(a&&(c=a.name,i.id=a.id),a){let e=!1;for(let t of o)t.name==i.name&&i.name!=c&&(e=!0);if(i.name!=c&&e)return void s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionDuplicateName"))}i.stats||(i.stats=new u.SubscriptionStats),t.find("#btnSaveRulesSubscriptions").attr("data-loading-text",n.api.i18n.getMessage("settingsRulesSubscriptionSavingButton")),t.find("#btnSaveRulesSubscriptions").button("loading"),l.RuleImporter.readFromServerAndImport(i,(o=>{if(t.find("#btnSaveRulesSubscriptions").button("reset"),o.success){let t=o.rules.blackList.length+o.rules.whiteList.length;i.enabled?(i.proxyRules=o.rules.blackList,i.whitelistRules=o.rules.whiteList):(i.proxyRules=[],i.whitelistRules=[]),i.totalCount=t,u.SubscriptionStats.updateStats(i.stats,!0),a?(s.jQuery.extend(a,i),f.refreshRulesSubscriptionsGrid(e),s.messageBox.success(n.api.i18n.getMessage("settingsRulesSubscriptionSaveUpdated").replace("{0}",o.rules.blackList.length).replace("{1}",o.rules.whiteList.length))):(f.insertNewRulesSubscriptionInGrid(e,i),s.messageBox.success(n.api.i18n.getMessage("settingsRulesSubscriptionSaveAdded").replace("{0}",o.rules.blackList.length).replace("{1}",o.rules.whiteList.length))),f.changeTracking.rulesSubscriptions=!0,r.modal("hide")}else u.SubscriptionStats.updateStats(i.stats,!1),s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionSaveFailedGet"))}),(e=>{u.SubscriptionStats.updateStats(i.stats,!1,e),s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionSaveFailedGet")),t.find("#btnSaveRulesSubscriptions").button("reset")}))},onClickTestRulesSubscription(e){let t=e.htmlProfileTab,r=t.find("#modalRulesSubscription");if(!r.find("form")[0].checkValidity())return void s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionIncompleteForm"));let o=f.readRulesSubscriptionModel(r);if(o){t.find("#btnTestRulesSubscriptions").attr("data-loading-text",n.api.i18n.getMessage("settingsRulesSubscriptionTestingButton")),t.find("#btnTestRulesSubscriptions").button("loading");var a=o.applyProxy;o.applyProxy=null,i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageMakeRequestSpecial,url:o.url,applyProxy:a,selectedProxy:null},(e=>{e&&(e.success?(e.message&&s.messageBox.success(e.message),l.RuleImporter.readFromServerAndImport(o,(e=>{t.find("#btnTestRulesSubscriptions").button("reset"),e.success?s.messageBox.success(n.api.i18n.getMessage("settingsRulesSubscriptionTestSuccess").replace("{0}",e.rules.blackList.length).replace("{1}",e.rules.whiteList.length)):s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionTestFailed"))}),(()=>{s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionTestFailed")),t.find("#btnTestRulesSubscriptions").button("reset")}))):e.message&&s.messageBox.error(e.message))}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionTestFailed")),t.find("#btnTestRulesSubscriptions").button("reset")}))}else s.messageBox.error(n.api.i18n.getMessage("settingsRulesSubscriptionInvalidForm"))},onClickClearRulesSubscriptions(e){s.messageBox.confirm(n.api.i18n.getMessage("settingsRemoveAllProxyRulesSubscriptions"),(()=>{f.loadRulesSubscriptions(e,[]),f.changeTracking.rulesSubscriptions=!0,s.messageBox.info(n.api.i18n.getMessage("settingsRemoveAllProxyRulesSubscriptionsSuccess"))}))},onClickExportProxyServerOpenBackup(){let e=f.exportServersListFormatted();t.CommonUi.downloadData(e,"SmartProxy-Servers.txt")},onClickImportProxyServer(){let e,t,r=m("#modalImportProxyServer");if(r.find("#rbtnImportProxyServer_File").prop("checked")){let t=r.find("#btnImportProxyServerSelectFile")[0];if(0==t.files.length)return void s.messageBox.error(n.api.i18n.getMessage("settingsImportProxiesFileNotSelected"));e=t.files[0]}else{let e=r.find("#btnImportProxyServerListText").val().trim();if(""==e)return void s.messageBox.error(n.api.i18n.getMessage("settingsImportProxyListTextIsEmpty"));t=e}let i=r.find("#cmbImportProxyServerOverride_Append").prop("checked"),o=f.readServers();a.ProxyImporter.importText(t,e,i,o,(e=>{if(e)if(e.success){e.message&&s.messageBox.info(e.message),r.find("#btnImportProxyServerSelectFile")[0].value="",r.find("#btnImportProxyServerListText").val("");let t=e.result;f.loadServersGrid(t),f.loadDefaultProxyServer(),f.changeTracking.servers=!0,r.modal("hide")}else e.message&&s.messageBox.error(e.message)}),(e=>{let t="";e&&e.message&&(t=e.message),s.messageBox.error(n.api.i18n.getMessage("settingsImportProxyServersFailed")+" "+t)}))},onClickFactoryReset(){s.messageBox.confirm(n.api.i18n.getMessage("settingsFactoryResetConfirm"),(()=>{i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageFactoryReset},(e=>{e.success?(m(window).off("beforeunload"),e.message?s.messageBox.success(e.message,800,(()=>{f.changeTracking.resetStats(),document.location.reload()})):(f.changeTracking.resetStats(),document.location.reload())):e.message&&s.messageBox.error(e.message)}))}))},onClickBackupComplete(){let e=p.SettingsOperation.getBackupOfSettings(f.currentSettings),r=JSON.stringify(e);t.CommonUi.downloadData(r,"SmartProxy-FullBackup.json")},onClickRestoreBackup(){t.CommonUi.selectFileOnTheFly(m("#frmRestoreBackup")[0],"restore-file",((e,t)=>{let r=t[0],o=new FileReader;o.onerror=e=>{s.messageBox.error(n.api.i18n.getMessage("settingsRestoreBackupFileError"))},o.onload=e=>{var t;t=o.result,i.PolyFill.runtimeSendMessage({command:u.CommandMessages.SettingsPageRestoreSettings,fileData:t},(e=>{e.success?(m(window).off("beforeunload"),e.message?s.messageBox.success(e.message,500,(()=>{f.changeTracking.resetStats(),document.location.reload()})):(f.changeTracking.resetStats(),document.location.reload())):e.message&&s.messageBox.error(e.message)}),(e=>{s.messageBox.error(n.api.i18n.getMessage("settingsRestoreBackupFailed")),i.PolyFill.runtimeSendMessage("restoreSettings failed with> "+e.message)}))},o.readAsText(r)}),"application/json")},onClickEnableDiagnostics(){f.debugDiagnosticsRequested?i.PolyFill.runtimeSendMessage({command:u.CommandMessages.DebugGetDiagnosticsLogs},(e=>{const r=`smartproxy-diag-${(new Date).toISOString().replaceAll(":","-").replaceAll(".","-")}.json`;t.CommonUi.downloadData(e,r)})):confirm("Are you sure to enable diagnostics?")&&(f.debugDiagnosticsRequested=!0,i.PolyFill.runtimeSendMessage({command:u.CommandMessages.DebugEnableDiagnostics}),alert("Diagnostics are enabled for this session only. Check this page for more info."),window.open("https://github.com/salarcode/SmartProxy/wiki/Enable-Diagnostics"))},onWindowUnload(e){f.readGeneralOptions().Equals(f.currentSettings.options)||(f.changeTracking.options=!0),f.changeTracking.isDirty()&&(m(window).one("focus",(()=>{setTimeout((()=>{s.messageBox.confirm(n.api.i18n.getMessage("settingsConfirmSaveAllChanged"),(()=>{if(f.changeTracking.options&&f.uiEvents.onClickSaveGeneralOptions(),f.changeTracking.smartProfiles||f.changeTracking.rulesSubscriptions)for(let e of f.pageSmartProfiles)f.uiEvents.onClickSaveSmartProfile(e);f.uiEvents.saveUnsavedSmartProfile(),(f.changeTracking.servers||f.changeTracking.activeProxy)&&f.uiEvents.onClickSaveProxyServers(),f.changeTracking.serverSubscriptions&&f.uiEvents.onClickSaveServerSubscriptionsChanges()}))}),200)})),e.preventDefault(),e.returnValue=!0)}},f.initialize()})(),(()=>{"use strict";r.r(i);var e=r("./src/lib/environment.ts");e.environment.browserConfig={name:"Chrome",marketName:"Chrome Web Store",marketUrl:"https://chrome.google.com/webstore/detail/smartproxy/jogcnplbkgkfdakgdenhlpcfhjioidoj"},e.environment.manifestV3=!0})()})();